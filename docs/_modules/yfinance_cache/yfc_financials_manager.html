<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>yfinance_cache.yfc_financials_manager &mdash; yfinance-cache 0.6.6 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=e059a73d"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            yfinance-cache
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">yfinance_cache</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">yfinance-cache</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">yfinance_cache.yfc_financials_manager</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for yfinance_cache.yfc_financials_manager</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">yfc_dat</span> <span class="k">as</span> <span class="n">yfcd</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">yfc_cache_manager</span> <span class="k">as</span> <span class="n">yfcm</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">yfc_utils</span> <span class="k">as</span> <span class="n">yfcu</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">stats</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">dateutil.relativedelta</span> <span class="kn">import</span> <span class="n">relativedelta</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">statistics</span> <span class="kn">import</span> <span class="n">mean</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">decimal</span> <span class="kn">import</span> <span class="n">Decimal</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>


<span class="n">d_today</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
<span class="n">yf_spam_window</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
<span class="c1"># give Yahoo time to update their financials</span>
<span class="n">yf_min_grace_days_period</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">yf_max_grace_days_period</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">28</span><span class="p">)</span>
<span class="n">company_release_delay</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>


<span class="n">print_fetches</span> <span class="o">=</span> <span class="kc">False</span>
<span class="c1"># print_fetches = True</span>


<div class="viewcode-block" id="sort_estimates">
<a class="viewcode-back" href="../../yfinance_cache.html#yfinance_cache.yfc_financials_manager.sort_estimates">[docs]</a>
<span class="k">def</span> <span class="nf">sort_estimates</span><span class="p">(</span><span class="n">lst</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">lst</span>

    <span class="n">pivot_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">pivot</span> <span class="o">=</span> <span class="n">lst</span><span class="p">[</span><span class="n">pivot_index</span><span class="p">]</span>

    <span class="n">less</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">greater</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lst</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">pivot_index</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">less_than</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">pivot</span>
        <span class="k">except</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">AmbiguousComparisonException</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s2">&quot;prob_lt&quot;</span><span class="p">):</span>
                <span class="n">less_than</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">prob_lt</span><span class="p">(</span><span class="n">pivot</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.5</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">less_than</span> <span class="o">=</span> <span class="n">pivot</span><span class="o">.</span><span class="n">prob_gt</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.5</span>
        <span class="k">if</span> <span class="n">less_than</span><span class="p">:</span>
            <span class="n">less</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">greater</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sort_estimates</span><span class="p">(</span><span class="n">less</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">pivot</span><span class="p">]</span> <span class="o">+</span> <span class="n">sort_estimates</span><span class="p">(</span><span class="n">greater</span><span class="p">)</span></div>



<div class="viewcode-block" id="EarningsRelease">
<a class="viewcode-back" href="../../yfinance_cache.html#yfinance_cache.yfc_financials_manager.EarningsRelease">[docs]</a>
<span class="k">class</span> <span class="nc">EarningsRelease</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="n">period_end</span><span class="p">,</span> <span class="n">release_date</span><span class="p">,</span> <span class="n">full_year_end</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">period_end</span><span class="p">,</span> <span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">DateEstimate</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;&#39;period_end&#39; must be a &#39;yfcd.DateEstimate&#39; or date object or None, not </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">period_end</span><span class="p">)))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">release_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">release_date</span><span class="p">,</span> <span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">DateEstimate</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;&#39;release_date&#39; must be a &#39;yfcd.DateEstimate&#39; or date object or None, not </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">release_date</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">release_date</span> <span class="o">&lt;</span> <span class="n">period_end</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;release_date=</span><span class="si">{0}</span><span class="s2"> cannot occur before period_end=</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">release_date</span><span class="p">,</span> <span class="n">period_end</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">release_date</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">period_end</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">90</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;release_date=</span><span class="si">{0}</span><span class="s2"> shouldn&#39;t occur 90 days after period_end=</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">release_date</span><span class="p">,</span> <span class="n">period_end</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">full_year_end</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;&#39;full_year_end&#39; must be a date object or None, not </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">full_year_end</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="n">interval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period_end</span> <span class="o">=</span> <span class="n">period_end</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">release_date</span> <span class="o">=</span> <span class="n">release_date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_year_end</span> <span class="o">=</span> <span class="n">full_year_end</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="si">}</span><span class="s1"> earnings&#39;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; ending </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">period_end</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot; released&quot;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot; ?&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">release_date</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">release_date</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">period_end</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">period_end</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">period_end</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">period_end</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">release_date</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">release_date</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__le__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span> <span class="o">==</span> <span class="n">other</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span> <span class="o">&lt;</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">period_end</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">period_end</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">release_date</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">release_date</span>

    <span class="k">def</span> <span class="fm">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">period_end</span> <span class="o">&gt;</span> <span class="n">other</span><span class="o">.</span><span class="n">period_end</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">period_end</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">period_end</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">release_date</span> <span class="o">&gt;</span> <span class="n">other</span><span class="o">.</span><span class="n">release_date</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__ge__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span> <span class="o">==</span> <span class="n">other</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span> <span class="o">&gt;</span> <span class="n">other</span><span class="p">)</span>

<div class="viewcode-block" id="EarningsRelease.is_end_of_year">
<a class="viewcode-back" href="../../yfinance_cache.html#yfinance_cache.yfc_financials_manager.EarningsRelease.is_end_of_year">[docs]</a>
    <span class="k">def</span> <span class="nf">is_end_of_year</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">r_is_end_of_year</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">rpe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">period_end</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">rpe</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_year_end</span><span class="p">)</span>
        <span class="n">diff</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">365</span><span class="p">)</span>  <span class="c1"># just in case is negative</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">diff</span> <span class="o">%</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">365</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&gt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=-</span><span class="mi">15</span><span class="p">)</span> <span class="ow">and</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">15</span><span class="p">))</span> <span class="ow">or</span>\
                <span class="p">(</span><span class="n">diff</span> <span class="o">&gt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">350</span><span class="p">)</span> <span class="ow">and</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">370</span><span class="p">)):</span>
                <span class="c1"># Aligns with annual release date</span>
                <span class="n">r_is_end_of_year</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">AmbiguousComparisonException</span><span class="p">:</span>
            <span class="n">r_is_end_of_year</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">r_is_end_of_year</span></div>
</div>



<span class="n">interval_str_to_days</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">interval_str_to_days</span><span class="p">[</span><span class="s1">&#39;ANNUAL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">ComparableRelativedelta</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">interval_str_to_days</span><span class="p">[</span><span class="s1">&#39;HALF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">ComparableRelativedelta</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="n">interval_str_to_days</span><span class="p">[</span><span class="s1">&#39;QUART&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">ComparableRelativedelta</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>


<div class="viewcode-block" id="FinancialsManager">
<a class="viewcode-back" href="../../yfinance_cache.html#yfinance_cache.yfc_financials_manager.FinancialsManager">[docs]</a>
<span class="k">class</span> <span class="nc">FinancialsManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">tzName</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckStr</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;ticker&quot;</span><span class="p">)</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckStr</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="s2">&quot;exchange&quot;</span><span class="p">)</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckStr</span><span class="p">(</span><span class="n">tzName</span><span class="p">,</span> <span class="s2">&quot;tzName&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">ticker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tzName</span> <span class="o">=</span> <span class="n">tzName</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dat</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>

        <span class="c1"># self._earnings = None</span>
        <span class="c1"># self._quarterly_earnings = None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_income_stmt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_quarterly_income_stmt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_balance_sheet</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_quarterly_balance_sheet</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cashflow</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_quarterly_cashflow</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_earnings_dates</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calendar</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calendar_clean</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pruned_tbl_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fin_tbl_cache</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="FinancialsManager.get_income_stmt">
<a class="viewcode-back" href="../../yfinance_cache.html#yfinance_cache.yfc_financials_manager.FinancialsManager.get_income_stmt">[docs]</a>
    <span class="k">def</span> <span class="nf">get_income_stmt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_income_stmt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_income_stmt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_income_stmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fin_table</span><span class="p">(</span><span class="n">yfcd</span><span class="o">.</span><span class="n">Financials</span><span class="o">.</span><span class="n">IncomeStmt</span><span class="p">,</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">ReportingPeriod</span><span class="o">.</span><span class="n">Full</span><span class="p">,</span> <span class="n">refresh</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_income_stmt</span></div>


<div class="viewcode-block" id="FinancialsManager.get_quarterly_income_stmt">
<a class="viewcode-back" href="../../yfinance_cache.html#yfinance_cache.yfc_financials_manager.FinancialsManager.get_quarterly_income_stmt">[docs]</a>
    <span class="k">def</span> <span class="nf">get_quarterly_income_stmt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quarterly_income_stmt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quarterly_income_stmt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_quarterly_income_stmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fin_table</span><span class="p">(</span><span class="n">yfcd</span><span class="o">.</span><span class="n">Financials</span><span class="o">.</span><span class="n">IncomeStmt</span><span class="p">,</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">ReportingPeriod</span><span class="o">.</span><span class="n">Interim</span><span class="p">,</span> <span class="n">refresh</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quarterly_income_stmt</span></div>


<div class="viewcode-block" id="FinancialsManager.get_balance_sheet">
<a class="viewcode-back" href="../../yfinance_cache.html#yfinance_cache.yfc_financials_manager.FinancialsManager.get_balance_sheet">[docs]</a>
    <span class="k">def</span> <span class="nf">get_balance_sheet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_balance_sheet</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_balance_sheet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_balance_sheet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fin_table</span><span class="p">(</span><span class="n">yfcd</span><span class="o">.</span><span class="n">Financials</span><span class="o">.</span><span class="n">BalanceSheet</span><span class="p">,</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">ReportingPeriod</span><span class="o">.</span><span class="n">Full</span><span class="p">,</span> <span class="n">refresh</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_balance_sheet</span></div>


<div class="viewcode-block" id="FinancialsManager.get_quarterly_balance_sheet">
<a class="viewcode-back" href="../../yfinance_cache.html#yfinance_cache.yfc_financials_manager.FinancialsManager.get_quarterly_balance_sheet">[docs]</a>
    <span class="k">def</span> <span class="nf">get_quarterly_balance_sheet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quarterly_balance_sheet</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quarterly_balance_sheet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_quarterly_balance_sheet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fin_table</span><span class="p">(</span><span class="n">yfcd</span><span class="o">.</span><span class="n">Financials</span><span class="o">.</span><span class="n">BalanceSheet</span><span class="p">,</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">ReportingPeriod</span><span class="o">.</span><span class="n">Interim</span><span class="p">,</span> <span class="n">refresh</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quarterly_balance_sheet</span></div>


<div class="viewcode-block" id="FinancialsManager.get_cashflow">
<a class="viewcode-back" href="../../yfinance_cache.html#yfinance_cache.yfc_financials_manager.FinancialsManager.get_cashflow">[docs]</a>
    <span class="k">def</span> <span class="nf">get_cashflow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cashflow</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cashflow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cashflow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fin_table</span><span class="p">(</span><span class="n">yfcd</span><span class="o">.</span><span class="n">Financials</span><span class="o">.</span><span class="n">CashFlow</span><span class="p">,</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">ReportingPeriod</span><span class="o">.</span><span class="n">Full</span><span class="p">,</span> <span class="n">refresh</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cashflow</span></div>


<div class="viewcode-block" id="FinancialsManager.get_quarterly_cashflow">
<a class="viewcode-back" href="../../yfinance_cache.html#yfinance_cache.yfc_financials_manager.FinancialsManager.get_quarterly_cashflow">[docs]</a>
    <span class="k">def</span> <span class="nf">get_quarterly_cashflow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quarterly_cashflow</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quarterly_cashflow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_quarterly_cashflow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fin_table</span><span class="p">(</span><span class="n">yfcd</span><span class="o">.</span><span class="n">Financials</span><span class="o">.</span><span class="n">CashFlow</span><span class="p">,</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">ReportingPeriod</span><span class="o">.</span><span class="n">Interim</span><span class="p">,</span> <span class="n">refresh</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quarterly_cashflow</span></div>


    <span class="k">def</span> <span class="nf">_get_fin_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">finType</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># debug = True</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_get_fin_table(</span><span class="si">{</span><span class="n">finType</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s2">, refresh=</span><span class="si">{</span><span class="n">refresh</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">finType</span><span class="p">,</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Financials</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Argument finType must be type Financials&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">ReportingPeriod</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Argument period must be type ReportingPeriod&#39;</span><span class="p">)</span>

        <span class="n">cache_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">finType</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">refresh</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cache_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fin_tbl_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fin_tbl_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">refresh</span><span class="p">:</span>
            <span class="n">cache_key2</span> <span class="o">=</span> <span class="p">(</span><span class="n">finType</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cache_key2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fin_tbl_cache</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fin_tbl_cache</span><span class="p">[</span><span class="n">cache_key2</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">period</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">ReportingPeriod</span><span class="o">.</span><span class="n">Interim</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;quarterly_&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">finType</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Financials</span><span class="o">.</span><span class="n">IncomeStmt</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">+=</span> <span class="s1">&#39;income_stmt&#39;</span>
        <span class="k">elif</span> <span class="n">finType</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Financials</span><span class="o">.</span><span class="n">BalanceSheet</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">+=</span> <span class="s1">&#39;balance_sheet&#39;</span>
        <span class="k">elif</span> <span class="n">finType</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Financials</span><span class="o">.</span><span class="n">CashFlow</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">+=</span> <span class="s1">&#39;cashflow&#39;</span>

        <span class="n">df</span><span class="p">,</span> <span class="n">md</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">yfcm</span><span class="o">.</span><span class="n">IsDatumCached</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="n">df</span><span class="p">,</span> <span class="n">md</span> <span class="o">=</span> <span class="n">yfcm</span><span class="o">.</span><span class="n">ReadCacheDatum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">mod_dt</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">md</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">md</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Fix metadata</span>
                <span class="n">fp</span> <span class="o">=</span> <span class="n">yfcm</span><span class="o">.</span><span class="n">GetFilepath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="n">mod_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span><span class="o">.</span><span class="n">astimezone</span><span class="p">()</span>
                <span class="n">md</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;FetchDates&#39;</span><span class="p">:{}}</span>
                <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">md</span><span class="p">[</span><span class="s1">&#39;FetchDates&#39;</span><span class="p">][</span><span class="n">dt</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod_dt</span>
                <span class="n">yfcm</span><span class="o">.</span><span class="n">WriteCacheMetadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;FetchDates&#39;</span><span class="p">,</span> <span class="n">md</span><span class="p">[</span><span class="s1">&#39;FetchDates&#39;</span><span class="p">])</span>
                <span class="n">md</span><span class="p">[</span><span class="s1">&#39;LastFetch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod_dt</span>
                <span class="n">yfcm</span><span class="o">.</span><span class="n">WriteCacheMetadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;LastFetch&#39;</span><span class="p">,</span> <span class="n">md</span><span class="p">[</span><span class="s1">&#39;LastFetch&#39;</span><span class="p">])</span>
            <span class="k">elif</span> <span class="s1">&#39;FetchDates&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">md</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mod_dt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">fp</span> <span class="o">=</span> <span class="n">yfcm</span><span class="o">.</span><span class="n">GetFilepath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                    <span class="n">mod_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span><span class="o">.</span><span class="n">astimezone</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">md</span><span class="p">[</span><span class="s1">&#39;FetchDates&#39;</span><span class="p">][</span><span class="n">dt</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod_dt</span>
                <span class="n">yfcm</span><span class="o">.</span><span class="n">WriteCacheMetadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;FetchDates&#39;</span><span class="p">,</span> <span class="n">md</span><span class="p">[</span><span class="s1">&#39;FetchDates&#39;</span><span class="p">])</span>
            <span class="k">elif</span> <span class="s1">&#39;LastFetch&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">md</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mod_dt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">fp</span> <span class="o">=</span> <span class="n">yfcm</span><span class="o">.</span><span class="n">GetFilepath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                    <span class="n">mod_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span><span class="o">.</span><span class="n">astimezone</span><span class="p">()</span>
                <span class="n">md</span><span class="p">[</span><span class="s1">&#39;LastFetch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod_dt</span>
                <span class="n">yfcm</span><span class="o">.</span><span class="n">WriteCacheMetadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;LastFetch&#39;</span><span class="p">,</span> <span class="n">md</span><span class="p">[</span><span class="s1">&#39;LastFetch&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">md</span><span class="p">[</span><span class="s1">&#39;LastFetch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">md</span><span class="p">[</span><span class="s1">&#39;LastFetch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">md</span><span class="p">[</span><span class="s1">&#39;LastFetch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astimezone</span><span class="p">()</span>
                <span class="n">yfcm</span><span class="o">.</span><span class="n">WriteCacheMetadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;LastFetch&#39;</span><span class="p">,</span> <span class="n">md</span><span class="p">[</span><span class="s1">&#39;LastFetch&#39;</span><span class="p">])</span>

        <span class="n">do_fetch</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">do_fetch</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">refresh</span><span class="p">:</span>
            <span class="n">dt_now</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tzName</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="c1"># Nothing to estimate releases on, so just periodically check</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">age</span> <span class="o">=</span> <span class="n">dt_now</span> <span class="o">-</span> <span class="n">md</span><span class="p">[</span><span class="s2">&quot;LastFetch&quot;</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">md</span><span class="p">)</span>
                    <span class="k">raise</span>
                <span class="k">if</span> <span class="n">age</span> <span class="o">&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
                    <span class="n">do_fetch</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">td_1d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
                <span class="n">releases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_release_dates</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- releases:&quot;</span><span class="p">)</span> <span class="p">;</span> <span class="n">pprint</span><span class="p">(</span><span class="n">releases</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">releases</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Use crude logic to estimate when to re-fetch</span>
                    <span class="k">if</span> <span class="s1">&#39;LastFetch&#39;</span> <span class="ow">in</span> <span class="n">md</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">do_fetch</span> <span class="o">=</span> <span class="n">md</span><span class="p">[</span><span class="s1">&#39;LastFetch&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">dt_now</span> <span class="o">-</span> <span class="n">td_1d</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">do_fetch</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">next_release</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="c1"># last_d = df.columns.max().date()</span>
                    <span class="c1"># Update: analyse pruned dates:</span>
                    <span class="n">last_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prune_yf_financial_df</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">releases</span><span class="p">:</span>
                        <span class="c1"># Release is newer than cache</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">period_end</span> <span class="o">&lt;=</span> <span class="n">last_d</span><span class="p">:</span>
                                <span class="k">continue</span>
                        <span class="k">except</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">AmbiguousComparisonException</span><span class="p">:</span>
                            <span class="c1"># Treat as match</span>
                            <span class="k">continue</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">fetched_long_after_release</span> <span class="o">=</span> <span class="n">md</span><span class="p">[</span><span class="s1">&#39;LastFetch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">release_date</span> <span class="o">+</span> <span class="n">yf_max_grace_days_period</span><span class="p">)</span>
                        <span class="k">except</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">AmbiguousComparisonException</span><span class="p">:</span>
                            <span class="n">fetched_long_after_release</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">fetched_long_after_release</span><span class="p">:</span>
                            <span class="n">next_release</span> <span class="o">=</span> <span class="n">r</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="n">next_release</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">pprint</span><span class="p">(</span><span class="n">releases</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- last_d =&quot;</span><span class="p">,</span> <span class="n">last_d</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Failed to determine next release after cached financials&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- last_d =&quot;</span><span class="p">,</span> <span class="n">last_d</span><span class="p">,</span> <span class="s2">&quot;, last_fetch =&quot;</span><span class="p">,</span> <span class="n">md</span><span class="p">[</span><span class="s1">&#39;LastFetch&#39;</span><span class="p">])</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- next_release:&quot;</span><span class="p">,</span> <span class="n">next_release</span><span class="p">)</span>
                    <span class="n">rd</span> <span class="o">=</span> <span class="n">next_release</span><span class="o">.</span><span class="n">release_date</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">next_release_in_future</span> <span class="o">=</span> <span class="n">rd</span> <span class="o">&gt;</span> <span class="n">d_today</span>
                    <span class="k">except</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">AmbiguousComparisonException</span><span class="p">:</span>
                        <span class="n">next_release_in_future</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- next_release_in_future =&quot;</span><span class="p">,</span> <span class="n">next_release_in_future</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">next_release_in_future</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">fair_to_expect_Yahoo_updated</span> <span class="o">=</span> <span class="p">(</span><span class="n">d_today</span><span class="o">-</span><span class="n">rd</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">yf_min_grace_days_period</span>
                        <span class="k">except</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">AmbiguousComparisonException</span><span class="p">:</span>
                            <span class="n">fair_to_expect_Yahoo_updated</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- fair_to_expect_Yahoo_updated =&quot;</span><span class="p">,</span> <span class="n">fair_to_expect_Yahoo_updated</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">fair_to_expect_Yahoo_updated</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- expect new release, but did we already fetch recently?&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">md</span><span class="p">[</span><span class="s1">&#39;LastFetch&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">dt_now</span> <span class="o">-</span> <span class="n">yf_spam_window</span><span class="p">):</span>
                                <span class="n">do_fetch</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- do_fetch =&quot;</span><span class="p">,</span> <span class="n">do_fetch</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">do_fetch</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">print_fetches</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: fetching </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">md</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; (last fetch = </span><span class="si">{</span><span class="n">md</span><span class="p">[</span><span class="s1">&#39;LastFetch&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">df_new</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dat</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">fetch_dt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tzName</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">md</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">md</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;FetchDates&#39;</span><span class="p">:{}}</span>
            <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">df_new</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">md</span><span class="p">[</span><span class="s1">&#39;FetchDates&#39;</span><span class="p">][</span><span class="n">dt</span><span class="p">]</span> <span class="o">=</span> <span class="n">fetch_dt</span>
            <span class="n">md</span><span class="p">[</span><span class="s1">&#39;LastFetch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fetch_dt</span>
            <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df_new</span>
            <span class="k">elif</span> <span class="n">df_new</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">df_new</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">df_pruned</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df_new</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">df_new_pruned</span> <span class="o">=</span> <span class="n">df_new</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df_new</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">df_pruned</span><span class="o">.</span><span class="n">empty</span> <span class="ow">and</span> <span class="n">df_new_pruned</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">next_release</span><span class="o">.</span><span class="n">release_date</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">next_release</span><span class="o">.</span><span class="n">release_date</span><span class="o">.</span><span class="n">confidence</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Confidence</span><span class="o">.</span><span class="n">Low</span><span class="p">:</span>
                        <span class="c1"># Probably not released yet</span>
                        <span class="k">pass</span>
                    <span class="c1"># else:</span>
                    <span class="c1">#     # Update: also check if a large amount of time has passed since release.</span>
                    <span class="c1">#     # Will Yahoo ever have it?</span>
                    <span class="c1">#     td_since_release = d_today - next_release.release_date</span>
                    <span class="c1">#     try:</span>
                    <span class="c1">#         Yahoo_very_late = td_since_release &gt; yf_max_grace_days_period</span>
                    <span class="c1">#     except yfcd.AmbiguousComparisonException:</span>
                    <span class="c1">#         Yahoo_very_late = False</span>
                    <span class="c1">#     if Yahoo_very_late:</span>
                    <span class="c1">#         # print(&quot;- next_release:&quot;, next_release)</span>
                    <span class="c1">#         # print(&quot;- df:&quot;, df.columns, df.shape)</span>
                    <span class="c1">#         # print(&quot;- df_new:&quot;, df_new.columns, df_new.shape)</span>
                    <span class="c1">#         # print(&quot;- metadata old:&quot;) ; pprint(md_old)</span>
                    <span class="c1">#         # print(&quot;- td_since_release:&quot;, td_since_release)</span>
                    <span class="c1">#         ok = click.confirm(f&quot;WARNING: Yahoo very late uploading newer {finType} for {self.ticker}, is this acceptable?&quot;, default=False)</span>
                    <span class="c1">#         if ok:</span>
                    <span class="c1">#             # print(f&quot;WARNING: Yahoo missing newer financials for {self.ticker}&quot;)</span>
                    <span class="c1">#             pass</span>
                    <span class="c1">#         else:</span>
                    <span class="c1">#             # print(&quot;- next_release:&quot;, next_release)</span>
                    <span class="c1">#             # print(&quot;- df:&quot;, df.columns, df.shape)</span>
                    <span class="c1">#             # print(&quot;- df_new:&quot;, df_new.columns, df_new.shape)</span>
                    <span class="c1">#             # print(&quot;- metadata old:&quot;) ; pprint(md_old)</span>
                    <span class="c1">#             raise Exception(f&#39;Why asking Yahoo for {finType} when nothing new ready?&#39;)</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">df_new</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">df_pruned</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                        <span class="n">df</span> <span class="o">=</span> <span class="n">df_new</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Before merging, check for new/missing fields. Insert any with value NaN.</span>
                        <span class="n">missing_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">df_pruned</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_new</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
                        <span class="n">new_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">df_new</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_pruned</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
                        <span class="n">actions</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">missing_keys</span><span class="p">:</span>
                            <span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="s2">&quot;missing&quot;</span><span class="p">,</span> <span class="n">df_pruned</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">new_keys</span><span class="p">:</span>
                            <span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">,</span> <span class="n">df_new</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
                        <span class="n">actions</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">actions</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
                            <span class="n">k</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;missing&#39;</span><span class="p">:</span>
                                <span class="n">empty_row</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="n">c</span><span class="p">:[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df_new</span><span class="o">.</span><span class="n">columns</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                                <span class="n">idx</span> <span class="o">=</span> <span class="n">df_pruned</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                                <span class="n">df_new</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_new</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">idx</span><span class="p">],</span> <span class="n">empty_row</span><span class="p">,</span> <span class="n">df_new</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">:]])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">empty_row</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="n">c</span><span class="p">:[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df_pruned</span><span class="o">.</span><span class="n">columns</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                                <span class="n">idx</span> <span class="o">=</span> <span class="n">df_new</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                                <span class="n">df_pruned</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_pruned</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">idx</span><span class="p">],</span> <span class="n">empty_row</span><span class="p">,</span> <span class="n">df_pruned</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">:]])</span>
                        <span class="n">df_new</span> <span class="o">=</span> <span class="n">df_new</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">df_pruned</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_new</span><span class="p">,</span> <span class="n">df_pruned</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">yfcm</span><span class="o">.</span><span class="n">StoreCacheDatum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">md</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_fin_tbl_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">_get_interval_from_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tbl</span><span class="p">):</span>
        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># debug = True</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;_get_interval_from_table()&quot;</span><span class="p">)</span>

        <span class="n">dates</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">.</span><span class="n">columns</span>

        <span class="c1"># Ensure only well-populated columns are retained, corresponding to report releases</span>
        <span class="n">tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prune_yf_financial_df</span><span class="p">(</span><span class="n">tbl</span><span class="p">)</span>
        <span class="n">tbl</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="n">tbl</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
        <span class="n">dates</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- tbl:&quot;</span><span class="p">)</span> <span class="p">;</span> <span class="nb">print</span><span class="p">(</span><span class="n">tbl</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">TimedeltaEstimate</span><span class="p">(</span><span class="n">yfcd</span><span class="o">.</span><span class="n">ComparableRelativedelta</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">6</span><span class="p">),</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Confidence</span><span class="o">.</span><span class="n">Medium</span><span class="p">)</span>

        <span class="n">interval</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">intervals</span> <span class="o">=</span> <span class="p">[(</span><span class="n">dates</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dates</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">days</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">dates</span><span class="p">))]</span>
        <span class="n">intervals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">intervals</span><span class="p">)</span>

        <span class="c1"># Cluster actual intervals</span>
        <span class="k">def</span> <span class="nf">safe_add_to_cluster</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">std_pct_threshold</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">:</span>
                <span class="n">c2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">c2</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">c2</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">std_pct_threshold</span><span class="p">:</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">def</span> <span class="nf">cluster_numbers</span><span class="p">(</span><span class="n">numbers</span><span class="p">,</span> <span class="n">std_pct</span><span class="p">):</span>
            <span class="n">clusters</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">numbers</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">clusters</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">safe_add_to_cluster</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">std_pct</span><span class="p">):</span>
                    <span class="n">clusters</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">n</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">clusters</span>
        <span class="n">clusters</span> <span class="o">=</span> <span class="n">cluster_numbers</span><span class="p">(</span><span class="n">intervals</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>

        <span class="c1"># Map clusters to legal intervals</span>
        <span class="n">tol</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">intervals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">clusters</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">m</span><span class="o">-</span><span class="mi">365</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
                <span class="n">intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yfcd</span><span class="o">.</span><span class="n">ComparableRelativedelta</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">m</span><span class="o">-</span><span class="mi">182</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
                <span class="n">intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yfcd</span><span class="o">.</span><span class="n">ComparableRelativedelta</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">6</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">m</span><span class="o">-</span><span class="mi">91</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
                <span class="n">intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yfcd</span><span class="o">.</span><span class="n">ComparableRelativedelta</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">m</span><span class="o">-</span><span class="mi">274</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
                <span class="c1"># 9 months, nonsense, but implies quarterly</span>
                <span class="n">intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yfcd</span><span class="o">.</span><span class="n">TimedeltaEstimate</span><span class="p">(</span><span class="n">yfcd</span><span class="o">.</span><span class="n">ComparableRelativedelta</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Confidence</span><span class="o">.</span><span class="n">Medium</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">clusters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intervals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># good!</span>
            <span class="k">return</span> <span class="n">intervals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Return the smallest. In case of ambiguous comparison, keep most confident.</span>
            <span class="n">best</span> <span class="o">=</span> <span class="n">intervals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">intervals</span><span class="p">)):</span>
                <span class="n">i2</span> <span class="o">=</span> <span class="n">intervals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">best</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">best</span><span class="p">,</span> <span class="n">i2</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">AmbiguousComparisonException</span><span class="p">:</span>
                    <span class="n">best_confidence</span> <span class="o">=</span> <span class="n">best</span><span class="o">.</span><span class="n">confidence</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">best</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Confidence</span><span class="o">.</span><span class="n">High</span>
                    <span class="n">i2_confidence</span> <span class="o">=</span> <span class="n">i2</span><span class="o">.</span><span class="n">confidence</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">i2</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Confidence</span><span class="o">.</span><span class="n">High</span>
                    <span class="k">if</span> <span class="n">i2_confidence</span> <span class="o">&gt;</span> <span class="n">best_confidence</span><span class="p">:</span>
                        <span class="n">best</span> <span class="o">=</span> <span class="n">i2</span>
            <span class="k">return</span> <span class="n">best</span>

    <span class="k">def</span> <span class="nf">_get_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">finType</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># debug = True</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_get_interval(</span><span class="si">{</span><span class="n">finType</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">finType</span><span class="p">,</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Financials</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Argument finType must be type Financials&#39;</span><span class="p">)</span>

        <span class="n">tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fin_table</span><span class="p">(</span><span class="n">finType</span><span class="p">,</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">ReportingPeriod</span><span class="o">.</span><span class="n">Interim</span><span class="p">,</span> <span class="n">refresh</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_interval_from_table</span><span class="p">(</span><span class="n">tbl</span><span class="p">)</span>

<div class="viewcode-block" id="FinancialsManager.get_release_dates">
<a class="viewcode-back" href="../../yfinance_cache.html#yfinance_cache.yfc_financials_manager.FinancialsManager.get_release_dates">[docs]</a>
    <span class="k">def</span> <span class="nf">get_release_dates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">as_df</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># First, check cache:</span>
        <span class="k">if</span> <span class="n">period</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">ReportingPeriod</span><span class="o">.</span><span class="n">Full</span><span class="p">:</span>
            <span class="n">cache_key</span> <span class="o">=</span> <span class="s2">&quot;full&quot;</span>
        <span class="k">elif</span> <span class="n">period</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">ReportingPeriod</span><span class="o">.</span><span class="n">Interim</span><span class="p">:</span>
            <span class="n">cache_key</span> <span class="o">=</span> <span class="s2">&quot;interim&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown period value &#39;</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="n">cache_key</span> <span class="o">+=</span> <span class="s2">&quot;-release-dates&quot;</span>
        <span class="n">releases</span><span class="p">,</span> <span class="n">md</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">yfcm</span><span class="o">.</span><span class="n">IsDatumCached</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="n">cache_key</span><span class="p">):</span>
            <span class="n">releases</span><span class="p">,</span> <span class="n">md</span> <span class="o">=</span> <span class="n">yfcm</span><span class="o">.</span><span class="n">ReadCacheDatum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="n">cache_key</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">releases</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">releases</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">max_age</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">yfcm</span><span class="o">.</span><span class="n">_option_manager</span><span class="o">.</span><span class="n">max_ages</span><span class="o">.</span><span class="n">calendar</span><span class="p">)</span>
        <span class="n">dt_now</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">d_exchange</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tzName</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">releases</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">md</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">do_calc</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">do_calc</span> <span class="o">=</span> <span class="n">md</span><span class="p">[</span><span class="s1">&#39;CalcDate&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">dt_now</span> <span class="o">-</span> <span class="n">max_age</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">do_calc</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Check if cached release dates need a recalc</span>
            <span class="k">if</span> <span class="n">md</span><span class="p">[</span><span class="s1">&#39;CalcDate&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">dt_now</span> <span class="o">-</span> <span class="n">max_age</span><span class="p">):</span>
                <span class="n">prev_r</span><span class="p">,</span> <span class="n">next_r</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">releases</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">r0</span> <span class="o">=</span> <span class="n">releases</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">r1</span> <span class="o">=</span> <span class="n">releases</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">r_is_history</span> <span class="o">=</span> <span class="n">r0</span><span class="o">.</span><span class="n">release_date</span> <span class="o">&lt;</span> <span class="n">d_exchange</span>
                    <span class="k">except</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">AmbiguousComparisonException</span><span class="p">:</span>
                        <span class="n">r_is_history</span> <span class="o">=</span> <span class="n">r0</span><span class="o">.</span><span class="n">release_date</span><span class="o">.</span><span class="n">prob_lt</span><span class="p">(</span><span class="n">d_exchange</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.9</span>
                    <span class="k">if</span> <span class="n">r_is_history</span><span class="p">:</span>
                        <span class="n">prev_r</span> <span class="o">=</span> <span class="n">r0</span>
                        <span class="n">next_r</span> <span class="o">=</span> <span class="n">r1</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">prev_r</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">):</span>
                    <span class="n">do_calc</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">next_r</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">d_exchange</span> <span class="o">&lt;</span> <span class="n">next_r</span><span class="o">.</span><span class="n">release_date</span>
                    <span class="k">except</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">AmbiguousComparisonException</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- next release date is estimated, time to recalc:&quot;</span><span class="p">,</span> <span class="n">next_r</span><span class="p">)</span>
                        <span class="n">do_calc</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># print(&quot;- releases:&quot;) ; pprint(releases)</span>
                <span class="c1"># print(&quot;- md:&quot;) ; pprint(md)</span>
                <span class="c1"># raise Exception(&#39;review cached release dates&#39;)</span>

        <span class="k">if</span> <span class="n">do_calc</span><span class="p">:</span>
            <span class="n">releases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_release_dates</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">refresh</span><span class="p">,</span> <span class="n">check</span><span class="p">)</span>
            <span class="n">md</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;CalcDate&#39;</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()}</span>
            <span class="k">if</span> <span class="n">releases</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">yfcm</span><span class="o">.</span><span class="n">StoreCacheDatum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="n">cache_key</span><span class="p">,</span> <span class="p">[],</span> <span class="n">metadata</span><span class="o">=</span><span class="n">md</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">yfcm</span><span class="o">.</span><span class="n">StoreCacheDatum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="n">cache_key</span><span class="p">,</span> <span class="n">releases</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">md</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">releases</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">as_df</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">releases</span>

        <span class="n">period_ends</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">period_ends_est</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">release_dates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">release_dates_est</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">delays</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">releases</span><span class="p">:</span>
            <span class="n">rpe</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">period_end</span> <span class="p">;</span> <span class="n">rrd</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">release_date</span>
            <span class="k">if</span> <span class="n">rpe</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">rrd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Release missing dates&#39;</span><span class="p">)</span>
            <span class="n">period_ends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rpe</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rpe</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span> <span class="k">else</span> <span class="n">rpe</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
            <span class="n">period_ends_est</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rpe</span><span class="o">.</span><span class="n">confidence</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rpe</span><span class="p">,</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">DateEstimate</span><span class="p">)</span> <span class="k">else</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Confidence</span><span class="o">.</span><span class="n">High</span><span class="p">)</span>
            <span class="n">dt1</span> <span class="o">=</span> <span class="n">rpe</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rpe</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span> <span class="k">else</span> <span class="n">rpe</span><span class="o">.</span><span class="n">date</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rrd</span><span class="p">,</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">DateRange</span><span class="p">):</span>
                <span class="n">rrd_range</span> <span class="o">=</span> <span class="n">rrd</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="n">rrd</span><span class="o">.</span><span class="n">start</span>
                <span class="n">release_dates_est</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yfcd</span><span class="o">.</span><span class="n">Confidence</span><span class="o">.</span><span class="n">High</span><span class="p">)</span>
                <span class="n">release_dates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">rrd</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">rrd</span><span class="o">.</span><span class="n">end</span><span class="p">))</span>
                <span class="n">midpoint</span> <span class="o">=</span> <span class="n">rrd</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">rrd_range</span><span class="o">.</span><span class="n">days</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">delays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">midpoint</span> <span class="o">-</span> <span class="n">dt1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rrd</span><span class="p">,</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">yfcd</span><span class="o">.</span><span class="n">DateRangeEstimate</span><span class="p">):</span>
                <span class="n">release_dates_est</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rrd</span><span class="o">.</span><span class="n">confidence</span><span class="p">)</span>
                <span class="n">rrd_range</span> <span class="o">=</span> <span class="n">rrd</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="n">rrd</span><span class="o">.</span><span class="n">start</span>
                <span class="n">midpoint</span> <span class="o">=</span> <span class="n">rrd</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">rrd_range</span><span class="o">*</span><span class="mf">0.5</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">midpoint</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
                    <span class="n">midpoint</span> <span class="o">=</span> <span class="n">midpoint</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
                <span class="n">release_dates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">rrd</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">rrd</span><span class="o">.</span><span class="n">end</span><span class="p">))</span>
                <span class="n">delays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">midpoint</span> <span class="o">-</span> <span class="n">dt1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">release_dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rrd</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rrd</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span> <span class="k">else</span> <span class="n">rrd</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
                <span class="n">release_dates_est</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rrd</span><span class="o">.</span><span class="n">confidence</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rrd</span><span class="p">,</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">DateEstimate</span><span class="p">)</span> <span class="k">else</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Confidence</span><span class="o">.</span><span class="n">High</span><span class="p">)</span>
                <span class="n">dt2</span> <span class="o">=</span> <span class="n">rrd</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rrd</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span> <span class="k">else</span> <span class="n">rrd</span><span class="o">.</span><span class="n">date</span>
                <span class="n">delays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dt2</span> <span class="o">-</span> <span class="n">dt1</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;Period end&#39;</span><span class="p">:</span><span class="n">period_ends</span><span class="p">,</span> <span class="s1">&#39;PE confidence&#39;</span><span class="p">:</span><span class="n">period_ends_est</span><span class="p">,</span> <span class="s1">&#39;Release date&#39;</span><span class="p">:</span><span class="n">release_dates</span><span class="p">,</span> <span class="s1">&#39;RD confidence&#39;</span><span class="p">:</span><span class="n">release_dates_est</span><span class="p">,</span> <span class="s1">&#39;Delay&#39;</span><span class="p">:</span><span class="n">delays</span><span class="p">})</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Period end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Period end&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Period end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Period end&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tzName</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Period end&#39;</span><span class="p">)</span>

        <span class="c1"># Set timezone</span>
        <span class="c1"># release_dates_formatted = []</span>
        <span class="c1"># for i in range(df.shape[0]):</span>
        <span class="c1">#     idx = df.index[i]</span>
        <span class="c1">#     x = df[&#39;Release date&#39;].iloc[i]</span>
        <span class="c1">#     if isinstance(x, tuple):</span>
        <span class="c1">#         x = (pd.to_datetime(x[0]).tz_localize(self.tzName), pd.to_datetime(x[1]).tz_localize(self.tzName))</span>
        <span class="c1">#     else:</span>
        <span class="c1">#         x = pd.to_datetime(x).tz_localize(self.tzName)</span>
        <span class="c1">#     release_dates_formatted.append(x)</span>
        <span class="c1"># df[&#39;Release date&#39;] = release_dates_formatted</span>

        <span class="k">return</span> <span class="n">df</span></div>


    <span class="k">def</span> <span class="nf">_calc_release_dates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># debug = True</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_calc_release_dates(</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s2">, refresh=</span><span class="si">{</span><span class="n">refresh</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">ReportingPeriod</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Argument period must be type ReportingPeriod&#39;</span><span class="p">)</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckBool</span><span class="p">(</span><span class="n">refresh</span><span class="p">,</span> <span class="s1">&#39;refresh&#39;</span><span class="p">)</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckBool</span><span class="p">(</span><span class="n">check</span><span class="p">,</span> <span class="s1">&#39;check&#39;</span><span class="p">)</span>

        <span class="c1"># Get period ends</span>
        <span class="n">tbl</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">finType</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Financials</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fin_table</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">refresh</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prune_yf_financial_df</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tbl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tbl</span> <span class="o">=</span> <span class="n">t</span> <span class="p">;</span> <span class="n">finType</span> <span class="o">=</span> <span class="n">f</span>
            <span class="k">elif</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">tbl</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">tbl_wasnt_empty</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">tbl</span><span class="o">.</span><span class="n">empty</span>
                <span class="n">tbl</span> <span class="o">=</span> <span class="n">t</span> <span class="p">;</span> <span class="n">finType</span> <span class="o">=</span> <span class="n">f</span>
                <span class="k">if</span> <span class="n">tbl_wasnt_empty</span><span class="p">:</span>
                    <span class="k">break</span>

        <span class="k">if</span> <span class="n">tbl</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">tbl</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">tbl_cols</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tbl_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">datetime</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">)):</span>
            <span class="n">tbl_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tbl_cols</span><span class="p">]</span>
        <span class="n">period_ends</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">tbl</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">d_today</span><span class="p">]</span>
        <span class="n">period_ends</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- period_ends:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">period_ends</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># Get calendar</span>
        <span class="n">cal_release_dates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_calendar_dates</span><span class="p">(</span><span class="n">refresh</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cal_release_dates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- calendar empty&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- cal_release_dates:&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cal_release_dates</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># Get earnings dates</span>
        <span class="n">edf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_earnings_dates</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">tbl</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">(),</span> <span class="n">refresh</span><span class="o">=</span><span class="n">refresh</span><span class="p">,</span> <span class="n">clean</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Get full year end date</span>
        <span class="n">tbl</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Financials</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fin_table</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">ReportingPeriod</span><span class="o">.</span><span class="n">Full</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># minimise fetches</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prune_yf_financial_df</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">t</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">tbl</span> <span class="o">=</span> <span class="n">t</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">tbl</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">refresh</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Financials</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fin_table</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">ReportingPeriod</span><span class="o">.</span><span class="n">Full</span><span class="p">,</span> <span class="n">refresh</span><span class="p">)</span>
                <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prune_yf_financial_df</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">t</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="n">tbl</span> <span class="o">=</span> <span class="n">t</span>
                    <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tbl</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">year_end</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">year_end</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">year_end</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">tbl</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;&#39;year_end&#39; is NaN&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- year_end =&quot;</span><span class="p">,</span> <span class="n">year_end</span><span class="p">)</span>

        <span class="c1"># Clean earnings dates</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">edf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">edf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- earnings_dates table is empty&quot;</span><span class="p">)</span>
            <span class="n">release_dates</span> <span class="o">=</span> <span class="n">cal_release_dates</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Prune old dates</span>
            <span class="n">f_old</span> <span class="o">=</span> <span class="n">edf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;</span> <span class="n">period_ends</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">f_old</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">edf</span> <span class="o">=</span> <span class="n">edf</span><span class="p">[</span><span class="o">~</span><span class="n">f_old</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">edf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Drop dates that occurred just before another</span>
                <span class="n">edf</span> <span class="o">=</span> <span class="n">edf</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">edf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
                <span class="n">d</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="mi">999</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
                <span class="n">x_near</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;days&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">x_near</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="n">edf</span> <span class="o">=</span> <span class="n">edf</span><span class="p">[</span><span class="o">~</span><span class="n">x_near</span><span class="p">]</span>
                <span class="n">edf</span> <span class="o">=</span> <span class="n">edf</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">release_dates</span> <span class="o">=</span> <span class="n">cal_release_dates</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">edf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">edf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">edf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">td</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">td</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;Reported EPS&quot;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;Surprise(%)&quot;</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;Date confirmed?&#39;</span><span class="p">]:</span>
                        <span class="n">td</span> <span class="o">=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">DateEstimate</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Confidence</span><span class="o">.</span><span class="n">Medium</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">td</span> <span class="o">=</span> <span class="n">dt</span>

                <span class="c1"># Protect against duplicating entries in calendar</span>
                <span class="n">duplicate</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">release_dates</span><span class="p">:</span>
                    <span class="n">diff</span> <span class="o">=</span> <span class="n">c</span> <span class="o">-</span> <span class="n">td</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">duplicate</span> <span class="o">=</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=-</span><span class="mi">20</span><span class="p">)</span> <span class="ow">and</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">AmbiguousComparisonException</span><span class="p">:</span>
                        <span class="n">p1</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">prob_gt</span><span class="p">(</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=-</span><span class="mi">20</span><span class="p">))</span>
                        <span class="n">p2</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">prob_lt</span><span class="p">(</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">20</span><span class="p">))</span>
                        <span class="n">duplicate</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">&gt;</span> <span class="mf">0.9</span> <span class="ow">and</span> <span class="n">p2</span> <span class="o">&gt;</span> <span class="mf">0.9</span>
                    <span class="k">if</span> <span class="n">duplicate</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">duplicate</span><span class="p">:</span>
                    <span class="n">release_dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">td</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- edf:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">edf</span><span class="p">)</span>
            <span class="n">release_dates</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- release_dates:&quot;</span><span class="p">)</span>
            <span class="n">pprint</span><span class="p">(</span><span class="n">release_dates</span><span class="p">)</span>

        <span class="c1"># Deduce interval</span>
        <span class="k">if</span> <span class="n">period</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">ReportingPeriod</span><span class="o">.</span><span class="n">Full</span><span class="p">:</span>
            <span class="n">interval_td</span> <span class="o">=</span> <span class="n">interval_str_to_days</span><span class="p">[</span><span class="s1">&#39;ANNUAL&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">interval_td</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_interval</span><span class="p">(</span><span class="n">finType</span><span class="p">,</span> <span class="n">refresh</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- interval_td = </span><span class="si">{</span><span class="n">interval_td</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Now combine known dates into &#39;Earnings Releases&#39;:</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# Now combine known dates into &#39;Earnings Releases&#39;:&quot;</span><span class="p">)</span>
        <span class="n">releases</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">period_ends</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">EarningsRelease</span><span class="p">(</span><span class="n">interval_td</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">year_end</span><span class="p">)</span>
            <span class="n">releases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">releases</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&gt; releases with known period-end-dates:&quot;</span><span class="p">)</span>
            <span class="n">pprint</span><span class="p">(</span><span class="n">releases</span><span class="p">)</span>

        <span class="c1"># Fill gap between last release and now+9mo with estimated releases</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# Fill gap between last release and now with estimated releases&quot;</span><span class="p">)</span>
        <span class="n">releases</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">last_release</span> <span class="o">=</span> <span class="n">releases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- last_release:&quot;</span><span class="p">,</span> <span class="n">last_release</span><span class="p">)</span>
        <span class="n">ct</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">ct</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">ct</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">releases</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;interval_td = </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">interval_td</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Infinite loop detected while estimating next financial report&quot;</span><span class="p">)</span>

            <span class="n">next_period_end</span> <span class="o">=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">DateEstimate</span><span class="p">(</span><span class="n">interval_td</span> <span class="o">+</span> <span class="n">last_release</span><span class="o">.</span><span class="n">period_end</span><span class="p">,</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Confidence</span><span class="o">.</span><span class="n">High</span><span class="p">)</span>

            <span class="n">r</span> <span class="o">=</span> <span class="n">EarningsRelease</span><span class="p">(</span><span class="n">interval_td</span><span class="p">,</span> <span class="n">next_period_end</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">year_end</span><span class="p">)</span>

            <span class="n">releases</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
            <span class="n">last_release</span> <span class="o">=</span> <span class="n">r</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Inserting:&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">period_end</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">d_today</span><span class="o">+</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">270</span><span class="p">)):</span>
                    <span class="k">break</span>
            <span class="k">except</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">AmbiguousComparisonException</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">period_end</span><span class="o">.</span><span class="n">prob_gt</span><span class="p">(</span><span class="n">d_today</span><span class="o">+</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">270</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="mf">0.9</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">releases</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# Intermediate set of releases:&quot;</span><span class="p">)</span>
            <span class="n">pprint</span><span class="p">(</span><span class="n">releases</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">release_dates</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">release_dates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No release dates in Yahoo so estimating all with Low confidence&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">releases</span><span class="p">)):</span>
                <span class="n">releases</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">release_date</span> <span class="o">=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">DateEstimate</span><span class="p">(</span><span class="n">releases</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">period_end</span><span class="o">+</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span><span class="n">yfcd</span><span class="o">.</span><span class="n">confidence_to_buffer</span><span class="p">[</span><span class="n">yfcd</span><span class="o">.</span><span class="n">Confidence</span><span class="o">.</span><span class="n">Low</span><span class="p">],</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Confidence</span><span class="o">.</span><span class="n">Low</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">releases</span>
        <span class="n">release_dates</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="c1"># Add more releases to ensure their date range fully overlaps with release dates</span>
        <span class="n">release_dates</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">releases</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">ct</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">gt_than</span> <span class="o">=</span> <span class="n">releases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">period_end</span> <span class="o">&gt;</span> <span class="n">release_dates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">AmbiguousComparisonException</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">releases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">period_end</span><span class="p">,</span> <span class="s1">&#39;prob_gt&#39;</span><span class="p">):</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">releases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">period_end</span><span class="o">.</span><span class="n">prob_gt</span><span class="p">(</span><span class="n">release_dates</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">release_dates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">prob_lt</span><span class="p">(</span><span class="n">releases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">period_end</span><span class="p">)</span>
                <span class="n">gt_than</span> <span class="o">=</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="mf">0.9</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">gt_than</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">ct</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">ct</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Infinite loop detected while adding release objects&quot;</span><span class="p">)</span>
            <span class="n">prev_period_end</span> <span class="o">=</span> <span class="n">releases</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">period_end</span> <span class="o">-</span> <span class="n">interval_td</span>
            <span class="n">conf</span> <span class="o">=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Confidence</span><span class="o">.</span><span class="n">High</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prev_period_end</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
                <span class="n">prev_period_end</span> <span class="o">=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">DateEstimate</span><span class="p">(</span><span class="n">prev_period_end</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prev_period_end</span> <span class="o">=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">DateEstimate</span><span class="p">(</span><span class="n">prev_period_end</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">prev_period_end</span><span class="o">.</span><span class="n">confidence</span><span class="p">,</span> <span class="n">conf</span><span class="p">))</span>

            <span class="n">r</span> <span class="o">=</span> <span class="n">EarningsRelease</span><span class="p">(</span><span class="n">interval_td</span><span class="p">,</span> <span class="n">prev_period_end</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">year_end</span><span class="p">)</span>

            <span class="n">releases</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Inserting:&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
        <span class="n">ct</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">less_than</span> <span class="o">=</span> <span class="n">releases</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">period_end</span><span class="o">+</span><span class="n">interval_td</span> <span class="o">&lt;</span> <span class="n">release_dates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">except</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">AmbiguousComparisonException</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">releases</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">period_end</span><span class="o">+</span><span class="n">interval_td</span><span class="p">)</span><span class="o">.</span><span class="n">prob_lt</span><span class="p">(</span><span class="n">release_dates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">less_than</span> <span class="o">=</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="mf">0.5</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">less_than</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">ct</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">ct</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Infinite loop detected while adding release objects&quot;</span><span class="p">)</span>
            <span class="n">next_period_end</span> <span class="o">=</span> <span class="n">releases</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">period_end</span> <span class="o">+</span> <span class="n">interval_td</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">next_period_end</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
                <span class="n">next_period_end</span> <span class="o">=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">DateEstimate</span><span class="p">(</span><span class="n">next_period_end</span><span class="p">,</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Confidence</span><span class="o">.</span><span class="n">Medium</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">next_period_end</span> <span class="o">=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">DateEstimate</span><span class="p">(</span><span class="n">next_period_end</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">next_period_end</span><span class="o">.</span><span class="n">confidence</span><span class="p">,</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Confidence</span><span class="o">.</span><span class="n">Medium</span><span class="p">))</span>

            <span class="n">r</span> <span class="o">=</span> <span class="n">EarningsRelease</span><span class="p">(</span><span class="n">interval_td</span><span class="p">,</span> <span class="n">next_period_end</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">year_end</span><span class="p">)</span>
            <span class="n">releases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Appending:&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
        <span class="c1"># Fill in gaps in periods with estimates:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">releases</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">r0</span> <span class="o">=</span> <span class="n">releases</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">r1</span> <span class="o">=</span> <span class="n">releases</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">diff</span> <span class="o">=</span> <span class="n">r1</span><span class="o">.</span><span class="n">period_end</span> <span class="o">-</span> <span class="n">r0</span><span class="o">.</span><span class="n">period_end</span>
                    <span class="n">gap_too_large</span> <span class="o">=</span> <span class="p">(</span><span class="n">diff</span><span class="o">/</span><span class="mf">1.5</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">interval_td</span>
                <span class="k">except</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">AmbiguousComparisonException</span><span class="p">:</span>
                    <span class="n">gap_too_large</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">gap_too_large</span><span class="p">:</span>
                    <span class="n">new_r</span> <span class="o">=</span> <span class="n">EarningsRelease</span><span class="p">(</span><span class="n">interval_td</span><span class="p">,</span> <span class="n">r1</span><span class="o">.</span><span class="n">period_end</span> <span class="o">-</span> <span class="n">interval_td</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">year_end</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inserting release estimate into gap: </span><span class="si">{</span><span class="n">new_r</span><span class="si">}</span><span class="s2"> (diff=</span><span class="si">{</span><span class="n">diff</span><span class="si">}</span><span class="s2">, interval_td=</span><span class="si">{</span><span class="n">interval_td</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">interval_td</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                    <span class="n">releases</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">new_r</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">releases</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# Final set of releases:&quot;</span><span class="p">)</span>
            <span class="n">pprint</span><span class="p">(</span><span class="n">releases</span><span class="p">)</span>

        <span class="c1"># Assign known dates to appropriate release(s) without dates</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# Assigning known dates to releases ...&quot;</span><span class="p">)</span>
        <span class="n">releases</span> <span class="o">=</span> <span class="n">sort_estimates</span><span class="p">(</span><span class="n">releases</span><span class="p">)</span>
        <span class="n">release_dates</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">release_dates</span><span class="p">)):</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">release_dates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- dt =&quot;</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
            <span class="c1"># Find most recent period-end:</span>
            <span class="n">rj</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">releases</span><span class="p">)):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">releases</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">period_end</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">dt</span><span class="o">-</span><span class="n">company_release_delay</span><span class="p">):</span>
                        <span class="k">break</span>
                <span class="k">except</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">AmbiguousComparisonException</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">releases</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">period_end</span><span class="p">,</span> <span class="s2">&quot;prob_gt&quot;</span><span class="p">):</span>
                        <span class="n">p</span> <span class="o">=</span> <span class="n">releases</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">period_end</span><span class="o">.</span><span class="n">prob_gt</span><span class="p">(</span><span class="n">dt</span><span class="o">-</span><span class="n">company_release_delay</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt</span><span class="o">-</span><span class="n">company_release_delay</span><span class="p">)</span><span class="o">.</span><span class="n">prob_lt</span><span class="p">(</span><span class="n">releases</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">period_end</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - prob. that </span><span class="si">{</span><span class="n">releases</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">period_end</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="n">dt</span><span class="o">-</span><span class="n">company_release_delay</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="mf">100.0</span><span class="o">*</span><span class="n">p</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="n">rj</span> <span class="o">=</span> <span class="n">j</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">releases</span><span class="p">[</span><span class="n">rj</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - rj =&quot;</span><span class="p">,</span> <span class="n">rj</span><span class="p">,</span> <span class="s2">&quot;,  r =&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">release_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Already assigned an earlier release date.</span>

                <span class="n">dt_is_for_same_period</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">edf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">release_date</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">release_date</span> <span class="ow">in</span> <span class="n">edf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span><span class="p">:</span>
                        <span class="c1"># Not great because assumes two consecutive earnings don&#39;t report same EPS</span>
                        <span class="n">dt_is_for_same_period1</span> <span class="o">=</span> <span class="n">edf</span><span class="p">[</span><span class="s1">&#39;Reported EPS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">dt</span><span class="p">)]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">edf</span><span class="p">[</span><span class="s1">&#39;Reported EPS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">release_date</span><span class="p">)]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">dt_is_for_same_period2</span> <span class="o">=</span> <span class="n">edf</span><span class="p">[</span><span class="s1">&#39;EPS Estimate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">dt</span><span class="p">)]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">edf</span><span class="p">[</span><span class="s1">&#39;EPS Estimate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">release_date</span><span class="p">)]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">dt_is_for_same_period</span> <span class="o">=</span> <span class="n">dt_is_for_same_period1</span> <span class="ow">and</span> <span class="n">dt_is_for_same_period2</span>
                <span class="k">if</span> <span class="n">dt_is_for_same_period</span><span class="p">:</span>
                    <span class="c1"># Assume the earlier release was just a preliminary cash-flow update, and that</span>
                    <span class="c1"># this later release is the full financials report</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - assume earlier release </span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">release_date</span><span class="si">}</span><span class="s2"> was just a preliminary cash-flow update, and that&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - this later release </span><span class="si">{</span><span class="n">dt</span><span class="si">}</span><span class="s2"> is the full financials report&quot;</span><span class="p">)</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">release_date</span> <span class="o">=</span> <span class="n">dt</span>
                    <span class="k">continue</span>

                <span class="n">dt_is_better</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">release_date</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">):</span>
                        <span class="c1"># Maybe the previously-assigned date was estimate, from bad Yahoo data</span>
                        <span class="n">dt_is_better</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">release_date</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dt</span><span class="o">.</span><span class="n">confidence</span> <span class="o">&gt;</span> <span class="n">r</span><span class="o">.</span><span class="n">release_date</span><span class="o">.</span><span class="n">confidence</span><span class="p">:</span>
                        <span class="n">dt_is_better</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - dt_is_better =&quot;</span><span class="p">,</span> <span class="n">dt_is_better</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dt_is_better</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - dt=</span><span class="si">{</span><span class="n">dt</span><span class="si">}</span><span class="s2"> is more accurate than date already assigned to </span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2">. so overwrite with dt&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - discarding previously assigned dt=</span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">release_date</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">release_date</span> <span class="o">=</span> <span class="n">dt</span>
                    <span class="k">continue</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">quarterly</span> <span class="o">=</span> <span class="n">interval_td</span> <span class="o">&lt;=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">AmbiguousComparisonException</span><span class="p">:</span>
                    <span class="n">quarterly</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">quarterly</span><span class="p">:</span>
                    <span class="c1"># Not quarterly releases so can&#39;t safely reassign dates.</span>
                    <span class="c1"># Probably this date &#39;dt&#39; is for a cashflow update, not</span>
                    <span class="c1"># full earnings release.</span>
                    <span class="c1"># So treat this date &#39;dt&#39; unassignable.</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - because not quarterly, have to discard unassigned date </span><span class="si">{</span><span class="n">dt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="n">r_is_end_of_year</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">is_end_of_year</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - r_is_end_of_year =&quot;</span><span class="p">,</span> <span class="n">r_is_end_of_year</span><span class="p">)</span>

                <span class="c1"># if r_is_end_of_year and rj &gt; 0:</span>
                <span class="c1">#     # For annual reports, allow reassigned date to previous release,</span>
                <span class="c1">#     # because annual reports can take longer to release.</span>
                <span class="c1">#     if (releases[rj-1].release_date is not None) and (not dt_is_better):</span>
                <span class="c1">#         # print(&quot;- dt =&quot;, dt)</span>
                <span class="c1">#         # print(&quot;- dt_is_for_same_period =&quot;, dt_is_for_same_period)</span>
                <span class="c1">#         # print(&quot;- r_is_end_of_year =&quot;, r_is_end_of_year)</span>
                <span class="c1">#         # print(&quot;- this release:&quot;, releases[rj])</span>
                <span class="c1">#         # print(&quot;- previous release:&quot;, releases[rj-1])</span>
                <span class="c1">#         # print(&quot;- edf:&quot;)</span>
                <span class="c1">#         # print(edf.drop([&#39;FetchDate&#39;], axis=1))</span>
                <span class="c1">#         # print(edf.columns)</span>
                <span class="c1">#         # print(&quot;- release_dates:&quot;) ; pprint(release_dates)</span>
                <span class="c1">#         # raise Exception(&#39;Expected prior report to not be assigned date&#39;)</span>
                <span class="c1">#         # Update:</span>
                <span class="c1">#         # If this date not better, then just discard.</span>
                <span class="c1">#         pass</span>
                <span class="c1">#     else:</span>
                <span class="c1">#         if debug:</span>
                <span class="c1">#             print(f&quot;  - reassigning dt={releases[rj].release_date} to previous report {releases[rj-1]}&quot;)</span>
                <span class="c1">#         releases[rj-1].release_date = r.release_date</span>
                <span class="c1">#         r.release_date = dt</span>
                <span class="c1"># else:</span>
                <span class="c1">#     if debug:</span>
                <span class="c1">#         print(f&quot;  - discarding previously assigned dt={releases[rj].release_date}&quot;)</span>
                <span class="c1"># Update: refactor logic</span>
                <span class="k">if</span> <span class="n">r_is_end_of_year</span> <span class="ow">or</span> <span class="n">dt_is_better</span><span class="p">:</span>
                    <span class="c1"># First, decide whether to reassign assigned date to previous release</span>
                    <span class="k">if</span> <span class="n">rj</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">releases</span><span class="p">[</span><span class="n">rj</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">release_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># if debug:</span>
                        <span class="c1">#     print(f&quot;  - reassigning dt={releases[rj].release_date} to previous report {releases[rj-1]}&quot;)</span>
                        <span class="c1"># releases[rj-1].release_date = r.release_date</span>
                        <span class="c1">#</span>
                        <span class="c1"># But what if I don&#39;t? Might be causing trouble no benefit</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - discarding previously assigned dt=</span><span class="si">{</span><span class="n">releases</span><span class="p">[</span><span class="n">rj</span><span class="p">]</span><span class="o">.</span><span class="n">release_date</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">release_date</span> <span class="o">=</span> <span class="n">dt</span>

            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - assigning dt=</span><span class="si">{</span><span class="n">dt</span><span class="si">}</span><span class="s2"> to report=</span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">r</span><span class="o">.</span><span class="n">release_date</span> <span class="o">=</span> <span class="n">dt</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">releases</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&gt; releases with known release dates:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">releases</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

        <span class="c1"># Discard date assignments where delays are much higher than average</span>
        <span class="n">delays</span> <span class="o">=</span> <span class="p">[(</span><span class="n">r</span><span class="o">.</span><span class="n">release_date</span> <span class="o">-</span> <span class="n">r</span><span class="o">.</span><span class="n">period_end</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">releases</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">release_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">delays</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">delays</span> <span class="o">=</span> <span class="n">sort_estimates</span><span class="p">(</span><span class="n">delays</span><span class="p">)</span>
            <span class="n">median_delay</span> <span class="o">=</span> <span class="n">delays</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">delays</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">delays</span> <span class="o">=</span> <span class="p">[(</span><span class="n">r</span><span class="o">.</span><span class="n">release_date</span> <span class="o">-</span> <span class="n">r</span><span class="o">.</span><span class="n">period_end</span><span class="p">)</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">release_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">releases</span><span class="p">]</span>
            <span class="n">outliers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">delays</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">delays</span><span class="p">)):</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">releases</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">r_is_end_of_year</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">is_end_of_year</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - r_is_end_of_year =&quot;</span><span class="p">,</span> <span class="n">r_is_end_of_year</span><span class="p">)</span>

                <span class="n">threshold</span> <span class="o">=</span> <span class="n">median_delay</span><span class="o">*</span><span class="mi">3</span>
                <span class="k">if</span> <span class="n">r_is_end_of_year</span><span class="p">:</span>
                    <span class="n">threshold</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">outliers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">delays</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span>
                <span class="k">except</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">AmbiguousComparisonException</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">delays</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;prob_gt&#39;</span><span class="p">):</span>
                        <span class="n">p</span> <span class="o">=</span> <span class="n">delays</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">prob_gt</span><span class="p">(</span><span class="n">threshold</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">p</span> <span class="o">=</span> <span class="n">threshold</span><span class="o">.</span><span class="n">prob_lt</span><span class="p">(</span><span class="n">delays</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">outliers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="mf">0.9</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">outliers</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;discarding a release date because delay far above median </span><span class="si">{</span><span class="n">median_delay</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">,</span> <span class="n">releases</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">releases</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">release_date</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># For any releases still without release dates, estimate with the following heuristics:</span>
        <span class="c1"># 1 - if release 12 months before/after has a date (or a multiple of 12), use that +/- 12 months</span>
        <span class="c1"># 2 - else used previous release + interval</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# Estimating release dates from other releases at similar time-of-year&quot;</span><span class="p">)</span>
        <span class="n">report_delay</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">releases</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">r</span><span class="o">.</span><span class="n">release_date</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">releases</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">try_interval</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">365</span><span class="p">,</span> <span class="mi">365</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="mi">365</span><span class="o">//</span><span class="mi">4</span><span class="p">]:</span>
                <span class="n">itd</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">try_interval</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">releases</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">releases</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">release_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># Need to find a similar release to extrapolate date from</span>
                        <span class="n">date_set</span> <span class="o">=</span> <span class="kc">False</span>

                        <span class="k">for</span> <span class="n">i2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">releases</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="n">i2</span><span class="o">==</span><span class="n">i</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="k">if</span> <span class="n">releases</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span><span class="o">.</span><span class="n">release_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">period</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">ReportingPeriod</span><span class="o">.</span><span class="n">Full</span><span class="p">:</span>
                                    <span class="n">tolerance</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">tolerance</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">releases</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span><span class="o">.</span><span class="n">period_end</span> <span class="o">&gt;</span> <span class="n">releases</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">period_end</span><span class="p">:</span>
                                    <span class="n">rem</span> <span class="o">=</span> <span class="p">(</span><span class="n">releases</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span><span class="o">.</span><span class="n">period_end</span> <span class="o">-</span> <span class="n">releases</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">period_end</span><span class="p">)</span> <span class="o">%</span> <span class="n">itd</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">rem</span> <span class="o">=</span> <span class="p">(</span><span class="n">releases</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">period_end</span> <span class="o">-</span> <span class="n">releases</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span><span class="o">.</span><span class="n">period_end</span><span class="p">)</span> <span class="o">%</span> <span class="n">itd</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">m1</span> <span class="o">=</span> <span class="n">rem</span> <span class="o">&lt;</span> <span class="n">tolerance</span>
                                <span class="k">except</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">AmbiguousComparisonException</span><span class="p">:</span>
                                    <span class="n">m1</span> <span class="o">=</span> <span class="n">rem</span><span class="o">.</span><span class="n">prob_lt</span><span class="p">(</span><span class="n">tolerance</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.9</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">m2</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rem</span><span class="o">-</span><span class="n">itd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tolerance</span>
                                <span class="k">except</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">AmbiguousComparisonException</span><span class="p">:</span>
                                    <span class="n">m2</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rem</span><span class="o">-</span><span class="n">itd</span><span class="p">)</span><span class="o">.</span><span class="n">prob_lt</span><span class="p">(</span><span class="n">tolerance</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.9</span>
                                <span class="n">match</span> <span class="o">=</span> <span class="n">m1</span> <span class="ow">or</span> <span class="n">m2</span>
                                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- matching &#39;</span><span class="si">{</span><span class="n">releases</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; with &#39;</span><span class="si">{</span><span class="n">releases</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; for interval &#39;</span><span class="si">{</span><span class="n">try_interval</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                                    <span class="n">delay</span> <span class="o">=</span> <span class="n">releases</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span><span class="o">.</span><span class="n">release_date</span> <span class="o">-</span> <span class="n">releases</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span><span class="o">.</span><span class="n">period_end</span>
                                    <span class="n">dt</span> <span class="o">=</span> <span class="n">delay</span> <span class="o">+</span> <span class="n">releases</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">period_end</span>

                                    <span class="n">r_is_end_of_year</span> <span class="o">=</span> <span class="n">releases</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">is_end_of_year</span><span class="p">()</span>
                                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - r_is_end_of_year =&quot;</span><span class="p">,</span> <span class="n">r_is_end_of_year</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">r_is_end_of_year</span> <span class="ow">and</span> <span class="n">try_interval</span> <span class="o">!=</span> <span class="mi">365</span><span class="p">:</span>
                                        <span class="c1"># Annual reports take longer than interims, so add on some more days</span>
                                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - adding 14d to dt&quot;</span><span class="p">)</span>
                                        <span class="n">dt</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

                                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">):</span>
                                        <span class="k">if</span> <span class="n">r_is_end_of_year</span> <span class="ow">and</span> <span class="n">try_interval</span> <span class="o">!=</span> <span class="mi">365</span><span class="p">:</span>
                                            <span class="n">confidence</span> <span class="o">=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Confidence</span><span class="o">.</span><span class="n">Low</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">confidence</span> <span class="o">=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Confidence</span><span class="o">.</span><span class="n">Medium</span>
                                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
                                            <span class="n">dt</span> <span class="o">=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">DateEstimate</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">confidence</span><span class="p">)</span>
                                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">DateRange</span><span class="p">):</span>
                                            <span class="n">dt</span> <span class="o">=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">DateRangeEstimate</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="n">confidence</span><span class="p">)</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Need to ensure this value has confidence:&#39;</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">r_is_end_of_year</span> <span class="ow">and</span> <span class="n">try_interval</span> <span class="o">!=</span> <span class="mi">365</span><span class="p">:</span>
                                            <span class="n">confidences</span> <span class="o">=</span> <span class="p">[</span><span class="n">yfcd</span><span class="o">.</span><span class="n">Confidence</span><span class="o">.</span><span class="n">Low</span><span class="p">]</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">confidences</span> <span class="o">=</span> <span class="p">[</span><span class="n">yfcd</span><span class="o">.</span><span class="n">Confidence</span><span class="o">.</span><span class="n">Medium</span><span class="p">]</span>
                                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">releases</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span><span class="o">.</span><span class="n">period_end</span><span class="p">,</span> <span class="p">(</span><span class="n">yfcd</span><span class="o">.</span><span class="n">DateEstimate</span><span class="p">,</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">DateRangeEstimate</span><span class="p">)):</span>
                                            <span class="n">confidences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">releases</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span><span class="o">.</span><span class="n">period_end</span><span class="o">.</span><span class="n">confidence</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">releases</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span><span class="o">.</span><span class="n">release_date</span><span class="p">,</span> <span class="p">(</span><span class="n">yfcd</span><span class="o">.</span><span class="n">DateEstimate</span><span class="p">,</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">DateRangeEstimate</span><span class="p">)):</span>
                                            <span class="n">confidences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">releases</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span><span class="o">.</span><span class="n">release_date</span><span class="o">.</span><span class="n">confidence</span><span class="p">)</span>
                                        <span class="n">dt</span><span class="o">.</span><span class="n">confidence</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">confidences</span><span class="p">)</span>

                                    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">releases</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">release_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                                        <span class="n">too_close_to_previous</span> <span class="o">=</span> <span class="kc">False</span>
                                        <span class="k">try</span><span class="p">:</span>
                                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">releases</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">release_date</span><span class="p">,</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">DateEstimate</span><span class="p">):</span>
                                                <span class="n">too_close_to_previous</span> <span class="o">=</span> <span class="n">releases</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">release_date</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
                                            <span class="k">else</span><span class="p">:</span>
                                                <span class="k">if</span> <span class="n">releases</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">is_end_of_year</span><span class="p">():</span>
                                                    <span class="n">threshold</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                                                <span class="k">else</span><span class="p">:</span>
                                                    <span class="n">threshold</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
                                                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                                                    <span class="n">diff</span> <span class="o">=</span> <span class="n">dt</span><span class="o">-</span><span class="n">releases</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">release_date</span>
                                                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - diff = </span><span class="si">{</span><span class="n">diff</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - threshold = </span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                                <span class="n">too_close_to_previous</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt</span><span class="o">-</span><span class="n">releases</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">release_date</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">threshold</span>
                                        <span class="k">except</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">AmbiguousComparisonException</span><span class="p">:</span>
                                            <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt</span><span class="o">-</span><span class="n">releases</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">release_date</span><span class="p">)</span><span class="o">.</span><span class="n">prob_lt</span><span class="p">(</span><span class="n">threshold</span><span class="p">)</span>
                                            <span class="n">too_close_to_previous</span> <span class="o">=</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="mf">0.9</span>
                                        <span class="k">if</span> <span class="n">too_close_to_previous</span><span class="p">:</span>
                                            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - dt &#39;</span><span class="si">{</span><span class="n">dt</span><span class="si">}</span><span class="s2">&#39; would be too close to previous release date &#39;</span><span class="si">{</span><span class="n">releases</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                                            <span class="c1"># Too close to last release date</span>
                                            <span class="k">continue</span>
                                    <span class="n">releases</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">release_date</span> <span class="o">=</span> <span class="n">dt</span>
                                    <span class="n">date_set</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - estimated release date </span><span class="si">{}</span><span class="s2"> of period-end </span><span class="si">{}</span><span class="s2"> from period-end </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">releases</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">release_date</span><span class="p">,</span> <span class="n">releases</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">period_end</span><span class="p">,</span> <span class="n">releases</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span><span class="o">.</span><span class="n">period_end</span><span class="p">))</span>
                                    <span class="k">break</span>

                        <span class="k">if</span> <span class="n">date_set</span> <span class="ow">and</span> <span class="p">(</span><span class="n">report_delay</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                            <span class="n">releases</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">release_date</span><span class="o">.</span><span class="n">date</span> <span class="o">+=</span> <span class="n">report_delay</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&gt; releases after estimating release dates:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">releases</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

        <span class="n">any_release_has_date</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">releases</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">release_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">any_release_has_date</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">any_release_has_date</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- unable to map all </span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s2"> financials to release dates&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Check for any releases still missing a release date that could be the Last earnings release:</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">r</span><span class="o">.</span><span class="n">release_date</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">releases</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">releases</span><span class="p">)):</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">releases</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">release_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">problem</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">releases</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">problem</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">r2</span> <span class="o">=</span> <span class="n">releases</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">r2</span><span class="o">.</span><span class="n">release_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">r2</span><span class="o">.</span><span class="n">release_date</span> <span class="o">&gt;</span> <span class="n">d_today</span><span class="p">):</span>
                            <span class="n">problem</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">problem</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;A release that could be last is missing release date&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&gt; releases after estimating release dates:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">releases</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">check</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_release_dates</span><span class="p">(</span><span class="n">releases</span><span class="p">,</span> <span class="n">finType</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">refresh</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">releases</span>

    <span class="k">def</span> <span class="nf">_check_release_dates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">releases</span><span class="p">,</span> <span class="n">finType</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">refresh</span><span class="p">):</span>
        <span class="c1"># if period == yfcd.ReportingPeriod.Full:</span>
        <span class="c1">#     interval_td = interval_str_to_days[&#39;ANNUAL&#39;]</span>
        <span class="c1"># else:</span>
        <span class="c1">#     interval_td = self._get_interval(finType, refresh)</span>

        <span class="c1"># Ignore releases with no date:</span>
        <span class="c1"># - can happen with nonsense financials dates from Yahoo that</span>
        <span class="c1">#   even my prune function couldn&#39;t safely remove</span>
        <span class="n">releases</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">releases</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">release_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i0</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">releases</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">r0</span> <span class="o">=</span> <span class="n">releases</span><span class="p">[</span><span class="n">i0</span><span class="p">]</span>
            <span class="n">r0rd</span> <span class="o">=</span> <span class="n">r0</span><span class="o">.</span><span class="n">release_date</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">r0rd</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">r0rd</span><span class="o">.</span><span class="n">confidence</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Confidence</span><span class="o">.</span><span class="n">Low</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i0</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">releases</span><span class="p">)):</span>
                <span class="n">r1</span> <span class="o">=</span> <span class="n">releases</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span>
                <span class="n">r1rd</span> <span class="o">=</span> <span class="n">r1</span><span class="o">.</span><span class="n">release_date</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">r1rd</span><span class="p">,</span> <span class="s1">&#39;confidence&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">r1rd</span><span class="o">.</span><span class="n">confidence</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Confidence</span><span class="o">.</span><span class="n">Low</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1">#</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r0rd</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r1rd</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
                    <span class="n">isclose</span> <span class="o">=</span> <span class="n">r0rd</span> <span class="o">==</span> <span class="n">r1rd</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r0rd</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
                    <span class="n">isclose</span> <span class="o">=</span> <span class="n">r1rd</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">r0rd</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">isclose</span> <span class="o">=</span> <span class="n">r0rd</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">r1rd</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">isclose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">r0</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s1"> Release dates have been assigned multiple times&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">r0</span><span class="o">.</span><span class="n">is_end_of_year</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># bad_order = r0.release_date &gt; r1.period_end</span>
                        <span class="n">bad_order</span> <span class="o">=</span> <span class="n">r0</span><span class="o">.</span><span class="n">release_date</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">r1</span><span class="o">.</span><span class="n">period_end</span><span class="o">+</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">))</span>
                    <span class="k">except</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">AmbiguousComparisonException</span><span class="p">:</span>
                        <span class="n">p</span> <span class="o">=</span> <span class="n">r0</span><span class="o">.</span><span class="n">release_date</span><span class="o">.</span><span class="n">prob_gt</span><span class="p">(</span><span class="n">r1</span><span class="o">.</span><span class="n">period_end</span><span class="o">+</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">))</span>
                        <span class="n">bad_order</span> <span class="o">=</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="mf">0.9</span>
                    <span class="c1"># try:</span>
                    <span class="c1">#     bad_order = bad_order and ((r1.period_end - r0.period_end)*2.0 &gt; interval_td)</span>
                    <span class="c1"># except yfcd.AmbiguousComparisonException:</span>
                    <span class="c1">#     bad_order = False</span>
                    <span class="k">if</span> <span class="n">bad_order</span><span class="p">:</span>
                        <span class="n">pprint</span><span class="p">(</span><span class="n">releases</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">r0</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s1"> Some releases dates are after next period ends&#39;</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">releases</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">is_negative</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">release_date</span> <span class="o">&lt;</span> <span class="n">r</span><span class="o">.</span><span class="n">period_end</span>
            <span class="k">except</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">AmbiguousComparisonException</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">release_date</span><span class="o">.</span><span class="n">prob_lt</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">period_end</span><span class="p">)</span>
                <span class="n">is_negative</span> <span class="o">=</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="mf">0.9</span>
            <span class="k">if</span> <span class="n">is_negative</span><span class="p">:</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">release_date</span> <span class="o">-</span> <span class="n">r</span><span class="o">.</span><span class="n">period_end</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- rd =&quot;</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">release_date</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">release_date</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- pe =&quot;</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">period_end</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">period_end</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- diff =&quot;</span><span class="p">,</span> <span class="n">diff</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">diff</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Release dates contains negative delays&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_prune_yf_financial_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># debug = True</span>

        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df</span>

        <span class="c1">## Fiddly to put dates into a list and sort without reordering dataframe and without down-casting the date types!</span>
        <span class="n">dates</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">dates</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="n">cache_key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">dates</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cache_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pruned_tbl_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pruned_tbl_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span>

        <span class="c1"># Drop duplicated columns</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dates</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dates</span><span class="p">):</span>
            <span class="c1">## Search for duplicated columns</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
            <span class="n">dates</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            <span class="n">dates</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="c1"># Drop mostly-NaN duplicated dates:</span>
        <span class="n">df_modified</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dates</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dates</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">dates</span><span class="p">):</span>
                <span class="n">dff</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dff</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">dff</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="c1"># This date is duplicated, so count NaNs:</span>
                    <span class="n">n_dups</span> <span class="o">=</span> <span class="n">dff</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">dt_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="n">dt</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">is_mostly_nans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">False</span><span class="p">]</span><span class="o">*</span><span class="n">n_dups</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_dups</span><span class="p">):</span>
                        <span class="n">dt_idx</span> <span class="o">=</span> <span class="n">dt_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">is_mostly_nans</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">dt_idx</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">0.75</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">is_mostly_nans</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="n">n_dups</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="c1">## All but one column are mostly nans, perfect!</span>
                        <span class="n">drop_indices</span> <span class="o">=</span> <span class="n">dt_indices</span><span class="p">[</span><span class="n">is_mostly_nans</span><span class="p">]</span>
                        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                        <span class="n">keep_indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">drop_indices</span><span class="p">)]</span>
                        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">keep_indices</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">df_modified</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="n">dff</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dff</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">dff</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="c1"># Date still duplicated. </span>
                    <span class="c1"># Find instance with most non-nan values; if </span>
                    <span class="c1"># all other instances are equal or nan then drop.</span>

                    <span class="n">n_dups</span> <span class="o">=</span> <span class="n">dff</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">dt_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="n">dt</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">nan_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_dups</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_dups</span><span class="p">):</span>
                        <span class="n">dt_idx</span> <span class="o">=</span> <span class="n">dt_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">nan_counts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">dt_idx</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="n">idx_min_na</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n_dups</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">nan_counts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">nan_counts</span><span class="p">[</span><span class="n">idx_min_na</span><span class="p">]:</span>
                            <span class="n">idx_min_na</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="n">drop_indices</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_dups</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">idx_min_na</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">min_idx</span> <span class="o">=</span> <span class="n">dt_indices</span><span class="p">[</span><span class="n">idx_min_na</span><span class="p">]</span>
                        <span class="n">dt_idx</span> <span class="o">=</span> <span class="n">dt_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">f_match</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">dt_idx</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">dt_idx</span><span class="p">]</span><span class="o">==</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">min_idx</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">f_match</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                            <span class="n">drop_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dt_idx</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">drop_indices</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                        <span class="n">keep_indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">drop_indices</span><span class="p">)]</span>
                        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">keep_indices</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">df_modified</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">df_modified</span><span class="p">:</span>
            <span class="n">dates</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            <span class="n">dates</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="c1"># If duplicated date columns is very similar, then drop right-most:</span>
        <span class="n">df_modified</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dates</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dates</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">dates</span><span class="p">):</span>
                <span class="n">dff</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dff</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">dff</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">dff</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">dff</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dff</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
                    <span class="c1"># r = dff.diff(axis=1)</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">dff</span><span class="p">[</span><span class="n">dff</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">-</span> <span class="n">dff</span><span class="p">[</span><span class="n">dff</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">/</span> <span class="n">dff</span><span class="p">[</span><span class="n">dff</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mf">0.15</span><span class="p">:</span>
                        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">df</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span> <span class="o">=</span> <span class="n">dff</span><span class="p">[</span><span class="n">dff</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                        <span class="n">df_modified</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">df_modified</span><span class="p">:</span>
            <span class="n">dates</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            <span class="n">dates</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dates</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dates</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dates: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dates</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Duplicate dates found in financial df&quot;</span><span class="p">)</span>

        <span class="c1"># Search for mostly-nan columns, where the non-nan values are exact match to an adjacent column.</span>
        <span class="c1"># Replace those nans with adjacent column values.</span>
        <span class="c1"># Optimise:</span>
        <span class="n">df_isnull</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span>
        <span class="n">df_isnull_sums</span> <span class="o">=</span> <span class="n">df_isnull</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">nan_threshold</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">0.75</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dates</span><span class="p">)):</span>
            <span class="n">d1</span> <span class="o">=</span> <span class="n">dates</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span>
            <span class="n">d0</span> <span class="o">=</span> <span class="n">dates</span><span class="p">[</span><span class="n">i1</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">d0_mostly_nans</span> <span class="o">=</span> <span class="n">df_isnull_sums</span><span class="p">[</span><span class="n">d0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">nan_threshold</span>
            <span class="n">d1_mostly_nans</span> <span class="o">=</span> <span class="n">df_isnull_sums</span><span class="p">[</span><span class="n">d1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">nan_threshold</span>
            <span class="k">if</span> <span class="n">d0_mostly_nans</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">d1_mostly_nans</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">df_isnull</span><span class="p">[</span><span class="n">d0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df_isnull</span><span class="p">[</span><span class="n">d1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="c1"># At least two actual values</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f</span><span class="p">,</span><span class="n">d0</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f</span><span class="p">,</span><span class="n">d1</span><span class="p">]):</span>
                        <span class="c1"># and those values match</span>
                        <span class="n">df</span><span class="p">[</span><span class="n">d0</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">d1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">d1_mostly_nans</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">d0_mostly_nans</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">df_isnull</span><span class="p">[</span><span class="n">d1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">df_isnull</span><span class="p">[</span><span class="n">d0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="c1"># At least two actual values</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f</span><span class="p">,</span><span class="n">d1</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f</span><span class="p">,</span><span class="n">d0</span><span class="p">]):</span>
                        <span class="c1"># and those values match</span>
                        <span class="n">df</span><span class="p">[</span><span class="n">d1</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">d0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Drop mostly-nan columns:</span>
        <span class="n">df_modified</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">dates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># if df[d].isnull().sum() == df.shape[0]:</span>
            <span class="c1">#   # Full of nans, drop column:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&gt;</span> <span class="n">nan_threshold</span><span class="p">:</span>
                <span class="c1"># Mostly nans, drop column</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_prune_yf_financial_df(): column </span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2"> is mostly NaNs&quot;</span><span class="p">)</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">df_modified</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">df_modified</span><span class="p">:</span>
            <span class="n">dates</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            <span class="n">dates</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="c1"># # Then drop all columns devoid of data (NaN and 0.0):</span>
        <span class="c1"># for i in range(len(dates)-1, -1, -1):</span>
        <span class="c1">#     d = dates[i]</span>
        <span class="c1">#     fnan = df[d].isnull()</span>
        <span class="c1">#     fzero = df[d]==0.0</span>
        <span class="c1">#     if sum(np_or(fnan, fzero)) == df.shape[0]:</span>
        <span class="c1">#         # Completely devoid of data, drop column</span>
        <span class="c1">#         df = df.drop(d, axis=1)</span>

        <span class="c1"># Search for populated columns, where values are very similar.</span>
        <span class="n">similarity_pct_threshold</span> <span class="o">=</span> <span class="mf">0.8</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">d1</span> <span class="o">=</span> <span class="n">dates</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">d0</span> <span class="o">=</span> <span class="n">dates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">d1</span> <span class="o">-</span> <span class="n">d0</span>
            <span class="n">similarity_pct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">d0</span><span class="p">]</span> <span class="o">==</span> <span class="n">df</span><span class="p">[</span><span class="n">d1</span><span class="p">])</span> <span class="o">/</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="ow">and</span> <span class="n">delta</span> <span class="o">&lt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span> <span class="ow">and</span> <span class="n">similarity_pct</span> <span class="o">&gt;</span> <span class="n">similarity_pct_threshold</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">d0</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2"> very similar &amp; close to </span><span class="si">{</span><span class="n">d1</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2">, discarding later&quot;</span><span class="p">)</span>
                <span class="c1"># df = df.drop(d1, axis=1)</span>
                <span class="c1"># Instead of arbitrarily dropping one date, be smart.</span>
                <span class="c1"># Keep the one that makes most sense relative to distances to other dates</span>
                <span class="n">diffs0</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">;</span> <span class="n">diffs1</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">diffs0</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">dates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">dates</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">days</span><span class="p">)</span>
                    <span class="n">diffs1</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">dates</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dates</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">days</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">):</span>
                    <span class="n">diffs0</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">dates</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">dates</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">days</span><span class="p">)</span>
                    <span class="n">diffs1</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">dates</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">dates</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">days</span><span class="p">)</span>
                <span class="n">diffs0</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">d</span><span class="o">-</span><span class="mi">91</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">d</span><span class="o">-</span><span class="mi">182</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">d</span><span class="o">-</span><span class="mi">365</span><span class="p">))</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">diffs0</span><span class="p">]</span>
                <span class="n">diffs1</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">d</span><span class="o">-</span><span class="mi">91</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">d</span><span class="o">-</span><span class="mi">182</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">d</span><span class="o">-</span><span class="mi">365</span><span class="p">))</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">diffs1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">mean</span><span class="p">(</span><span class="n">diffs0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">mean</span><span class="p">(</span><span class="n">diffs1</span><span class="p">):</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">d0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">dates</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
                <span class="n">dates</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dates</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dates</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dates: </span><span class="si">{</span><span class="n">dates</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Duplicate dates found in financial df&quot;</span><span class="p">)</span>

        <span class="c1"># Remove columns which YF created by backfilling</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
        <span class="n">dates</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dates</span><span class="p">)):</span>
            <span class="n">d0</span> <span class="o">=</span> <span class="n">dates</span><span class="p">[</span><span class="n">i1</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">d1</span> <span class="o">=</span> <span class="n">dates</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span>
            <span class="n">d0_values</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">d0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">d1_values</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">d1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">d0_values</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">d0_values</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">d1_values</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">d1_values</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">d0_values</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">d1_values</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_prune_yf_financial_df(): column </span><span class="si">{</span><span class="n">d0</span><span class="si">}</span><span class="s2"> appears backfilled by Yahoo&quot;</span><span class="p">)</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">d0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;_prune_yf_financial_df() has removed all columns&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pruned_tbl_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>

        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">_earnings_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_report</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># Use cached data to deduce interval regardless of &#39;refresh&#39;.</span>
        <span class="c1"># If refresh=True, only refresh if cached data not good enough.</span>

        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckBool</span><span class="p">(</span><span class="n">with_report</span><span class="p">,</span> <span class="s1">&#39;with_report&#39;</span><span class="p">)</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckBool</span><span class="p">(</span><span class="n">refresh</span><span class="p">,</span> <span class="s1">&#39;refresh&#39;</span><span class="p">)</span>

        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># debug = True</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;_earnings_interval(with_report=</span><span class="si">{</span><span class="n">with_report</span><span class="si">}</span><span class="s1">, refresh=</span><span class="si">{</span><span class="n">refresh</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

        <span class="n">interval</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">inference_successful</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">with_report</span><span class="p">:</span>
            <span class="n">edf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_earnings_dates</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">d_today</span><span class="o">-</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">730</span><span class="p">),</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">edf</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">edf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="ow">and</span> <span class="n">refresh</span><span class="p">:</span>
                <span class="n">edf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_earnings_dates</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">d_today</span><span class="o">-</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">730</span><span class="p">),</span> <span class="n">refresh</span><span class="o">=</span><span class="n">refresh</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">edf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">edf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="c1"># First, remove duplicates:</span>
                <span class="n">deltas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">edf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span><span class="p">))</span> <span class="o">/</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)))</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deltas</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">edf</span> <span class="o">=</span> <span class="n">edf</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                <span class="n">edf_old</span> <span class="o">=</span> <span class="n">edf</span><span class="p">[</span><span class="n">edf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()]</span>
                <span class="k">if</span> <span class="n">edf_old</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">edf</span> <span class="o">=</span> <span class="n">edf_old</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">deltas</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">edf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span><span class="p">))</span> <span class="o">/</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">deltas</span> <span class="o">==</span> <span class="n">deltas</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                    <span class="c1"># Identical, perfect</span>
                    <span class="n">interval_days</span> <span class="o">=</span> <span class="n">deltas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">std_pct_mean</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Discard large outliers</span>
                    <span class="n">z_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">zscore</span><span class="p">(</span><span class="n">deltas</span><span class="p">))</span>
                    <span class="n">deltas_pruned</span> <span class="o">=</span> <span class="n">deltas</span><span class="p">[</span><span class="n">z_scores</span> <span class="o">&lt;</span> <span class="mf">1.4</span><span class="p">]</span>
                    <span class="c1"># Discard small deltas</span>
                    <span class="n">deltas_pruned</span> <span class="o">=</span> <span class="n">deltas_pruned</span><span class="p">[</span><span class="n">deltas_pruned</span> <span class="o">&gt;</span> <span class="mf">10.0</span><span class="p">]</span>

                    <span class="n">std_pct_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">deltas</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">deltas</span><span class="p">)</span>
                    <span class="n">interval_days</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">deltas_pruned</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- interval_days:&quot;</span><span class="p">,</span> <span class="n">interval_days</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">std_pct_mean</span> <span class="o">&lt;</span> <span class="mf">0.68</span><span class="p">:</span>
                    <span class="n">tol</span> <span class="o">=</span> <span class="mi">20</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">interval_days</span><span class="o">-</span><span class="mi">365</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
                        <span class="n">interval</span> <span class="o">=</span> <span class="s1">&#39;ANNUAL&#39;</span>
                    <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">interval_days</span><span class="o">-</span><span class="mi">182</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
                        <span class="n">interval</span> <span class="o">=</span> <span class="s1">&#39;HALF&#39;</span>
                    <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">interval_days</span><span class="o">-</span><span class="mi">91</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
                        <span class="n">interval</span> <span class="o">=</span> <span class="s1">&#39;QUART&#39;</span>
                    <span class="k">if</span> <span class="n">interval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">interval_str_to_days</span><span class="p">[</span><span class="n">interval</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- insufficient data in earnings_dates, analysing financials columns&quot;</span><span class="p">)</span>

        <span class="n">tbl_bs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_quarterly_balance_sheet</span><span class="p">(</span><span class="n">refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">tbl_fi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_quarterly_income_stmt</span><span class="p">(</span><span class="n">refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">tbl_cf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_quarterly_cashflow</span><span class="p">(</span><span class="n">refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">refresh</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tbl_bs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tbl_bs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_quarterly_balance_sheet</span><span class="p">(</span><span class="n">refresh</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tbl_fi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tbl_fi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_quarterly_income_stmt</span><span class="p">(</span><span class="n">refresh</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tbl_cf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tbl_cf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_quarterly_cashflow</span><span class="p">(</span><span class="n">refresh</span><span class="p">)</span>
        <span class="n">tbl_bs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prune_yf_financial_df</span><span class="p">(</span><span class="n">tbl_bs</span><span class="p">)</span>
        <span class="n">tbl_fi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prune_yf_financial_df</span><span class="p">(</span><span class="n">tbl_fi</span><span class="p">)</span>
        <span class="n">tbl_cf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prune_yf_financial_df</span><span class="p">(</span><span class="n">tbl_cf</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">with_report</span><span class="p">:</span>
            <span class="c1"># Expect all 3x financials present</span>
            <span class="k">if</span> <span class="n">tbl_bs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">tbl_bs</span><span class="o">.</span><span class="n">empty</span> <span class="ow">or</span> <span class="n">tbl_fi</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">tbl_fi</span><span class="o">.</span><span class="n">empty</span> <span class="ow">or</span> <span class="n">tbl_cf</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">tbl_cf</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="c1"># Cannot be sure, but can estimate from any present table</span>
                <span class="k">if</span> <span class="n">tbl_bs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tbl_bs</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="n">tbl</span> <span class="o">=</span> <span class="n">tbl_bs</span>
                <span class="k">elif</span> <span class="n">tbl_fi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tbl_fi</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="n">tbl</span> <span class="o">=</span> <span class="n">tbl_fi</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tbl</span> <span class="o">=</span> <span class="n">tbl_cf</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tbl</span> <span class="o">=</span> <span class="n">tbl_bs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use whichever is available with most columns</span>
            <span class="n">tbl</span> <span class="o">=</span> <span class="n">tbl_bs</span>
            <span class="k">if</span> <span class="n">tbl_fi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl_fi</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                <span class="n">tbl</span> <span class="o">=</span> <span class="n">tbl_fi</span>
            <span class="k">if</span> <span class="n">tbl_cf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl_cf</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                <span class="n">tbl</span> <span class="o">=</span> <span class="n">tbl_cf</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- tbl:&quot;</span><span class="p">)</span> <span class="p">;</span> <span class="nb">print</span><span class="p">(</span><span class="n">tbl</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">tbl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tbl</span><span class="o">.</span><span class="n">empty</span> <span class="ow">and</span> <span class="n">tbl</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_interval_from_table</span><span class="p">(</span><span class="n">tbl</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">inference_successful</span><span class="p">:</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">TimedeltaEstimate</span><span class="p">(</span><span class="n">interval_str_to_days</span><span class="p">[</span><span class="s1">&#39;HALF&#39;</span><span class="p">],</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Confidence</span><span class="o">.</span><span class="n">Medium</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">interval</span>

<div class="viewcode-block" id="FinancialsManager.get_earnings_dates">
<a class="viewcode-back" href="../../yfinance_cache.html#yfinance_cache.yfc_financials_manager.FinancialsManager.get_earnings_dates">[docs]</a>
    <span class="k">def</span> <span class="nf">get_earnings_dates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clean</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">start_dt</span><span class="p">,</span> <span class="n">start</span> <span class="o">=</span> <span class="n">yfcu</span><span class="o">.</span><span class="n">ProcessUserDt</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tzName</span><span class="p">)</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckDateStrict</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="s1">&#39;start&#39;</span><span class="p">)</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckBool</span><span class="p">(</span><span class="n">refresh</span><span class="p">,</span> <span class="s1">&#39;refresh&#39;</span><span class="p">)</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckBool</span><span class="p">(</span><span class="n">clean</span><span class="p">,</span> <span class="s1">&#39;clean&#39;</span><span class="p">)</span>

        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># debug = True</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;get_earnings_dates(start=</span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2">, refresh=</span><span class="si">{</span><span class="n">refresh</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">dt_now</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tzName</span><span class="p">)</span>

        <span class="n">last_fetch</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_earnings_dates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">yfcm</span><span class="o">.</span><span class="n">IsDatumCached</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;earnings_dates&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- retrieving earnings dates from cache&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_earnings_dates</span><span class="p">,</span> <span class="n">md</span> <span class="o">=</span> <span class="n">yfcm</span><span class="o">.</span><span class="n">ReadCacheDatum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;earnings_dates&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">md</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">md</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_earnings_dates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Fine, just means last call failed to get earnings_dates</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;LastFetch&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">md</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;f</span><span class="si">{self.ticker}</span><span class="s2">: Why earnings_dates metadata missing &#39;LastFetch&#39;?&quot;</span><span class="p">)</span>
                        <span class="n">fp</span> <span class="o">=</span> <span class="n">yfcm</span><span class="o">.</span><span class="n">GetFilepath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;earnings_dates&quot;</span><span class="p">)</span>
                        <span class="n">last_fetch</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span><span class="o">.</span><span class="n">astimezone</span><span class="p">()</span>
                        <span class="n">md</span><span class="p">[</span><span class="s1">&#39;LastFetch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_fetch</span>
                        <span class="n">yfcm</span><span class="o">.</span><span class="n">WriteCacheMetadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;earnings_dates&quot;</span><span class="p">,</span> <span class="s1">&#39;LastFetch&#39;</span><span class="p">,</span> <span class="n">md</span><span class="p">[</span><span class="s1">&#39;LastFetch&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_earnings_dates</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_earnings_dates</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">edf_clean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_earnings_dates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_earnings_dates</span><span class="p">,</span> <span class="n">refresh</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">edf_clean</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_earnings_dates</span><span class="p">):</span>
                            <span class="c1"># This is ok, because since the last fetch, the calendar can be updated which then allows resolving a </span>
                            <span class="c1"># near-duplication in earnings_dates.</span>
                            <span class="n">yfcm</span><span class="o">.</span><span class="n">StoreCacheDatum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;earnings_dates&quot;</span><span class="p">,</span> <span class="n">edf_clean</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_earnings_dates</span> <span class="o">=</span> <span class="n">edf_clean</span>

        <span class="n">last_fetch</span> <span class="o">=</span> <span class="n">yfcm</span><span class="o">.</span><span class="n">ReadCacheMetadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;earnings_dates&quot;</span><span class="p">,</span> <span class="s2">&quot;LastFetch&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- last_fetch =&quot;</span><span class="p">,</span> <span class="n">last_fetch</span><span class="p">)</span>

        <span class="c1"># Ensure column &#39;Date confirmed?&#39; is present, and update with calendar</span>
        <span class="n">df_modified</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_earnings_dates</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;Date confirmed?&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_earnings_dates</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_earnings_dates</span><span class="p">[</span><span class="s1">&#39;Date confirmed?&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">df_modified</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">cal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_calendar</span><span class="p">(</span><span class="n">refresh</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cal</span><span class="p">[</span><span class="s1">&#39;Earnings Date&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">cal</span><span class="p">[</span><span class="s1">&#39;Earnings Date&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_earnings_dates</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">):</span>
                        <span class="c1"># Assume same release</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_earnings_dates</span><span class="p">[</span><span class="s1">&#39;Date confirmed?&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">]:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_earnings_dates</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="s1">&#39;Date confirmed?&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">df_modified</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">break</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- dt:&quot;</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- edf:&quot;</span><span class="p">)</span> <span class="p">;</span> <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_earnings_dates</span><span class="p">)</span>
                            <span class="k">raise</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">refresh</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">df_modified</span><span class="p">:</span>
                <span class="n">yfcm</span><span class="o">.</span><span class="n">StoreCacheDatum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;earnings_dates&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_earnings_dates</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;get_earnings_dates() returning&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_earnings_dates</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">start_dt</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_earnings_dates</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_earnings_dates</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">start_dt</span><span class="p">:]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_earnings_dates</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Limit spam:</span>
        <span class="n">yf_start_date</span> <span class="o">=</span> <span class="n">yfcm</span><span class="o">.</span><span class="n">ReadCacheMetadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s1">&#39;earnings_dates&#39;</span><span class="p">,</span> <span class="s1">&#39;start_date&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- yf_start_date =&quot;</span><span class="p">,</span> <span class="n">yf_start_date</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">last_fetch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">last_fetch</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s1">&#39;14d&#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">dt_now</span><span class="p">:</span>
                <span class="c1"># Avoid spamming Yahoo for data it doesn&#39;t have (empty earnings_dates).</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_earnings_dates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Already attempted a fetch recently, Yahoo has nothing.</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;avoiding refetch&quot;</span><span class="p">)</span>
                    <span class="n">refresh</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># Avoid spamming Yahoo for new future dates</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_earnings_dates</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">yf_start_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># Cache has all previous earnings dates</span>
                        <span class="n">refresh</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">elif</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_earnings_dates</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">refresh</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- refresh =&quot;</span><span class="p">,</span> <span class="n">refresh</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">refresh</span><span class="p">:</span>
            <span class="n">ei</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_earnings_interval</span><span class="p">(</span><span class="n">with_report</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ei</span><span class="p">,</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">TimedeltaEstimate</span><span class="p">):</span>
                <span class="c1"># Don&#39;t care about confidence</span>
                <span class="n">ei</span> <span class="o">=</span> <span class="n">ei</span><span class="o">.</span><span class="n">td</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ei</span><span class="p">,</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">TimedeltaRangeEstimate</span><span class="p">):</span>
                <span class="n">ei</span> <span class="o">=</span> <span class="n">mean</span><span class="p">([</span><span class="n">ei</span><span class="o">.</span><span class="n">td1</span><span class="p">,</span> <span class="n">ei</span><span class="o">.</span><span class="n">td2</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ei</span><span class="p">,</span> <span class="p">(</span><span class="n">yfcd</span><span class="o">.</span><span class="n">ComparableRelativedelta</span><span class="p">,</span> <span class="n">relativedelta</span><span class="p">)):</span>
                <span class="c1"># Convert to normal Timedelta, don&#39;t need 100% precision</span>
                <span class="k">if</span> <span class="n">ei</span><span class="o">.</span><span class="n">months</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">ei</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s1">&#39;91d&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">ei</span><span class="o">.</span><span class="n">months</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
                    <span class="n">ei</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s1">&#39;182d&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">ei</span><span class="o">.</span><span class="n">months</span> <span class="o">==</span> <span class="mi">12</span> <span class="ow">or</span> <span class="n">ei</span><span class="o">.</span><span class="n">years</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># ei = pd.Timedelta(&#39;365d&#39;)</span>
                    <span class="c1"># Don&#39;t believe it</span>
                    <span class="n">ei</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s1">&#39;182d&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">ei</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">ei</span><span class="p">))</span>

            <span class="n">lookahead_dt</span> <span class="o">=</span> <span class="n">dt_now</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s1">&#39;365d&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- ei =&quot;</span><span class="p">,</span> <span class="n">ei</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- lookahead_dt =&quot;</span><span class="p">,</span> <span class="n">lookahead_dt</span><span class="p">)</span>

            <span class="n">next_rd</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_earnings_dates</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">start_dt</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_earnings_dates</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">yf_start_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">total_refetch</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">n_intervals_to_fetch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="mf">1.25</span><span class="o">*</span><span class="p">(</span><span class="n">lookahead_dt</span> <span class="o">-</span> <span class="n">start_dt</span><span class="p">)</span> <span class="o">/</span> <span class="n">ei</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">total_refetch</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_earnings_dates</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">f_na</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Reported EPS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="n">f_nna</span> <span class="o">=</span> <span class="o">~</span><span class="n">f_na</span>
                <span class="n">f_expired</span> <span class="o">=</span> <span class="n">f_na</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">dt_now</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">dt_now</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;FetchDate&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s1">&#39;7d&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- n =&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

                <span class="n">n_intervals_missing_after</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">Decimal</span><span class="p">((</span><span class="n">lookahead_dt</span> <span class="o">-</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">ei</span><span class="p">)))</span>
                <span class="n">any_expired</span> <span class="o">=</span> <span class="n">f_expired</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- n_intervals_missing_after =&quot;</span><span class="p">,</span> <span class="n">n_intervals_missing_after</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- any_expired =&quot;</span><span class="p">,</span> <span class="n">any_expired</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">any_expired</span><span class="p">:</span>
                    <span class="c1"># ToDo: avoid refetching if next earnings after last fetch is (far) in future.</span>
                    <span class="k">if</span> <span class="n">f_nna</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- checking against release dates ...&quot;</span><span class="p">)</span>
                        <span class="n">rds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_release_dates</span><span class="p">(</span><span class="n">yfcd</span><span class="o">.</span><span class="n">ReportingPeriod</span><span class="o">.</span><span class="n">Interim</span><span class="p">,</span> <span class="n">as_df</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">rds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">latest_certain_dt</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">f_nna</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rds</span><span class="p">)):</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">in_future</span> <span class="o">=</span> <span class="n">rds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">release_date</span> <span class="o">&gt;</span> <span class="n">latest_certain_dt</span>
                                <span class="k">except</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">AmbiguousComparisonException</span><span class="p">:</span>
                                    <span class="n">p</span> <span class="o">=</span> <span class="n">rds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">release_date</span><span class="o">.</span><span class="n">prob_gt</span><span class="p">(</span><span class="n">latest_certain_dt</span><span class="p">)</span>
                                    <span class="n">in_future</span> <span class="o">=</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="mf">0.9</span>
                                <span class="k">if</span> <span class="n">in_future</span><span class="p">:</span>
                                    <span class="n">next_rd</span> <span class="o">=</span> <span class="n">rds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                                    <span class="k">break</span>
                            <span class="k">try</span><span class="p">:</span> 
                                <span class="n">next_rd_in_future</span> <span class="o">=</span> <span class="n">next_rd</span><span class="o">.</span><span class="n">release_date</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">d_today</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">))</span>
                            <span class="k">except</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">AmbiguousComparisonException</span><span class="p">:</span>
                                <span class="n">p</span> <span class="o">=</span> <span class="n">next_rd</span><span class="o">.</span><span class="n">release_date</span><span class="o">.</span><span class="n">prob_gt</span><span class="p">(</span><span class="n">d_today</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">))</span>
                                <span class="n">next_rd_in_future</span> <span class="o">=</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="mf">0.9</span>
                            <span class="k">if</span> <span class="n">next_rd_in_future</span><span class="p">:</span>
                                <span class="c1"># Avoid fetching while far from next earnings release</span>
                                <span class="n">n_intervals_missing_after</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">n_intervals_to_fetch</span> <span class="o">=</span> <span class="n">n_intervals_missing_after</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">earliest_expired_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">f_expired</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">n_intervals_expired</span> <span class="o">=</span> <span class="n">earliest_expired_idx</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">n_intervals_to_fetch</span> <span class="o">=</span> <span class="n">n_intervals_expired</span> <span class="o">+</span> <span class="n">n_intervals_missing_after</span>

            <span class="k">if</span> <span class="n">n_intervals_to_fetch</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Ensure always fetching more than necessary</span>
                <span class="n">n_intervals_to_fetch</span> <span class="o">+=</span> <span class="mi">8</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- n_intervals_to_fetch =&quot;</span><span class="p">,</span> <span class="n">n_intervals_to_fetch</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">n_intervals_to_fetch</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- total_refetch =&quot;</span><span class="p">,</span> <span class="n">total_refetch</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">new_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_earnings_dates</span><span class="p">(</span><span class="n">n_intervals_to_fetch</span><span class="p">,</span> <span class="n">refresh</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- self._earnings_dates:&quot;</span><span class="p">)</span> <span class="p">;</span> <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_earnings_dates</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- start:&quot;</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- yf_start_date:&quot;</span><span class="p">,</span> <span class="n">yf_start_date</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- last_fetch:&quot;</span><span class="p">,</span> <span class="n">last_fetch</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- ei:&quot;</span><span class="p">,</span> <span class="n">ei</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- next_rd:&quot;</span><span class="p">,</span> <span class="n">next_rd</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- n_intervals_to_fetch:&quot;</span><span class="p">,</span> <span class="n">n_intervals_to_fetch</span><span class="p">)</span>
                    <span class="k">raise</span>
                <span class="c1"># Sanity test:</span>
                <span class="k">if</span> <span class="n">new_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">new_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="n">edf_clean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_earnings_dates</span><span class="p">(</span><span class="n">new_df</span><span class="p">,</span> <span class="n">refresh</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">edf_clean</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_df</span><span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- edf:&quot;</span><span class="p">)</span> <span class="p">;</span> <span class="nb">print</span><span class="p">(</span><span class="n">new_df</span><span class="p">[[</span><span class="s1">&#39;EPS Estimate&#39;</span><span class="p">,</span> <span class="s1">&#39;Reported EPS&#39;</span><span class="p">,</span> <span class="s1">&#39;FetchDate&#39;</span><span class="p">]])</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- after clean:&quot;</span><span class="p">)</span> <span class="p">;</span> <span class="nb">print</span><span class="p">(</span><span class="n">edf_clean</span><span class="p">[[</span><span class="s1">&#39;EPS Estimate&#39;</span><span class="p">,</span> <span class="s1">&#39;Reported EPS&#39;</span><span class="p">,</span> <span class="s1">&#39;FetchDate&#39;</span><span class="p">]])</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s1">: We literally just fetched earnings dates, why not cleaned?&#39;</span><span class="p">)</span>
                        <span class="n">yfcm</span><span class="o">.</span><span class="n">StoreCacheDatum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;earnings_dates&quot;</span><span class="p">,</span> <span class="n">edf_clean</span><span class="p">)</span>

                <span class="n">yfcm</span><span class="o">.</span><span class="n">WriteCacheMetadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;earnings_dates&quot;</span><span class="p">,</span> <span class="s1">&#39;LastFetch&#39;</span><span class="p">,</span> <span class="n">dt_now</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- new_df:&quot;</span><span class="p">)</span> <span class="p">;</span> <span class="nb">print</span><span class="p">(</span><span class="n">new_df</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">new_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">new_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_earnings_dates</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">df_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_earnings_dates</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_earnings_dates</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">new_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">14</span><span class="p">))]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">df_old</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                            <span class="n">new_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">new_df</span><span class="p">,</span> <span class="n">df_old</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- new_df:&quot;</span><span class="p">)</span> <span class="p">;</span> <span class="nb">print</span><span class="p">(</span><span class="n">new_df</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_earnings_dates</span> <span class="o">=</span> <span class="n">new_df</span>
                    <span class="n">df_modified</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">df_modified</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_earnings_dates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">yfcm</span><span class="o">.</span><span class="n">StoreCacheDatum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;earnings_dates&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">yfcm</span><span class="o">.</span><span class="n">StoreCacheDatum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;earnings_dates&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_earnings_dates</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;get_earnings_dates() returning&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_earnings_dates</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">start_dt</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_earnings_dates</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_earnings_dates</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">start_dt</span><span class="p">:]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_earnings_dates</span>
            <span class="k">if</span> <span class="n">clean</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;FetchDate&quot;</span><span class="p">,</span> <span class="s2">&quot;Date confirmed?&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>


    <span class="k">def</span> <span class="nf">_clean_earnings_dates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edf</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">edf</span> <span class="o">=</span> <span class="n">edf</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># In rare cases, Yahoo has duplicated a date with different company name.</span>
        <span class="c1"># Retain the row with most data.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edf</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">edf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">edf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edf</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">edf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">edf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">():</span>
                    <span class="c1"># Discard row i-1</span>
                    <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Discard row i</span>
                    <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">edf</span> <span class="o">=</span> <span class="n">edf</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edf</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">edf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">edf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">):</span>
                <span class="c1"># One must go</span>
                <span class="k">if</span> <span class="n">edf</span><span class="p">[</span><span class="s1">&#39;FetchDate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">edf</span><span class="p">[</span><span class="s1">&#39;FetchDate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">edf</span> <span class="o">=</span> <span class="n">edf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">edf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">edf</span><span class="p">[</span><span class="s1">&#39;FetchDate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">edf</span><span class="p">[</span><span class="s1">&#39;FetchDate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">edf</span> <span class="o">=</span> <span class="n">edf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">edf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_calendar</span><span class="p">(</span><span class="n">refresh</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">cal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># print(edf.iloc[i:i+2])</span>
                        <span class="c1"># raise Exception(&#39;Review how to handle 2x almost-equal earnings dates.&#39;)</span>
                        <span class="c1"># pass  # Can&#39;t do anything with certainty</span>
                        <span class="c1"># Keep earlier</span>
                        <span class="k">if</span> <span class="n">edf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">edf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">edf</span> <span class="o">=</span> <span class="n">edf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">edf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">edf</span> <span class="o">=</span> <span class="n">edf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">edf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Cross-check against calendar</span>
                        <span class="n">dts</span> <span class="o">=</span> <span class="n">cal</span><span class="p">[</span><span class="s1">&#39;Earnings Date&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">dts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="n">edf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">(),</span> <span class="n">edf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()]:</span>
                            <span class="k">if</span> <span class="n">edf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">==</span> <span class="n">dts</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                                <span class="n">edf</span> <span class="o">=</span> <span class="n">edf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">edf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">edf</span> <span class="o">=</span> <span class="n">edf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">edf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># print(edf.iloc[i:i+2])</span>
                            <span class="c1"># raise Exception(&#39;Review how to handle 2x almost-equal earnings dates.&#39;)</span>
                            <span class="c1"># pass  # Can&#39;t do anything with certainty</span>
                            <span class="c1"># Keep earlier</span>
                            <span class="k">if</span> <span class="n">edf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">edf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span>
                                <span class="n">edf</span> <span class="o">=</span> <span class="n">edf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">edf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">edf</span> <span class="o">=</span> <span class="n">edf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">edf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">edf</span>

    <span class="k">def</span> <span class="nf">_fetch_earnings_dates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckInt</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="s2">&quot;limit&quot;</span><span class="p">)</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckBool</span><span class="p">(</span><span class="n">refresh</span><span class="p">,</span> <span class="s2">&quot;refresh&quot;</span><span class="p">)</span>
        
        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># debug = True</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: _fetch_earnings_dates(limit=</span><span class="si">{</span><span class="n">limit</span><span class="si">}</span><span class="s2">, refresh=</span><span class="si">{</span><span class="n">refresh</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">print_fetches</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: fetching </span><span class="si">{</span><span class="n">limit</span><span class="si">}</span><span class="s2"> earnings dates&quot;</span><span class="p">)</span>

        <span class="n">repeat_fetch</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">get_earnings_dates</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;Earnings Date&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="c1"># Rarely, Yahoo returns a completely different table for earnings dates.</span>
                <span class="c1"># Try again.</span>
                <span class="n">repeat_fetch</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="k">if</span> <span class="n">repeat_fetch</span><span class="p">:</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># Avoid cache this time, but add sleeps to maintain rate-limiting</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">)</span><span class="o">.</span><span class="n">get_earnings_dates</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- Yahoo returned None&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;FetchDate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tzName</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- detected earnings_dates start at&quot;</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
            <span class="n">yfcm</span><span class="o">.</span><span class="n">WriteCacheMetadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s1">&#39;earnings_dates&#39;</span><span class="p">,</span> <span class="s1">&#39;start_date&#39;</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>

        <span class="n">cal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_calendar</span><span class="p">(</span><span class="n">refresh</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Date confirmed?&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">cal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cal</span><span class="p">[</span><span class="s1">&#39;Earnings Date&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">cal</span><span class="p">[</span><span class="s1">&#39;Earnings Date&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">):</span>
                    <span class="c1"># Assume same release</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="s1">&#39;Date confirmed?&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_earnings_dates</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">refresh</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span>

<div class="viewcode-block" id="FinancialsManager.get_calendar">
<a class="viewcode-back" href="../../yfinance_cache.html#yfinance_cache.yfc_financials_manager.FinancialsManager.get_calendar">[docs]</a>
    <span class="k">def</span> <span class="nf">get_calendar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckBool</span><span class="p">(</span><span class="n">refresh</span><span class="p">,</span> <span class="s1">&#39;refresh&#39;</span><span class="p">)</span>

        <span class="n">max_age</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">yfcm</span><span class="o">.</span><span class="n">_option_manager</span><span class="o">.</span><span class="n">max_ages</span><span class="o">.</span><span class="n">calendar</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calendar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">yfcm</span><span class="o">.</span><span class="n">IsDatumCached</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;calendar&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_calendar</span> <span class="o">=</span> <span class="n">yfcm</span><span class="o">.</span><span class="n">ReadCacheDatum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;calendar&quot;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_calendar_clean</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_calendar</span><span class="p">)</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calendar_clean</span><span class="p">[</span><span class="s1">&#39;FetchDate&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_calendar_clean</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_calendar_clean</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_calendar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_calendar</span><span class="p">[</span><span class="s2">&quot;FetchDate&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">max_age</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calendar_clean</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">refresh</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calendar_clean</span>

        <span class="k">if</span> <span class="n">print_fetches</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: Fetching calendar (last fetch = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_calendar</span><span class="p">[</span><span class="s1">&#39;FetchDate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">calendar</span>
        <span class="n">c</span><span class="p">[</span><span class="s2">&quot;FetchDate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calendar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Check calendar is not downgrade</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_calendar</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># More than 1 element disappeared</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;When fetching new calendar, data has disappeared</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;- cached calendar:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_calendar</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;- new calendar:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">yfcm</span><span class="o">.</span><span class="n">StoreCacheDatum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;calendar&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calendar</span> <span class="o">=</span> <span class="n">c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calendar_clean</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_calendar</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calendar_clean</span><span class="p">[</span><span class="s1">&#39;FetchDate&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_calendar_clean</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_calendar_clean</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calendar_clean</span></div>


    <span class="k">def</span> <span class="nf">_get_calendar_dates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckBool</span><span class="p">(</span><span class="n">refresh</span><span class="p">,</span> <span class="s1">&#39;refresh&#39;</span><span class="p">)</span>

        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># debug = True</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_get_calendar_dates(refresh=</span><span class="si">{</span><span class="n">refresh</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">cal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_calendar</span><span class="p">(</span><span class="n">refresh</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cal</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">cal</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- cal = </span><span class="si">{</span><span class="n">cal</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">cal_release_dates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cal_release_dates</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">last</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">cal</span><span class="p">[</span><span class="s2">&quot;Earnings Date&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">last</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">last</span> <span class="o">=</span> <span class="n">d</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="n">d</span> <span class="o">-</span> <span class="n">last</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- diff = </span><span class="si">{</span><span class="n">diff</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">diff</span> <span class="o">&lt;=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
                    <span class="c1"># Looks like a date range so tag last-added date as estimate. And change data to be middle of range</span>
                    <span class="n">last</span> <span class="o">=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">DateRange</span><span class="p">(</span><span class="n">last</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
                    <span class="n">cal_release_dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last</span><span class="p">)</span>
                    <span class="n">last</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- cal_release_dates:&quot;</span><span class="p">)</span> <span class="p">;</span> <span class="nb">print</span><span class="p">(</span><span class="n">cal_release_dates</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- diff =&quot;</span><span class="p">,</span> <span class="n">diff</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Implement/rejig this execution path (tkr=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">last</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cal_release_dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- cal_release_dates = </span><span class="si">{</span><span class="n">cal_release_dates</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cal_release_dates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- cal_release_dates: EMPTY&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- cal_release_dates:&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">cal_release_dates</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cal_release_dates</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, ValueRaider@protonmail.com.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>