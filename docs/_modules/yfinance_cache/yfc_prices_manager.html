<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>yfinance_cache.yfc_prices_manager &mdash; yfinance-cache 0.6.6 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=e059a73d"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            yfinance-cache
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">yfinance_cache</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">yfinance-cache</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">yfinance_cache.yfc_prices_manager</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for yfinance_cache.yfc_prices_manager</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">yfc_cache_manager</span> <span class="k">as</span> <span class="n">yfcm</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">yfc_dat</span> <span class="k">as</span> <span class="n">yfcd</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">yfc_time</span> <span class="k">as</span> <span class="n">yfct</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">yfc_utils</span> <span class="k">as</span> <span class="n">yfcu</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">yfc_logging</span> <span class="k">as</span> <span class="n">yfcl</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pytz</span>
<span class="c1"># import itertools</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">ndimage</span> <span class="k">as</span> <span class="n">_ndimage</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span> <span class="nn">dateutil</span>
<span class="kn">from</span> <span class="nn">zoneinfo</span> <span class="kn">import</span> <span class="n">ZoneInfo</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="kn">import</span> <span class="nn">click</span>
<span class="kn">import</span> <span class="nn">logging</span>


<span class="c1"># TODOs:</span>
<span class="c1"># - when filling a missing interval with NaNs, try to reconstruct first</span>


<div class="viewcode-block" id="HistoriesManager">
<a class="viewcode-back" href="../../yfinance_cache.html#yfinance_cache.yfc_prices_manager.HistoriesManager">[docs]</a>
<span class="k">class</span> <span class="nc">HistoriesManager</span><span class="p">:</span>
    <span class="c1"># Intended as single to class to ensure:</span>
    <span class="c1"># - only one History() object exists for each timescale/data type</span>
    <span class="c1"># - different History() objects and communicate</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">tzName</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">proxy</span><span class="p">):</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckStr</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;ticker&quot;</span><span class="p">)</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckStr</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="s2">&quot;exchange&quot;</span><span class="p">)</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckStr</span><span class="p">(</span><span class="n">tzName</span><span class="p">,</span> <span class="s2">&quot;tzName&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">ticker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tzName</span> <span class="o">=</span> <span class="n">tzName</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">histories</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span> <span class="o">=</span> <span class="n">proxy</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Fix OS error &quot;Too many open files&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="HistoriesManager.GetHistory">
<a class="viewcode-back" href="../../yfinance_cache.html#yfinance_cache.yfc_prices_manager.HistoriesManager.GetHistory">[docs]</a>
    <span class="k">def</span> <span class="nf">GetHistory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">permitted_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">yfcd</span><span class="o">.</span><span class="n">intervalToString</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;Events&quot;</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">permitted_keys</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;key=&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; is invalid, must be one of: </span><span class="si">{</span><span class="n">permitted_keys</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">histories</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">intervalToString</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">histories</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">PriceHistory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tzName</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="p">,</span> <span class="n">repair</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">histories</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">PriceHistory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tzName</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="p">,</span> <span class="n">repair</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;Events&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">histories</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">EventsHistory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tzName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not implemented code path for key=&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">histories</span><span class="p">[</span><span class="n">key</span><span class="p">]</span></div>


<div class="viewcode-block" id="HistoriesManager.LogEvent">
<a class="viewcode-back" href="../../yfinance_cache.html#yfinance_cache.yfc_prices_manager.HistoriesManager.LogEvent">[docs]</a>
    <span class="k">def</span> <span class="nf">LogEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsLoggingEnabled</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">():</span>
                <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">level</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="s2">&quot;info&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;&#39;level&#39; must be str &#39;debug&#39; or &#39;info&#39;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">GetLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">)</span>

        <span class="n">full_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;debug&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">full_msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">full_msg</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="EventsHistory">
<a class="viewcode-back" href="../../yfinance_cache.html#yfinance_cache.yfc_prices_manager.EventsHistory">[docs]</a>
<span class="k">class</span> <span class="nc">EventsHistory</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manager</span><span class="p">,</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">tzName</span><span class="p">,</span> <span class="n">proxy</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="n">HistoriesManager</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;manager&#39; must be HistoriesManager not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">manager</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckStr</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;ticker&quot;</span><span class="p">)</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckStr</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="s2">&quot;exchange&quot;</span><span class="p">)</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckStr</span><span class="p">(</span><span class="n">tzName</span><span class="p">,</span> <span class="s2">&quot;tzName&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="n">manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">ticker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tzName</span> <span class="o">=</span> <span class="n">tzName</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span> <span class="o">=</span> <span class="n">proxy</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tz</span> <span class="o">=</span> <span class="n">ZoneInfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tzName</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">yfcm</span><span class="o">.</span><span class="n">IsDatumCached</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;dividends&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">divs</span> <span class="o">=</span> <span class="n">yfcm</span><span class="o">.</span><span class="n">ReadCacheDatum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;dividends&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">divs</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">yfcm</span><span class="o">.</span><span class="n">IsDatumCached</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;splits&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">splits</span> <span class="o">=</span> <span class="n">yfcm</span><span class="o">.</span><span class="n">ReadCacheDatum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;splits&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">splits</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="EventsHistory.GetDivs">
<a class="viewcode-back" href="../../yfinance_cache.html#yfinance_cache.yfc_prices_manager.EventsHistory.GetDivs">[docs]</a>
    <span class="k">def</span> <span class="nf">GetDivs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckDateStrict</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="s2">&quot;start&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckDateStrict</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">divs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">divs</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">end</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">divs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">tz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">divs</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tz</span>
        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="n">tz</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">end</span><span class="p">)</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="n">tz</span><span class="p">)</span>

        <span class="n">td_1d</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">slc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">divs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">start</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">slc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">divs</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="n">end</span><span class="o">-</span><span class="n">td_1d</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">slc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">divs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="o">-</span><span class="n">td_1d</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">slc</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">slc</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>


<div class="viewcode-block" id="EventsHistory.GetDivsFetchedSince">
<a class="viewcode-back" href="../../yfinance_cache.html#yfinance_cache.yfc_prices_manager.EventsHistory.GetDivsFetchedSince">[docs]</a>
    <span class="k">def</span> <span class="nf">GetDivsFetchedSince</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckDatetime</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="s2">&quot;dt&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">divs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">divs</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">divs</span><span class="p">[</span><span class="s2">&quot;FetchDate&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">dt</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">divs</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="EventsHistory.GetSplits">
<a class="viewcode-back" href="../../yfinance_cache.html#yfinance_cache.yfc_prices_manager.EventsHistory.GetSplits">[docs]</a>
    <span class="k">def</span> <span class="nf">GetSplits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckDateStrict</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="s2">&quot;start&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckDateStrict</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">splits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">splits</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splits</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tz</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">end</span><span class="p">)</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splits</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tz</span><span class="p">)</span>
            <span class="n">td_1d</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">slc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splits</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">start</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">slc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splits</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="o">-</span><span class="n">td_1d</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">slc</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">slc</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="EventsHistory.GetSplitsFetchedSince">
<a class="viewcode-back" href="../../yfinance_cache.html#yfinance_cache.yfc_prices_manager.EventsHistory.GetSplitsFetchedSince">[docs]</a>
    <span class="k">def</span> <span class="nf">GetSplitsFetchedSince</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckDatetime</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="s2">&quot;dt&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">splits</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">splits</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splits</span><span class="p">[</span><span class="s2">&quot;FetchDate&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">dt</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splits</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="EventsHistory.UpdateSplits">
<a class="viewcode-back" href="../../yfinance_cache.html#yfinance_cache.yfc_prices_manager.EventsHistory.UpdateSplits">[docs]</a>
    <span class="k">def</span> <span class="nf">UpdateSplits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">splits_df</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">splits_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceEnter</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PM: UpdateSplits(</span><span class="si">{</span><span class="n">splits_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceEnter</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PM: UpdateSplits(n=</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">self_splits_modified</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># debug = True</span>

        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckDataFrame</span><span class="p">(</span><span class="n">splits_df</span><span class="p">,</span> <span class="s2">&quot;splits_df&quot;</span><span class="p">)</span>
        <span class="n">splits_df</span> <span class="o">=</span> <span class="n">splits_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">splits_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">expected_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Stock Splits&quot;</span><span class="p">,</span> <span class="s2">&quot;FetchDate&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">expected_cols</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">splits_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;UpdateSplits() &#39;splits_df&#39; columns must contain: &#39;</span><span class="si">{expected_cols}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

            <span class="c1"># Prepare &#39;splits_df&#39; for append</span>
            <span class="n">splits_df</span><span class="p">[</span><span class="s2">&quot;Superseded split&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">splits_df</span><span class="p">[</span><span class="s2">&quot;Superseded split FetchDate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>
            <span class="k">if</span> <span class="n">splits_df</span><span class="p">[</span><span class="s1">&#39;Superseded split FetchDate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">tz</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">splits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">splits_df</span><span class="p">[</span><span class="s1">&#39;Superseded split FetchDate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">splits_df</span><span class="p">[</span><span class="s1">&#39;Superseded split FetchDate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splits</span><span class="p">[</span><span class="s1">&#39;FetchDate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">tz</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">splits_df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="n">new_split</span> <span class="o">=</span> <span class="n">splits_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="s2">&quot;Stock Splits&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">splits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">splits</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="n">cached_split</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splits</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="s2">&quot;Stock Splits&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                        <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pre-existing stock-split @ </span><span class="si">{</span><span class="n">dt</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">cached_split</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">new_split</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">diff_pct</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">cached_split</span><span class="o">-</span><span class="n">new_split</span><span class="p">)</span><span class="o">/</span><span class="n">cached_split</span>
                    <span class="k">if</span> <span class="n">diff_pct</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>
                        <span class="c1"># tiny difference, easier to just keep old value</span>
                        <span class="n">splits_df</span> <span class="o">=</span> <span class="n">splits_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                            <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="s2">&quot;ignoring&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">splits_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="s2">&quot;Superseded split&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splits</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="s2">&quot;Stock Splits&quot;</span><span class="p">]</span>
                        <span class="n">splits_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="s2">&quot;Superseded split FetchDate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splits</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="s2">&quot;FetchDate&quot;</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">splits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splits</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
                        <span class="n">self_splits_modified</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                            <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="s2">&quot;supersede&quot;</span><span class="p">)</span>

            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Stock Splits&quot;</span><span class="p">,</span> <span class="s2">&quot;FetchDate&quot;</span><span class="p">,</span> <span class="s2">&quot;Superseded split&quot;</span><span class="p">,</span> <span class="s2">&quot;Superseded split FetchDate&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">splits_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">splits_pretty</span> <span class="o">=</span> <span class="n">splits_df</span><span class="p">[</span><span class="s2">&quot;Stock Splits&quot;</span><span class="p">]</span>
                <span class="n">splits_pretty</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">splits_pretty</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">LogEvent</span><span class="p">(</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="s2">&quot;SplitManager&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">splits_pretty</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> new splits: </span><span class="si">{</span><span class="n">splits_pretty</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">splits</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">splits</span> <span class="o">=</span> <span class="n">splits_df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">f_na</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splits</span><span class="p">[</span><span class="s1">&#39;Superseded split FetchDate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">f_na</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                        <span class="c1"># Drop column. It breaks concat, and anyway &#39;divs_df&#39; will restore it.</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">splits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splits</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Superseded split FetchDate&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">splits</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">splits</span><span class="p">,</span> <span class="n">splits_df</span><span class="p">[</span><span class="n">cols</span><span class="p">]],</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
                <span class="n">yfcm</span><span class="o">.</span><span class="n">StoreCacheDatum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;splits&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">splits</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">self_splits_modified</span><span class="p">:</span>
                <span class="n">yfcm</span><span class="o">.</span><span class="n">StoreCacheDatum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;splits&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">splits</span><span class="p">)</span>

        <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceExit</span><span class="p">(</span><span class="s2">&quot;UpdateSplits() returning&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="EventsHistory.UpdateDividends">
<a class="viewcode-back" href="../../yfinance_cache.html#yfinance_cache.yfc_prices_manager.EventsHistory.UpdateDividends">[docs]</a>
    <span class="k">def</span> <span class="nf">UpdateDividends</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">divs_df</span><span class="p">):</span>
        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># debug = True</span>

        <span class="n">n</span> <span class="o">=</span> <span class="n">divs_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceEnter</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PM: UpdateDividends(</span><span class="si">{</span><span class="n">divs_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceEnter</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PM: UpdateDividends(n=</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">self_divs_modified</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckDataFrame</span><span class="p">(</span><span class="n">divs_df</span><span class="p">,</span> <span class="s2">&quot;divs_df&quot;</span><span class="p">)</span>
        <span class="n">divs_df</span> <span class="o">=</span> <span class="n">divs_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">divs_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">expected_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Dividends&quot;</span><span class="p">,</span> <span class="s2">&quot;FetchDate&quot;</span><span class="p">,</span> <span class="s2">&quot;Close day before&quot;</span><span class="p">]</span>
            <span class="c1"># expected_cols = [&quot;Dividends&quot;, &quot;FetchDate&quot;, &quot;Close today&quot;]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">expected_cols</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">divs_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AddDividends() &#39;divs_df&#39; is missing column: &#39;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

            <span class="c1"># Prepare &#39;divs_df&#39; for append</span>
            <span class="n">divs_df</span><span class="p">[</span><span class="s2">&quot;Back Adj.&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">divs_df</span><span class="p">[</span><span class="s2">&quot;Superseded div&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">divs_df</span><span class="p">[</span><span class="s2">&quot;Superseded back adj.&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">divs_df</span><span class="p">[</span><span class="s2">&quot;Superseded div FetchDate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>
            <span class="k">if</span> <span class="n">divs_df</span><span class="p">[</span><span class="s1">&#39;Superseded div FetchDate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">tz</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">divs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">divs_df</span><span class="p">[</span><span class="s1">&#39;Superseded div FetchDate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">divs_df</span><span class="p">[</span><span class="s1">&#39;Superseded div FetchDate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">divs</span><span class="p">[</span><span class="s1">&#39;FetchDate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">tz</span><span class="p">)</span>
            <span class="n">divs_df_dts</span> <span class="o">=</span> <span class="n">divs_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">divs_df_dts</span><span class="p">:</span>
                <span class="n">new_div</span> <span class="o">=</span> <span class="n">divs_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="s2">&quot;Dividends&quot;</span><span class="p">]</span>

                <span class="n">close_before</span> <span class="o">=</span> <span class="n">divs_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="s2">&quot;Close day before&quot;</span><span class="p">]</span>
                <span class="c1"># adj = (close_before - new_div) / close_before</span>
                <span class="n">adj</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">new_div</span> <span class="o">/</span> <span class="n">close_before</span>
                <span class="c1"># # F = P2/(P2+D)</span>
                <span class="c1"># # http://marubozu.blogspot.com/2006/09/how-yahoo-calculates-adjusted-closing.html#c8038064975185708856</span>
                <span class="c1"># close_today = divs_df.loc[dt, &quot;Close today&quot;]</span>
                <span class="c1"># adj = close_today / (close_today + new_div)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">adj</span><span class="p">):</span>  <span class="c1"># todo: remove once confirm YFC bug-free</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">divs_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">])</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Back Adj. is NaN&quot;</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dt=&quot;</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;T=&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;divs_df:&quot;</span><span class="p">)</span> <span class="p">;</span> <span class="nb">print</span><span class="p">(</span><span class="n">divs_df</span><span class="p">)</span>
                    <span class="k">raise</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="n">fetch_dt</span> <span class="o">=</span> <span class="n">divs_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="s2">&quot;FetchDate&quot;</span><span class="p">]</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;new dividend: </span><span class="si">{</span><span class="n">new_div</span><span class="si">}</span><span class="s2"> @ </span><span class="si">{</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2"> adj=</span><span class="si">{</span><span class="n">adj</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> close_before=</span><span class="si">{</span><span class="n">close_before</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> fetch=</span><span class="si">{</span><span class="n">fetch_dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S%z&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">()</span> <span class="k">else</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: &quot;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>
                <span class="n">divs_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="s2">&quot;Back Adj.&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adj</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">divs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">divs</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="c1"># Replaced cached dividend event if (i) dividend different or (ii) adj different.</span>
                    <span class="n">cached_div</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">divs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="s2">&quot;Dividends&quot;</span><span class="p">]</span>
                    <span class="n">cached_adj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">divs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="s2">&quot;Back Adj.&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;pre-existing dividend @ </span><span class="si">{</span><span class="n">dt</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">cached_div</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">new_div</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">()</span> <span class="k">else</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: &quot;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>
                    <span class="n">diff_pct</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">cached_div</span><span class="o">-</span><span class="n">new_div</span><span class="p">)</span><span class="o">/</span><span class="n">cached_div</span>
                    <span class="n">diff_pct2</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">cached_adj</span><span class="o">-</span><span class="n">adj</span><span class="p">)</span><span class="o">/</span><span class="n">cached_adj</span>
                    <span class="n">diff_pct</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">diff_pct</span><span class="p">,</span> <span class="n">diff_pct2</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">diff_pct</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>
                        <span class="c1"># tiny difference, easier to just keep old value</span>
                        <span class="n">divs_df</span> <span class="o">=</span> <span class="n">divs_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;ignoring new div&quot;</span>
                            <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">()</span> <span class="k">else</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: &quot;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">divs_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="s2">&quot;Superseded div&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">divs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="s2">&quot;Dividends&quot;</span><span class="p">]</span>
                        <span class="n">divs_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="s2">&quot;Superseded back adj.&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">divs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="s2">&quot;Back Adj.&quot;</span><span class="p">]</span>
                        <span class="n">divs_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="s2">&quot;Superseded div FetchDate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">divs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="s2">&quot;FetchDate&quot;</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">divs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">divs</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
                        <span class="n">self_divs_modified</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;replacing old div&quot;</span>
                            <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">()</span> <span class="k">else</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: &quot;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">new_div</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="c1"># Discard, was only sent to deprecate previous dividend on this date</span>
                    <span class="n">divs_df</span> <span class="o">=</span> <span class="n">divs_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>

            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Dividends&quot;</span><span class="p">,</span> <span class="s2">&quot;Back Adj.&quot;</span><span class="p">,</span> <span class="s2">&quot;FetchDate&quot;</span><span class="p">,</span> <span class="s2">&quot;Superseded div&quot;</span><span class="p">,</span> <span class="s2">&quot;Superseded back adj.&quot;</span><span class="p">,</span> <span class="s2">&quot;Superseded div FetchDate&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">divs_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">divs_pretty</span> <span class="o">=</span> <span class="n">divs_df</span><span class="p">[[</span><span class="s2">&quot;Dividends&quot;</span><span class="p">,</span> <span class="s2">&quot;Back Adj.&quot;</span><span class="p">,</span> <span class="s2">&quot;Close day before&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">divs_pretty</span> <span class="o">=</span> <span class="n">divs_pretty</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Dividends&#39;</span><span class="p">:</span><span class="s1">&#39;Div&#39;</span><span class="p">,</span> <span class="s1">&#39;Back Adj.&#39;</span><span class="p">:</span><span class="s1">&#39;Adj&#39;</span><span class="p">,</span> <span class="s1">&#39;Close day before&#39;</span><span class="p">:</span><span class="s1">&#39;Close&#39;</span><span class="p">})</span>
                <span class="n">divs_pretty</span><span class="p">[</span><span class="s1">&#39;Adj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">divs_pretty</span><span class="p">[</span><span class="s1">&#39;Adj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">divs_pretty</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">divs_pretty</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">divs_pretty</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">divs_pretty</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">divs_pretty</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">n_sup</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">divs_df</span><span class="p">[</span><span class="s1">&#39;Superseded div&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
                <span class="n">n_new</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="n">n_sup</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">LogEvent</span><span class="p">(</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="s2">&quot;DividendManager&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;stored </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> dividends (</span><span class="si">{</span><span class="n">n_new</span><span class="si">}</span><span class="s2"> new, </span><span class="si">{</span><span class="n">n_sup</span><span class="si">}</span><span class="s2"> superseded): </span><span class="si">{</span><span class="n">divs_pretty</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">divs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">divs</span> <span class="o">=</span> <span class="n">divs_df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">f_na</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">divs</span><span class="p">[</span><span class="s1">&#39;Superseded div FetchDate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">f_na</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                        <span class="c1"># Drop column. It breaks concat, and anyway &#39;divs_df&#39; will restore it.</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">divs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">divs</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Superseded div FetchDate&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">divs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">divs</span><span class="p">,</span> <span class="n">divs_df</span><span class="p">[</span><span class="n">cols</span><span class="p">]],</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
                <span class="n">yfcm</span><span class="o">.</span><span class="n">StoreCacheDatum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;dividends&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">divs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">self_divs_modified</span><span class="p">:</span>
                <span class="n">yfcm</span><span class="o">.</span><span class="n">StoreCacheDatum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;dividends&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">divs</span><span class="p">)</span>

        <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceExit</span><span class="p">(</span><span class="s2">&quot;UpdateDividends() returning&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="PriceHistory">
<a class="viewcode-back" href="../../yfinance_cache.html#yfinance_cache.yfc_prices_manager.PriceHistory">[docs]</a>
<span class="k">class</span> <span class="nc">PriceHistory</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manager</span><span class="p">,</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">tzName</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">proxy</span><span class="p">,</span> <span class="n">repair</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">interval</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">interval</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">intervalStrToEnum</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;&#39;interval&#39; if str must be one of: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">yfcd</span><span class="o">.</span><span class="n">intervalStrToEnum</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">intervalStrToEnum</span><span class="p">[</span><span class="n">interval</span><span class="p">]</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckStr</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;ticker&quot;</span><span class="p">)</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckStr</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="s2">&quot;exchange&quot;</span><span class="p">)</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckStr</span><span class="p">(</span><span class="n">tzName</span><span class="p">,</span> <span class="s2">&quot;tzName&quot;</span><span class="p">)</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckBool</span><span class="p">(</span><span class="n">repair</span><span class="p">,</span> <span class="s2">&quot;repair&quot;</span><span class="p">)</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckBool</span><span class="p">(</span><span class="n">contiguous</span><span class="p">,</span> <span class="s2">&quot;contiguous&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="n">manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">ticker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="n">exchange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tzName</span> <span class="o">=</span> <span class="n">tzName</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="n">interval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span> <span class="o">=</span> <span class="n">proxy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repair</span> <span class="o">=</span> <span class="n">repair</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contiguous</span> <span class="o">=</span> <span class="n">contiguous</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dat</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tz</span> <span class="o">=</span> <span class="n">ZoneInfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tzName</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">itd</span> <span class="o">=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">intervalToTimedelta</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">istr</span> <span class="o">=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">intervalToString</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interday</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="ow">in</span> <span class="p">[</span><span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span><span class="p">,</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Week</span><span class="p">]</span><span class="c1">#, yfcd.Interval.Months1, yfcd.Interval.Months3]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intraday</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multiday</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">!=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span>

        <span class="c1"># Load from cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_key</span> <span class="o">=</span> <span class="s2">&quot;history-&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getCachedPrices</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reviewNewDivs</span><span class="p">()</span>

        <span class="c1"># A place to temporarily store new dividends, until prices have</span>
        <span class="c1"># been repaired, then they can be sent to EventsHistory</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># self._debug = True</span>

        <span class="c1"># Manage potential for infinite recursion during price repair:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_record_stack_trace</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># self._record_stack_trace = False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stack_trace</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_infinite_recursion_detected</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_getCachedPrices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">yfcm</span><span class="o">.</span><span class="n">IsDatumCached</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_key</span><span class="p">):</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">yfcm</span><span class="o">.</span><span class="n">ReadCacheDatum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_key</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">h</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">h</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">h</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">h_modified</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># h = yfcu.CustomNanCheckingDataFrame(h)</span>

            <span class="k">if</span> <span class="s2">&quot;Adj Close&quot;</span> <span class="ow">in</span> <span class="n">h</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Adj Close in cached h&quot;</span><span class="p">)</span>

            <span class="n">f_dups</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">f_dups</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: These timepoints have been duplicated: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">f_dups</span><span class="p">]))</span>

            <span class="n">f_na</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;CDF&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">f_na</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">h</span><span class="p">[</span><span class="s2">&quot;CDF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="s2">&quot;CDF&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">bfill</span><span class="p">()</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span>
                <span class="n">f_na</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="s2">&quot;CDF&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">f_na</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;CDF NaN repair failed&quot;</span><span class="p">)</span>
                <span class="n">h_modified</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">h_modified</span><span class="p">:</span>
                <span class="n">yfcm</span><span class="o">.</span><span class="n">StoreCacheDatum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">h</span>

    <span class="k">def</span> <span class="nf">_updatedCachedPrices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckDataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;df&quot;</span><span class="p">)</span>

        <span class="n">expected_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Open&quot;</span><span class="p">,</span> <span class="s2">&quot;High&quot;</span><span class="p">,</span> <span class="s2">&quot;Low&quot;</span><span class="p">,</span> <span class="s2">&quot;Close&quot;</span><span class="p">,</span> <span class="s2">&quot;Volume&quot;</span><span class="p">,</span> <span class="s2">&quot;Dividends&quot;</span><span class="p">,</span> <span class="s2">&quot;Stock Splits&quot;</span><span class="p">]</span>
        <span class="n">expected_cols</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;Final?&quot;</span><span class="p">,</span> <span class="s2">&quot;C-Check?&quot;</span><span class="p">,</span> <span class="s2">&quot;FetchDate&quot;</span><span class="p">,</span> <span class="s2">&quot;CSF&quot;</span><span class="p">,</span> <span class="s2">&quot;CDF&quot;</span><span class="p">]</span>
        <span class="n">expected_cols</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;LastDivAdjustDt&quot;</span><span class="p">,</span> <span class="s2">&quot;LastSplitAdjustDt&quot;</span><span class="p">]</span>

        <span class="n">missing_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">expected_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_cols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DF missing these columns: </span><span class="si">{</span><span class="n">missing_cols</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">yfcm</span><span class="o">.</span><span class="n">StoreCacheDatum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">_reviewNewDivs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">!=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">cached_new_divs</span> <span class="o">=</span> <span class="n">yfcm</span><span class="o">.</span><span class="n">ReadCacheDatum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;new_divs&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cached_new_divs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">yfcm</span><span class="o">.</span><span class="n">ReadCacheMetadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;new_divs&quot;</span><span class="p">,</span> <span class="s2">&quot;locked&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># This is bad, means YFC was killed before &#39;new_divs&#39; could be processed.</span>
                <span class="c1"># Means potentially future new dividends have not been processed</span>
                <span class="n">h_divs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;Dividends&quot;</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;Dividends&quot;</span><span class="p">,</span> <span class="s2">&quot;FetchDate&quot;</span><span class="p">]]</span>
                <span class="n">h_divs_since</span> <span class="o">=</span> <span class="n">h_divs</span><span class="p">[</span><span class="n">h_divs</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">cached_new_divs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">h_divs_since</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;Desplitted?&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cached_new_divs</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="n">cached_new_divs</span><span class="p">[</span><span class="s1">&#39;Desplitted?&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># assume</span>
                    <span class="n">h_divs_since</span><span class="p">[</span><span class="s1">&#39;Desplitted?&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">cached_new_divs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">cached_new_divs</span><span class="p">,</span> <span class="n">h_divs_since</span><span class="p">])</span>
                    <span class="n">yfcm</span><span class="o">.</span><span class="n">StoreCacheDatum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;new_divs&quot;</span><span class="p">,</span> <span class="n">cached_new_divs</span><span class="p">)</span>
                <span class="n">yfcm</span><span class="o">.</span><span class="n">WriteCacheMetadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;new_divs&quot;</span><span class="p">,</span> <span class="s2">&quot;locked&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<div class="viewcode-block" id="PriceHistory.get">
<a class="viewcode-back" href="../../yfinance_cache.html#yfinance_cache.yfc_prices_manager.PriceHistory.get">[docs]</a>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trigger_at_market_close</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">repair</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prepost</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">adjust_splits</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">adjust_divs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">end</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">period</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must provide value for one of: &#39;start&#39;, &#39;end&#39;, &#39;period&#39;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckIntervalDt</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckIntervalDt</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">period</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckPeriod</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="s2">&quot;period&quot;</span><span class="p">)</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckBool</span><span class="p">(</span><span class="n">trigger_at_market_close</span><span class="p">,</span> <span class="s2">&quot;trigger_at_market_close&quot;</span><span class="p">)</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckBool</span><span class="p">(</span><span class="n">repair</span><span class="p">,</span> <span class="s2">&quot;repair&quot;</span><span class="p">)</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckBool</span><span class="p">(</span><span class="n">adjust_splits</span><span class="p">,</span> <span class="s2">&quot;adjust_splits&quot;</span><span class="p">)</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckBool</span><span class="p">(</span><span class="n">adjust_divs</span><span class="p">,</span> <span class="s2">&quot;adjust_divs&quot;</span><span class="p">)</span>

        <span class="c1"># TODO: enforce &#39;max_age&#39; value provided. Only &#39;None&#39; while I dev</span>
        <span class="k">if</span> <span class="n">max_age</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span><span class="p">:</span>
                <span class="n">max_age</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Week</span><span class="p">:</span>
                <span class="n">max_age</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
            <span class="c1"># elif self.interval == yfcd.Interval.Months1:</span>
            <span class="c1">#     max_age = timedelta(days=15)</span>
            <span class="c1"># elif self.interval == yfcd.Interval.Months3:</span>
            <span class="c1">#     max_age = timedelta(days=45)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">max_age</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">yfcd</span><span class="o">.</span><span class="n">intervalToTimedelta</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">]</span>

        <span class="c1"># YFC cannot handle pre- and post-market intraday</span>
        <span class="n">prepost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span>

        <span class="n">yfct</span><span class="o">.</span><span class="n">SetExchangeTzName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tzName</span><span class="p">)</span>
        <span class="n">td_1d</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">tz_exchange</span> <span class="o">=</span> <span class="n">ZoneInfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tzName</span><span class="p">)</span>
        <span class="n">dt_now</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="n">tz_exchange</span><span class="p">)</span>
        <span class="n">d_now_exchange</span> <span class="o">=</span> <span class="n">dt_now</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="n">tomorrow_d</span> <span class="o">=</span> <span class="n">d_now_exchange</span> <span class="o">+</span> <span class="n">td_1d</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span><span class="p">:</span>
            <span class="n">tomorrow</span> <span class="o">=</span> <span class="n">tomorrow_d</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tomorrow</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">tomorrow_d</span><span class="p">,</span> <span class="n">time</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">tz_exchange</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">start</span> <span class="o">&gt;=</span> <span class="n">end</span><span class="p">:</span>
                <span class="c1"># raise ValueError(f&quot;start={start} must &lt; end={end}&quot;)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="c1"># if (self.interday and start &gt;= tomorrow) or (not self.interday and start &gt; dt_now):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">dt_now</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;=</span> <span class="n">tomorrow_d</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>

        <span class="n">debug_yf</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">debug_yfc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span>
        <span class="c1"># debug_yfc = True</span>

        <span class="k">if</span> <span class="n">period</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;PriceHistory-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="si">}</span><span class="s2">.get(tkr=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s2">, period=</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s2">, max_age=</span><span class="si">{</span><span class="n">max_age</span><span class="si">}</span><span class="s2">, trigger_at_market_close=</span><span class="si">{</span><span class="n">trigger_at_market_close</span><span class="si">}</span><span class="s2">, prepost=</span><span class="si">{</span><span class="n">prepost</span><span class="si">}</span><span class="s2">, repair=</span><span class="si">{</span><span class="n">repair</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;PriceHistory-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="si">}</span><span class="s2">.get(tkr=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s2">, start=</span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2">, end=</span><span class="si">{</span><span class="n">end</span><span class="si">}</span><span class="s2">, max_age=</span><span class="si">{</span><span class="n">max_age</span><span class="si">}</span><span class="s2">, trigger_at_market_close=</span><span class="si">{</span><span class="n">trigger_at_market_close</span><span class="si">}</span><span class="s2">, prepost=</span><span class="si">{</span><span class="n">prepost</span><span class="si">}</span><span class="s2">, repair=</span><span class="si">{</span><span class="n">repair</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">():</span>
            <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceEnter</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">debug_yfc</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_applyNewEvents</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">yf_lag</span> <span class="o">=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">exchangeToYfLag</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- ticker = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="n">pstr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">end_d</span> <span class="o">=</span> <span class="kc">None</span> <span class="p">;</span> <span class="n">end_dt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">period</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">start_d</span><span class="p">,</span> <span class="n">end_d</span> <span class="o">=</span> <span class="n">yfct</span><span class="o">.</span><span class="n">MapPeriodToDates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">)</span>
            <span class="n">period</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">start_d</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">end_d</span>
                <span class="n">start_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">start_d</span><span class="p">,</span> <span class="n">time</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">tz_exchange</span><span class="p">)</span>
                <span class="n">end_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">end_d</span><span class="p">,</span> <span class="n">time</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">tz_exchange</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">start_d</span><span class="p">,</span> <span class="n">time</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">tz_exchange</span><span class="p">)</span>
                <span class="n">end</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">start_dt</span> <span class="o">=</span> <span class="n">start</span>
                <span class="n">end_dt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span><span class="p">:</span>
                <span class="n">start_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">time</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">tz_exchange</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
                    <span class="n">start_dt</span> <span class="o">=</span> <span class="n">start</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">start_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">time</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">tz_exchange</span><span class="p">)</span>
                    <span class="n">start</span> <span class="o">=</span> <span class="n">start_dt</span>

        <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">pstr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">d_now_exchange</span><span class="o">+</span><span class="n">td_1d</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sched</span> <span class="o">=</span> <span class="n">yfct</span><span class="o">.</span><span class="n">GetExchangeSchedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="n">d_now_exchange</span><span class="p">,</span> <span class="n">d_now_exchange</span><span class="o">+</span><span class="n">td_1d</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sched</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">dt_now</span> <span class="o">+</span> <span class="n">yf_lag</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">sched</span><span class="p">[</span><span class="s2">&quot;open&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="c1"># Before market open</span>
                    <span class="n">end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">d_now_exchange</span><span class="p">,</span> <span class="n">time</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">tz_exchange</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">yfct</span><span class="o">.</span><span class="n">GetTimestampCurrentInterval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="n">dt_now</span><span class="o">+</span><span class="n">yf_lag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span> <span class="n">ignore_breaks</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># After interval</span>
                        <span class="n">end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">d_now_exchange</span><span class="o">+</span><span class="n">td_1d</span><span class="p">,</span> <span class="n">time</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">tz_exchange</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># During interval</span>
                        <span class="n">end</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="s2">&quot;interval_close&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">end_dt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
                <span class="n">end_dt</span> <span class="o">=</span> <span class="n">end</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># end_dt = datetime.combine(end+td_1d, time(0), tz_exchange)</span>
                <span class="n">end_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">time</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">tz_exchange</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">end_dt</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;start&#39; and &#39;end&#39; must be date type not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">end</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">datetime</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;start&#39; and &#39;end&#39; must be datetime type not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">end</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">listing_date</span> <span class="o">=</span> <span class="n">yfcm</span><span class="o">.</span><span class="n">ReadCacheDatum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;listing_date&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">listing_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">listing_date_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">listing_date</span><span class="p">,</span> <span class="n">time</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">tz_exchange</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
                <span class="n">start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">listing_date_dt</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">listing_date</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Remove expired intervals from cache</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span><span class="p">:</span>
                <span class="n">h_interval_dts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">h_interval_dts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">yfct</span><span class="o">.</span><span class="n">ConvertToDatetime</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="n">tz_exchange</span><span class="p">)</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">])</span>
            <span class="n">h_interval_dts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">h_interval_dts</span><span class="p">)</span>
            <span class="c1"># if self.interval == yfcd.Interval.Days1:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contiguous</span><span class="p">:</span>
                <span class="c1"># Daily data is always contiguous so only need to check last row</span>
                <span class="n">h_interval_dt</span> <span class="o">=</span> <span class="n">h_interval_dts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">fetch_dt</span> <span class="o">=</span> <span class="n">yfct</span><span class="o">.</span><span class="n">ConvertToDatetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;FetchDate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">tz</span><span class="o">=</span><span class="n">tz_exchange</span><span class="p">)</span>
                <span class="n">f_final</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;Final?&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="n">f_nfinal</span> <span class="o">=</span> <span class="o">~</span><span class="n">f_final</span>
                <span class="c1"># - also treat repaired data as non-final, if fetched near to interval timepoint</span>
                <span class="c1">#   because Yahoo might now have correct data</span>
                <span class="c1"># - and treat NaN data as repaired</span>
                <span class="n">f_repair</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;Repaired?&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="n">f_na</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="n">f_repair</span> <span class="o">=</span> <span class="n">f_repair</span> <span class="o">|</span> <span class="n">f_na</span>
                <span class="n">cutoff_dts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">itd</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
                <span class="c1"># Ignore repaired data if fetched/repaired 7+ days after interval end</span>
                <span class="n">f_repair</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="s1">&#39;FetchDate&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">cutoff_dts</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">f_repair</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="n">f_nfinal</span> <span class="o">=</span> <span class="n">f_nfinal</span> <span class="o">|</span> <span class="n">f_repair</span>
                <span class="k">if</span> <span class="n">f_nfinal</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="n">idx0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">f_nfinal</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">repaired</span> <span class="o">=</span> <span class="n">f_repair</span><span class="p">[</span><span class="n">idx0</span><span class="p">]</span>
                    <span class="n">h_interval_dt</span> <span class="o">=</span> <span class="n">h_interval_dts</span><span class="p">[</span><span class="n">idx0</span><span class="p">]</span>
                    <span class="n">fetch_dt</span> <span class="o">=</span> <span class="n">yfct</span><span class="o">.</span><span class="n">ConvertToDatetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;FetchDate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx0</span><span class="p">],</span> <span class="n">tz</span><span class="o">=</span><span class="n">tz_exchange</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">expired</span> <span class="o">=</span> <span class="n">yfct</span><span class="o">.</span><span class="n">IsPriceDatapointExpired</span><span class="p">(</span><span class="n">h_interval_dt</span><span class="p">,</span> <span class="n">fetch_dt</span><span class="p">,</span> <span class="n">repaired</span><span class="p">,</span> <span class="n">max_age</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span> <span class="n">yf_lag</span><span class="o">=</span><span class="n">yf_lag</span><span class="p">,</span> <span class="n">triggerExpiryOnClose</span><span class="o">=</span><span class="n">trigger_at_market_close</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">TimestampOutsideIntervalException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">f_na</span><span class="p">[</span><span class="n">idx0</span><span class="p">]:</span>
                            <span class="c1"># YFC must have inserted a row of NaNs, wrongly thinking exchange should have been open here.</span>
                            <span class="n">expired</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">e</span>
                    <span class="k">if</span> <span class="n">expired</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">idx0</span><span class="p">]</span>
                        <span class="n">h_interval_dts</span> <span class="o">=</span> <span class="n">h_interval_dts</span><span class="p">[:</span><span class="n">idx0</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">expired</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">False</span><span class="p">]</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
                <span class="n">f_final</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;Final?&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="n">f_nfinal</span> <span class="o">=</span> <span class="o">~</span><span class="n">f_final</span>
                <span class="c1"># - also treat repaired data as non-final, if fetched near to interval timepoint</span>
                <span class="c1">#   because Yahoo might now have correct data</span>
                <span class="c1"># - and treat NaN data as repaired</span>
                <span class="n">cutoff_dt</span> <span class="o">=</span> <span class="n">dt_now</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_indexer</span><span class="p">([</span><span class="n">cutoff_dt</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;bfill&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">f_repair</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;Repaired?&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="n">f_na</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="n">f_repair</span> <span class="o">=</span> <span class="n">f_repair</span> <span class="o">|</span> <span class="n">f_na</span>
                <span class="n">cutoff_dts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">itd</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
                <span class="c1"># Ignore repaired data if fetched/repaired 7+ days after interval end</span>
                <span class="n">f_repair</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="s1">&#39;FetchDate&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">cutoff_dts</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">f_repair</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="n">f_nfinal</span> <span class="o">=</span> <span class="n">f_nfinal</span> <span class="o">|</span> <span class="n">f_repair</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">f_nfinal</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="c1"># repaired = False</span>
                    <span class="n">repaired</span> <span class="o">=</span> <span class="n">f_repair</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                    <span class="n">h_interval_dt</span> <span class="o">=</span> <span class="n">h_interval_dts</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                    <span class="n">fetch_dt</span> <span class="o">=</span> <span class="n">yfct</span><span class="o">.</span><span class="n">ConvertToDatetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;FetchDate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">tz</span><span class="o">=</span><span class="n">tz_exchange</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">expired_idx</span> <span class="o">=</span> <span class="n">yfct</span><span class="o">.</span><span class="n">IsPriceDatapointExpired</span><span class="p">(</span><span class="n">h_interval_dt</span><span class="p">,</span> <span class="n">fetch_dt</span><span class="p">,</span> <span class="n">repaired</span><span class="p">,</span> <span class="n">max_age</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span> <span class="n">yf_lag</span><span class="o">=</span><span class="n">yf_lag</span><span class="p">,</span> <span class="n">triggerExpiryOnClose</span><span class="o">=</span><span class="n">trigger_at_market_close</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">TimestampOutsideIntervalException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">f_na</span><span class="p">[</span><span class="n">idx0</span><span class="p">]:</span>
                            <span class="c1"># YFC must have inserted a row of NaNs, wrongly thinking exchange should have been open here.</span>
                            <span class="n">expired_idx</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">e</span>
                    <span class="n">expired</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">expired_idx</span>
                <span class="k">if</span> <span class="n">expired</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">expired</span><span class="p">])</span>
                    <span class="n">h_interval_dts</span> <span class="o">=</span> <span class="n">h_interval_dts</span><span class="p">[</span><span class="o">~</span><span class="n">expired</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">ranges_to_fetch</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Simple, just fetch the requested data</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contiguous</span><span class="p">:</span>
                <span class="c1"># Ensure daily always up-to-now</span>
                <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetchYfHistory</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">tomorrow</span><span class="p">,</span> <span class="n">prepost</span><span class="p">,</span> <span class="n">debug_yf</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetchYfHistory</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">prepost</span><span class="p">,</span> <span class="n">debug_yf</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">h</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: Failed to fetch date range </span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2">-&gt;</span><span class="si">{</span><span class="n">end</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Adjust</span>
            <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reverseYahooAdjust</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span><span class="p">:</span>
                <span class="n">h_splits</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;Stock Splits&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">h_splits</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">GetHistory</span><span class="p">(</span><span class="s2">&quot;Events&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">UpdateSplits</span><span class="p">(</span><span class="n">h_splits</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_updatedCachedPrices</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Compare request against cached data, only fetch missing/expired data</span>

            <span class="c1"># Performance TODO: tag rows as fully contiguous to avoid searching for gaps</span>

            <span class="c1"># Calculate ranges_to_fetch</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contiguous</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiday</span><span class="p">:</span>
                            <span class="n">ranges_to_fetch</span> <span class="o">=</span> <span class="n">yfct</span><span class="o">.</span><span class="n">IdentifyMissingIntervalRanges</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="n">start_d</span><span class="p">,</span> <span class="n">end_d</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">itd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span> <span class="p">[],</span> <span class="n">minDistanceThreshold</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ranges_to_fetch</span> <span class="o">=</span> <span class="n">yfct</span><span class="o">.</span><span class="n">IdentifyMissingIntervalRanges</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="n">start_d</span><span class="p">,</span> <span class="n">end_d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span> <span class="p">[],</span> <span class="n">minDistanceThreshold</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ranges_to_fetch</span> <span class="o">=</span> <span class="n">yfct</span><span class="o">.</span><span class="n">IdentifyMissingIntervalRanges</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span> <span class="p">[],</span> <span class="n">minDistanceThreshold</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Ensure that daily data always up-to-date to now</span>
                    <span class="c1"># Update: only necessary to be up-to-date to now if a fetch happens</span>
                    <span class="n">dt_start</span> <span class="o">=</span> <span class="n">yfct</span><span class="o">.</span><span class="n">ConvertToDatetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tz</span><span class="o">=</span><span class="n">tz_exchange</span><span class="p">)</span>
                    <span class="n">dt_end</span> <span class="o">=</span> <span class="n">yfct</span><span class="o">.</span><span class="n">ConvertToDatetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">tz</span><span class="o">=</span><span class="n">tz_exchange</span><span class="p">)</span>
                    <span class="n">h_start</span> <span class="o">=</span> <span class="n">yfct</span><span class="o">.</span><span class="n">GetTimestampCurrentInterval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span> <span class="n">ignore_breaks</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s2">&quot;interval_open&quot;</span><span class="p">]</span>
                    <span class="n">last_interval</span> <span class="o">=</span> <span class="n">yfct</span><span class="o">.</span><span class="n">GetTimestampCurrentInterval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span> <span class="n">ignore_breaks</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">last_interval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># Possible if Yahoo returned price data when &#39;exchange_calendars&#39; thinks exchange was closed</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
                            <span class="n">last_interval</span> <span class="o">=</span> <span class="n">yfct</span><span class="o">.</span><span class="n">GetTimestampCurrentInterval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="n">dt_end</span> <span class="o">-</span> <span class="n">td_1d</span><span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span> <span class="n">ignore_breaks</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">last_interval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">break</span>
                    <span class="n">h_end</span> <span class="o">=</span> <span class="n">last_interval</span><span class="p">[</span><span class="s2">&quot;interval_close&quot;</span><span class="p">]</span>

                    <span class="n">rangePre_to_fetch</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="n">h_start</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">debug_yfc</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;checking for rangePre_to_fetch&quot;</span>
                            <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">()</span> <span class="k">else</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: &quot;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">rangePre_to_fetch</span> <span class="o">=</span> <span class="n">yfct</span><span class="o">.</span><span class="n">IdentifyMissingIntervalRanges</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">h_start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ignore_breaks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">minDistanceThreshold</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                        <span class="k">except</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">NoIntervalsInRangeException</span><span class="p">:</span>
                            <span class="n">rangePre_to_fetch</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">rangePre_to_fetch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rangePre_to_fetch</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Expected only one element in rangePre_to_fetch[], but = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rangePre_to_fetch</span><span class="p">))</span>
                        <span class="n">rangePre_to_fetch</span> <span class="o">=</span> <span class="n">rangePre_to_fetch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="c1">#</span>
                    <span class="n">rangePost_to_fetch</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;Final?&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">yfct</span><span class="o">.</span><span class="n">CalcIntervalLastDataDt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="n">dt_end</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;FetchDate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="n">max_age</span> <span class="o">&lt;=</span> <span class="n">dt_now</span><span class="p">):</span>
                        <span class="c1"># Note: if self.h[&quot;Final?&quot;].iloc[-1] == False, then that means above expiry check didn&#39;t remove it so don&#39;t fetch anything</span>
                        <span class="k">if</span> <span class="n">debug_yfc</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;checking for rangePost_to_fetch&quot;</span>
                            <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">()</span> <span class="k">else</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: &quot;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">rangePre_to_fetch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">end</span> <span class="o">&gt;</span> <span class="n">h_end</span><span class="p">:</span>
                                <span class="n">target_end_d</span> <span class="o">=</span> <span class="n">tomorrow_d</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">target_end_d</span> <span class="o">=</span> <span class="n">end</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiday</span><span class="p">:</span>
                                <span class="n">target_end_d</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">itd</span>  <span class="c1"># testing new code</span>
                            <span class="k">if</span> <span class="n">h_end</span> <span class="o">&lt;</span> <span class="n">target_end_d</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">rangePost_to_fetch</span> <span class="o">=</span> <span class="n">yfct</span><span class="o">.</span><span class="n">IdentifyMissingIntervalRanges</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="n">h_end</span><span class="p">,</span> <span class="n">target_end_d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">minDistanceThreshold</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                                <span class="k">except</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">NoIntervalsInRangeException</span><span class="p">:</span>
                                    <span class="n">rangePost_to_fetch</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">rangePre_to_fetch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">end</span> <span class="o">&gt;</span> <span class="n">h_end</span><span class="p">:</span>
                                <span class="n">target_end_dt</span> <span class="o">=</span> <span class="n">dt_now</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">target_end_dt</span> <span class="o">=</span> <span class="n">end</span>
                            <span class="n">d</span> <span class="o">=</span> <span class="n">target_end_dt</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">tz_exchange</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
                            <span class="n">sched</span> <span class="o">=</span> <span class="n">yfct</span><span class="o">.</span><span class="n">GetExchangeSchedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">d</span> <span class="o">+</span> <span class="n">td_1d</span><span class="p">)</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">sched</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">sched</span><span class="o">.</span><span class="n">empty</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dt_now</span> <span class="o">&gt;</span> <span class="n">sched</span><span class="p">[</span><span class="s2">&quot;open&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                                <span class="n">target_end_dt</span> <span class="o">=</span> <span class="n">sched</span><span class="p">[</span><span class="s2">&quot;close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">h_end</span> <span class="o">&lt;</span> <span class="n">target_end_dt</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">rangePost_to_fetch</span> <span class="o">=</span> <span class="n">yfct</span><span class="o">.</span><span class="n">IdentifyMissingIntervalRanges</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="n">h_end</span><span class="p">,</span> <span class="n">target_end_dt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">minDistanceThreshold</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                                <span class="k">except</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">NoIntervalsInRangeException</span><span class="p">:</span>
                                    <span class="n">rangePost_to_fetch</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">ranges_to_fetch</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="n">rangePost_to_fetch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rangePost_to_fetch</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Expected only one element in rangePost_to_fetch[], but = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rangePost_to_fetch</span><span class="p">))</span>
                        <span class="n">rangePost_to_fetch</span> <span class="o">=</span> <span class="n">rangePost_to_fetch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">rangePre_to_fetch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">ranges_to_fetch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rangePre_to_fetch</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">rangePost_to_fetch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">ranges_to_fetch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rangePost_to_fetch</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">h_intervals</span> <span class="o">=</span> <span class="n">yfct</span><span class="o">.</span><span class="n">GetTimestampCurrentInterval_batch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="n">h_interval_dts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span> <span class="n">ignore_breaks</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">h_intervals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">h_intervals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;interval_open&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;interval_close&quot;</span><span class="p">:</span> <span class="p">[]})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">f_na</span> <span class="o">=</span> <span class="n">h_intervals</span><span class="p">[</span><span class="s2">&quot;interval_open&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">f_na</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="c1"># Mapping Yahoo intervals -&gt; xcal can fail now, because sometime xcal is wrong.</span>
                        <span class="c1"># Need to tolerate</span>
                        <span class="n">h_intervals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f_na</span><span class="p">,</span> <span class="s2">&quot;interval_open&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_interval_dts</span><span class="p">[</span><span class="n">f_na</span><span class="p">]</span>
                        <span class="n">h_intervals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f_na</span><span class="p">,</span> <span class="s2">&quot;interval_close&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_interval_dts</span><span class="p">[</span><span class="n">f_na</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">itd</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">h_intervals</span><span class="o">.</span><span class="n">empty</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">h_intervals</span><span class="p">[</span><span class="s2">&quot;interval_open&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">datetime</span><span class="p">):</span>
                    <span class="n">h_interval_opens</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">tz_exchange</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">h_intervals</span><span class="p">[</span><span class="s2">&quot;interval_open&quot;</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">h_interval_opens</span> <span class="o">=</span> <span class="n">h_intervals</span><span class="p">[</span><span class="s2">&quot;interval_open&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">target_end</span> <span class="o">=</span> <span class="n">end</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiday</span><span class="p">:</span>
                        <span class="n">target_end</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">itd</span>
                    <span class="n">ranges_to_fetch</span> <span class="o">=</span> <span class="n">yfct</span><span class="o">.</span><span class="n">IdentifyMissingIntervalRanges</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">target_end</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span> <span class="n">h_interval_opens</span><span class="p">,</span> <span class="n">ignore_breaks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">minDistanceThreshold</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ranges_to_fetch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">ranges_to_fetch</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">except</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">NoIntervalsInRangeException</span><span class="p">:</span>
                    <span class="n">ranges_to_fetch</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ticker =&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">)</span>
                    <span class="k">raise</span>
            <span class="c1"># Prune ranges in future:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ranges_to_fetch</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">ranges_to_fetch</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">delete_range</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">datetime</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">dt_now</span><span class="p">:</span>
                        <span class="n">delete_range</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sched</span> <span class="o">=</span> <span class="n">yfct</span><span class="o">.</span><span class="n">GetExchangeSchedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">date</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">+</span> <span class="n">td_1d</span><span class="p">)</span>
                        <span class="n">delete_range</span> <span class="o">=</span> <span class="p">(</span><span class="n">sched</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dt_now</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">sched</span><span class="p">[</span><span class="s2">&quot;open&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">yf_lag</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">time</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">tz_exchange</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">dt_now</span><span class="p">:</span>
                        <span class="n">delete_range</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sched</span> <span class="o">=</span> <span class="n">yfct</span><span class="o">.</span><span class="n">GetExchangeSchedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="n">td_1d</span><span class="p">)</span>
                        <span class="n">delete_range</span> <span class="o">=</span> <span class="p">(</span><span class="n">sched</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dt_now</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">sched</span><span class="p">[</span><span class="s2">&quot;open&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">yf_lag</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">delete_range</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">debug_yfc</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- deleting future range:&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="k">del</span> <span class="n">ranges_to_fetch</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Check if range ends in future, if yes then adjust to tomorrow max</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="p">(</span><span class="n">datetime</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="n">dt_now</span><span class="p">:</span>
                            <span class="n">ranges_to_fetch</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">min</span><span class="p">(</span><span class="n">dt_now</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="s1">&#39;1D&#39;</span><span class="p">),</span> <span class="n">y</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="n">d_now_exchange</span><span class="p">:</span>
                        <span class="n">sched</span> <span class="o">=</span> <span class="n">yfct</span><span class="o">.</span><span class="n">GetExchangeSchedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="n">d_now_exchange</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">td_1d</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">sched</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">debug_yfc</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- capping last range_to_fetch end to d_now_exchange&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">dt_now</span> <span class="o">&lt;</span> <span class="n">sched</span><span class="p">[</span><span class="s2">&quot;open&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                                <span class="n">ranges_to_fetch</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">d_now_exchange</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">ranges_to_fetch</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">d_now_exchange</span> <span class="o">+</span> <span class="n">td_1d</span><span class="p">)</span>

            <span class="c1"># Important that ranges_to_fetch in reverse order!</span>
            <span class="n">ranges_to_fetch</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">debug_yfc</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- ranges_to_fetch:&quot;</span><span class="p">)</span>
                <span class="n">pprint</span><span class="p">(</span><span class="n">ranges_to_fetch</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ranges_to_fetch</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="c1"># Ensure only one range max is after cached data:</span>
                    <span class="n">h_last_dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ranges_to_fetch</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">datetime</span><span class="p">):</span>
                        <span class="n">h_last_dt</span> <span class="o">=</span> <span class="n">h_last_dt</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">tz_exchange</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ranges_to_fetch</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">h_last_dt</span><span class="p">:</span>
                            <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ranges_to_fetch:&quot;</span><span class="p">)</span>
                        <span class="n">pprint</span><span class="p">(</span><span class="n">ranges_to_fetch</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ranges_to_fetch contains </span><span class="si">{}</span><span class="s2"> ranges that occur after h_last_dt=</span><span class="si">{}</span><span class="s2">, expected 1 max&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">h_last_dt</span><span class="p">))</span>

                <span class="c1"># if not quiet:</span>
                <span class="c1">#     quiet = period is not None  # YFC generated date range so don&#39;t print message</span>
                <span class="k">if</span> <span class="n">debug_yfc</span><span class="p">:</span>
                    <span class="n">quiet</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="c1"># quiet = not debug_yfc</span>
                <span class="c1"># if self.interval == yfcd.Interval.Days1:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contiguous</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_fetchAndAddRanges_contiguous</span><span class="p">(</span><span class="n">ranges_to_fetch</span><span class="p">,</span> <span class="n">prepost</span><span class="p">,</span> <span class="n">debug_yf</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="n">quiet</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_fetchAndAddRanges_sparse</span><span class="p">(</span><span class="n">ranges_to_fetch</span><span class="p">,</span> <span class="n">prepost</span><span class="p">,</span> <span class="n">debug_yf</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="n">quiet</span><span class="p">)</span>

        <span class="c1"># repair after all fetches complete</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">repair</span> <span class="ow">and</span> <span class="n">repair</span><span class="p">:</span>
            <span class="n">f_checked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;C-Check?&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">f_not_checked</span> <span class="o">=</span> <span class="o">~</span><span class="n">f_checked</span>
            <span class="k">if</span> <span class="n">f_not_checked</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="c1"># Check for 100x errors across ENTIRE table with split-adjustment applied temporarily.</span>
                <span class="c1"># Potential problem with very sparse data, but assume most users will</span>
                <span class="c1"># fetch &quot;sparse&quot; fairly contiguously.</span>
                <span class="c1"># - apply split-adjustment</span>
                <span class="n">OHLC</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">,</span> <span class="s1">&#39;High&#39;</span><span class="p">,</span> <span class="s1">&#39;Low&#39;</span><span class="p">,</span> <span class="s1">&#39;Close&#39;</span><span class="p">]</span>
                <span class="n">csf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="s1">&#39;CSF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">OHLC</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*=</span> <span class="n">csf</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repairUnitMixups</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
                <span class="c1"># Also repair split errors:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixBadStockSplits</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
                <span class="c1"># - reverse split-adjustment</span>
                <span class="n">csf_rcp</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="s1">&#39;CSF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">OHLC</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*=</span> <span class="n">csf_rcp</span>
                <span class="n">ha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="n">f_not_checked</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">hb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="o">~</span><span class="n">f_not_checked</span><span class="p">]</span>
                <span class="n">ha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repairZeroPrices</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">ha</span><span class="p">[</span><span class="s2">&quot;C-Check?&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">hb</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">ha</span><span class="p">,</span> <span class="n">hb</span><span class="p">[</span><span class="n">ha</span><span class="o">.</span><span class="n">columns</span><span class="p">]])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="n">tz_exchange</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="n">ha</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_updatedCachedPrices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

        <span class="c1"># Now prices have been repaired, can send out dividends</span>
        <span class="n">cached_new_divs</span> <span class="o">=</span> <span class="n">yfcm</span><span class="o">.</span><span class="n">ReadCacheDatum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;new_divs&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span> <span class="ow">and</span> <span class="n">cached_new_divs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cached_new_divs</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">cached_new_divs_locked</span> <span class="o">=</span> <span class="n">yfcm</span><span class="o">.</span><span class="n">ReadCacheMetadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;new_divs&quot;</span><span class="p">,</span> <span class="s2">&quot;locked&quot;</span><span class="p">)</span>
            <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cached_new_divs_locked = </span><span class="si">{</span><span class="n">cached_new_divs_locked</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cached_new_divs_locked</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">f_dups</span> <span class="o">=</span> <span class="n">cached_new_divs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">f_dups</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">cached_new_divs</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;duplicates detected in cached_new_divs&#39;</span><span class="p">)</span>
                <span class="n">yfcm</span><span class="o">.</span><span class="n">WriteCacheMetadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;new_divs&quot;</span><span class="p">,</span> <span class="s2">&quot;locked&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="s2">&quot;sending out new dividends ...&quot;</span><span class="p">)</span>
                <span class="c1"># TODO: remove duplicates from _newDivs (possible when restoring file file)</span>
                <span class="n">divs_df</span> <span class="o">=</span> <span class="n">cached_new_divs</span>
                <span class="n">divs_df</span><span class="p">[</span><span class="s2">&quot;Close day before&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">divs_df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">dt</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">hist_before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">GetHistory</span><span class="p">(</span><span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">-</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(),</span> <span class="n">adjust_splits</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">adjust_divs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">close_day_before</span> <span class="o">=</span> <span class="n">hist_before</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">close_day_before</span><span class="p">):</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;&#39;close_day_before&#39; is NaN&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
                        <span class="n">close_day_before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">close_day_before</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">idx</span><span class="o">-</span><span class="mi">9</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                                <span class="n">close_day_before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">close_day_before</span><span class="p">):</span>
                                    <span class="k">break</span>
                            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">close_day_before</span><span class="p">):</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- idx=</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2"> dt=</span><span class="si">{</span><span class="n">dt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="mi">3</span><span class="p">][[</span><span class="s2">&quot;Close&quot;</span><span class="p">,</span> <span class="s2">&quot;FetchDate&quot;</span><span class="p">]])</span>
                                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;&#39;close_day_before&#39; is NaN&quot;</span><span class="p">)</span>
                    <span class="n">divs_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="s2">&quot;Close day before&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">close_day_before</span>
                    <span class="c1"># De-split div:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">divs_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="s1">&#39;Desplitted?&#39;</span><span class="p">]:</span>
                        <span class="n">splits_post</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">GetHistory</span><span class="p">(</span><span class="s1">&#39;Events&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">GetSplits</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">())</span>
                        <span class="k">if</span> <span class="n">splits_post</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">post_csf</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">splits_post</span><span class="p">[</span><span class="s2">&quot;Stock Splits&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span>
                            <span class="n">divs_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="s1">&#39;Dividends&#39;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">post_csf</span>
                        <span class="n">divs_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="s1">&#39;Desplitted?&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">GetHistory</span><span class="p">(</span><span class="s2">&quot;Events&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">UpdateDividends</span><span class="p">(</span><span class="n">divs_df</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_applyNewEvents</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">cached_new_divs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cached_new_divs_locked</span><span class="p">:</span>
                    <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="s2">&quot;releasing lock on cached_new_divs&quot;</span><span class="p">)</span>
                    <span class="n">yfcm</span><span class="o">.</span><span class="n">StoreCacheDatum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;new_divs&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># delete</span>

        <span class="k">if</span> <span class="s2">&quot;Adj Close&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Adj Close in self.h&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">h_copy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">start_dt</span><span class="p">:</span><span class="n">end_dt</span><span class="o">-</span><span class="n">timedelta</span><span class="p">(</span><span class="n">milliseconds</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">h_copy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">adjust_splits</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Open&quot;</span><span class="p">,</span> <span class="s2">&quot;High&quot;</span><span class="p">,</span> <span class="s2">&quot;Low&quot;</span><span class="p">,</span> <span class="s2">&quot;Close&quot;</span><span class="p">,</span> <span class="s2">&quot;Dividends&quot;</span><span class="p">]:</span>
                <span class="n">h_copy</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*=</span> <span class="n">h_copy</span><span class="p">[</span><span class="s2">&quot;CSF&quot;</span><span class="p">]</span>
            <span class="n">h_copy</span><span class="p">[</span><span class="s2">&quot;Volume&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_copy</span><span class="p">[</span><span class="s2">&quot;Volume&quot;</span><span class="p">]</span><span class="o">/</span><span class="n">h_copy</span><span class="p">[</span><span class="s2">&quot;CSF&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
            <span class="n">h_copy</span> <span class="o">=</span> <span class="n">h_copy</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;CSF&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">adjust_divs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Open&quot;</span><span class="p">,</span> <span class="s2">&quot;High&quot;</span><span class="p">,</span> <span class="s2">&quot;Low&quot;</span><span class="p">,</span> <span class="s2">&quot;Close&quot;</span><span class="p">]:</span>
                <span class="n">h_copy</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*=</span> <span class="n">h_copy</span><span class="p">[</span><span class="s2">&quot;CDF&quot;</span><span class="p">]</span>
            <span class="n">h_copy</span> <span class="o">=</span> <span class="n">h_copy</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;CDF&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">log_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;PriceHistory-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="si">}</span><span class="s2">.get() returning&quot;</span>
        <span class="k">if</span> <span class="n">h_copy</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">log_msg</span> <span class="o">+=</span> <span class="s2">&quot; empty df&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; DF </span><span class="si">{</span><span class="n">h_copy</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">h_copy</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">():</span>
            <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceExit</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">debug_yfc</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">h_copy</span></div>


    <span class="k">def</span> <span class="nf">_fetchAndAddRanges_contiguous</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ranges_to_fetch</span><span class="p">,</span> <span class="n">prepost</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckIterable</span><span class="p">(</span><span class="n">ranges_to_fetch</span><span class="p">,</span> <span class="s2">&quot;ranges_to_fetch&quot;</span><span class="p">)</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckBool</span><span class="p">(</span><span class="n">prepost</span><span class="p">,</span> <span class="s2">&quot;prepost&quot;</span><span class="p">)</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckBool</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s2">&quot;debug&quot;</span><span class="p">)</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckBool</span><span class="p">(</span><span class="n">quiet</span><span class="p">,</span> <span class="s2">&quot;quiet&quot;</span><span class="p">)</span>

        <span class="c1"># Fetch each range, appending/prepending to cached data</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ranges_to_fetch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">ranges_to_fetch</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># return h</span>
            <span class="k">return</span>

        <span class="n">debug_yfc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span>
        <span class="c1"># debug_yfc = True</span>

        <span class="n">log_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_fetchAndAddRanges_contiguous-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="si">}</span><span class="s2">(n=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ranges_to_fetch</span><span class="p">)</span><span class="si">}</span><span class="s2"> prepost=</span><span class="si">{</span><span class="n">prepost</span><span class="si">}</span><span class="s2">))&quot;</span>
        <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">():</span>
            <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceEnter</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">debug_yfc</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- ranges_to_fetch:&quot;</span><span class="p">)</span>
            <span class="n">pprint</span><span class="p">(</span><span class="n">ranges_to_fetch</span><span class="p">)</span>

        <span class="n">tz_exchange</span> <span class="o">=</span> <span class="n">ZoneInfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tzName</span><span class="p">)</span>
        <span class="n">yfct</span><span class="o">.</span><span class="n">SetExchangeTzName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tzName</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">h_first_dt</span> <span class="o">=</span> <span class="kc">None</span> <span class="p">;</span> <span class="n">h_last_dt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">h_first_dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()</span>
            <span class="n">h_last_dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ranges_to_fetch</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">datetime</span><span class="p">):</span>
                <span class="n">h_first_dt</span> <span class="o">=</span> <span class="n">h_first_dt</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">tz_exchange</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
                <span class="n">h_last_dt</span> <span class="o">=</span> <span class="n">h_last_dt</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">tz_exchange</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="n">td_1d</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Because data should be contiguous, then ranges should meet some conditions:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ranges_to_fetch</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">pprint</span><span class="p">(</span><span class="n">ranges_to_fetch</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;For contiguous data generated </span><span class="si">{}</span><span class="s2">&gt;2 ranges&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ranges_to_fetch</span><span class="p">)))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">empty</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ranges_to_fetch</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;For contiguous data generated </span><span class="si">{}</span><span class="s2"> ranges, but h is empty&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ranges_to_fetch</span><span class="p">)))</span>
        <span class="n">range_pre</span> <span class="o">=</span> <span class="kc">None</span> <span class="p">;</span> <span class="n">range_post</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">empty</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ranges_to_fetch</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">range_pre</span> <span class="o">=</span> <span class="n">ranges_to_fetch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_pre</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">n_post</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ranges_to_fetch</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">h_last_dt</span><span class="p">:</span>
                    <span class="n">n_post</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">range_post</span> <span class="o">=</span> <span class="n">r</span>
                <span class="k">elif</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">h_first_dt</span><span class="p">:</span>
                    <span class="n">n_pre</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">range_pre</span> <span class="o">=</span> <span class="n">r</span>
            <span class="k">if</span> <span class="n">n_pre</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">pprint</span><span class="p">(</span><span class="n">ranges_to_fetch</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;For contiguous data generated </span><span class="si">{}</span><span class="s2">&gt;1 ranges before h_first_dt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_pre</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">n_post</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">pprint</span><span class="p">(</span><span class="n">ranges_to_fetch</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;For contiguous data generated </span><span class="si">{}</span><span class="s2">&gt;1 ranges after h_last_dt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_post</span><span class="p">))</span>

        <span class="c1"># Fetch ranges</span>
        <span class="n">h2_pre</span> <span class="o">=</span> <span class="kc">None</span> <span class="p">;</span> <span class="n">h2_post</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">range_pre</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">range_pre</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">h2_pre</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetchYfHistory</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">prepost</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">NoPriceDataInRangeException</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span> <span class="ow">and</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">td_1d</span><span class="p">:</span>
                    <span class="c1"># If only trying to fetch 1 day of 1d data, then print warning instead of exception.</span>
                    <span class="c1"># Could add additional condition of dividend previous day (seems to mess up table).</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: No </span><span class="si">{</span><span class="n">yfcd</span><span class="o">.</span><span class="n">intervalToString</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">]</span><span class="si">}</span><span class="s2">-price data fetched for </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">h2_pre</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">range_post</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">td_1d</span><span class="o">*</span><span class="mi">7</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">td_1d</span><span class="o">*</span><span class="mi">3</span><span class="p">):</span>
                    <span class="c1"># Small date range, potentially trying to fetch before listing data</span>
                    <span class="n">h2_pre</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>

        <span class="k">if</span> <span class="n">range_post</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">range_post</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">h2_post</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetchYfHistory</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">prepost</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">NoPriceDataInRangeException</span><span class="p">:</span>
                <span class="c1"># If only trying to fetch 1 day of 1d data, then print warning instead of exception.</span>
                <span class="c1"># Could add additional condition of dividend previous day (seems to mess up table).</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span> <span class="ow">and</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">td_1d</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: No </span><span class="si">{</span><span class="n">yfcd</span><span class="o">.</span><span class="n">intervalToString</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">]</span><span class="si">}</span><span class="s2">-price data fetched for </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">h2_post</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>

        <span class="n">listing_date</span> <span class="o">=</span> <span class="n">yfcm</span><span class="o">.</span><span class="n">ReadCacheDatum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;listing_date&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">listing_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">listing_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">history_metadata</span><span class="p">[</span><span class="s2">&quot;firstTradeDate&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">listing_date</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">listing_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">listing_date</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="n">tz_exchange</span><span class="p">)</span>
            <span class="n">yfcm</span><span class="o">.</span><span class="n">StoreCacheDatum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;listing_date&quot;</span><span class="p">,</span> <span class="n">listing_date</span><span class="o">.</span><span class="n">date</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">h2_post</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># De-adjust the new data, and backport any new events in cached data</span>
            <span class="c1"># Note: Yahoo always returns split-adjusted price, so reverse it</span>

            <span class="c1"># Simple append to bottom of table</span>
            <span class="c1"># 1) adjust h2_post</span>
            <span class="n">h2_post</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reverseYahooAdjust</span><span class="p">(</span><span class="n">h2_post</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">debug_yfc</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- h2_post:&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">h2_post</span><span class="p">)</span>

            <span class="c1"># TODO: Problem: dividends need correct close</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span><span class="p">:</span>
                <span class="n">h2_post_splits</span> <span class="o">=</span> <span class="n">h2_post</span><span class="p">[</span><span class="n">h2_post</span><span class="p">[</span><span class="s2">&quot;Stock Splits&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">][[</span><span class="s2">&quot;Stock Splits&quot;</span><span class="p">,</span> <span class="s2">&quot;FetchDate&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">h2_post_splits</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">GetHistory</span><span class="p">(</span><span class="s2">&quot;Events&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">UpdateSplits</span><span class="p">(</span><span class="n">h2_post_splits</span><span class="p">)</span>
                <span class="c1"># Update: moving UpdateDividends() to after repair</span>

            <span class="c1"># Backport new events across entire h table</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_applyNewEvents</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">h2_post</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">h2_post</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;h2_post.index not DatetimeIndex&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;Adj Close&quot;</span> <span class="ow">in</span> <span class="n">h2_post</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Adj Close in h2_post&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">h2_post</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">columns</span><span class="p">]])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="n">tz_exchange</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">h2_pre</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">debug_yfc</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- prepending new data&quot;</span><span class="p">)</span>
            <span class="c1"># Simple prepend to top of table</span>

            <span class="n">h2_pre</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reverseYahooAdjust</span><span class="p">(</span><span class="n">h2_pre</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span><span class="p">:</span>
                <span class="n">h2_pre_splits</span> <span class="o">=</span> <span class="n">h2_pre</span><span class="p">[</span><span class="n">h2_pre</span><span class="p">[</span><span class="s2">&quot;Stock Splits&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">][[</span><span class="s2">&quot;Stock Splits&quot;</span><span class="p">,</span> <span class="s2">&quot;FetchDate&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">h2_pre_splits</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">GetHistory</span><span class="p">(</span><span class="s2">&quot;Events&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">UpdateSplits</span><span class="p">(</span><span class="n">h2_pre_splits</span><span class="p">)</span>

            <span class="c1"># h2_pre = h2_pre.drop([&quot;Dividends&quot;, &quot;Stock Splits&quot;], axis=1)</span>
            <span class="k">if</span> <span class="s2">&quot;Adj Close&quot;</span> <span class="ow">in</span> <span class="n">h2_pre</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Adj Close in h2_pre&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">h2_pre</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">columns</span><span class="p">]])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="n">tz_exchange</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_updatedCachedPrices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

        <span class="n">log_msg</span> <span class="o">=</span> <span class="s2">&quot;_fetchAndAddRanges_contiguous() returning&quot;</span>
        <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">():</span>
            <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceExit</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">debug_yfc</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- h:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_fetchAndAddRanges_sparse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ranges_to_fetch</span><span class="p">,</span> <span class="n">prepost</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckIterable</span><span class="p">(</span><span class="n">ranges_to_fetch</span><span class="p">,</span> <span class="s2">&quot;ranges_to_fetch&quot;</span><span class="p">)</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckBool</span><span class="p">(</span><span class="n">prepost</span><span class="p">,</span> <span class="s2">&quot;prepost&quot;</span><span class="p">)</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckBool</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s2">&quot;debug&quot;</span><span class="p">)</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckBool</span><span class="p">(</span><span class="n">quiet</span><span class="p">,</span> <span class="s2">&quot;quiet&quot;</span><span class="p">)</span>

        <span class="c1"># Fetch each range, but can be careless regarding de-adjust because</span>
        <span class="c1"># getting events from the carefully-managed daily data</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ranges_to_fetch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">ranges_to_fetch</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># return h</span>
            <span class="k">return</span>

        <span class="n">debug_yfc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span>
        <span class="c1"># debug_yfc = True</span>

        <span class="n">log_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_fetchAndAddRanges_sparse(prepost=</span><span class="si">{</span><span class="n">prepost</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">():</span>
            <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceEnter</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">debug_yfc</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>

        <span class="n">tz_exchange</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tz</span>
        <span class="n">td_1d</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dtnow</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="n">tz_exchange</span><span class="p">)</span>

        <span class="c1"># Backport events that occurred since last adjustment:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_applyNewEvents</span><span class="p">()</span>

        <span class="c1"># Ensure have daily data covering all ranges_to_fetch, so they can be de-splitted</span>
        <span class="n">r_start_earliest</span> <span class="o">=</span> <span class="n">ranges_to_fetch</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">rstart</span><span class="p">,</span> <span class="n">rend</span> <span class="ow">in</span> <span class="n">ranges_to_fetch</span><span class="p">:</span>
            <span class="n">r_start_earliest</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">rstart</span><span class="p">,</span> <span class="n">r_start_earliest</span><span class="p">)</span>
        <span class="n">r_start_earliest_d</span> <span class="o">=</span> <span class="n">r_start_earliest</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r_start_earliest</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)</span> <span class="k">else</span> <span class="n">r_start_earliest</span>
        <span class="k">if</span> <span class="n">debug_yfc</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- r_start_earliest = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r_start_earliest</span><span class="p">))</span>
        <span class="c1"># Trigger price sync:</span>
        <span class="n">histDaily</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">GetHistory</span><span class="p">(</span><span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span><span class="p">)</span>
        <span class="c1"># histDaily.get(start=r_start_earliest_d, max_age=td_1d)</span>
        <span class="n">histDaily</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">r_start_earliest_d</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="n">td_1d</span><span class="p">,</span> <span class="n">repair</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Fetch each range, and adjust for splits that occurred after</span>
        <span class="k">for</span> <span class="n">rstart</span><span class="p">,</span> <span class="n">rend</span> <span class="ow">in</span> <span class="n">ranges_to_fetch</span><span class="p">:</span>
            <span class="n">fetch_start</span> <span class="o">=</span> <span class="n">rstart</span>
            <span class="n">fetch_end</span> <span class="o">=</span> <span class="n">rend</span>
            <span class="c1"># if not self.interday:  # and fetch_start.date() == fetch_end.date():</span>
            <span class="c1">#     # Intraday fetches behave better when time = midnight</span>
            <span class="c1">#     fetch_start = fetch_start.floor(&quot;1D&quot;)</span>
            <span class="c1">#     fetch_end = fetch_end.ceil(&quot;1D&quot;)</span>
            <span class="c1"># Update: data reliability now fixed by ChunkDatesIntoYfFetches()</span>
            <span class="k">if</span> <span class="n">debug_yfc</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- fetching </span><span class="si">{}</span><span class="s2"> -&gt; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fetch_start</span><span class="p">,</span> <span class="n">fetch_end</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">h2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetchYfHistory</span><span class="p">(</span><span class="n">fetch_start</span><span class="p">,</span> <span class="n">fetch_end</span><span class="p">,</span> <span class="n">prepost</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">NoPriceDataInRangeException</span><span class="p">:</span>
                <span class="c1"># If only trying to fetch 1 day of 1d data, then print warning instead of exception.</span>
                <span class="c1"># Could add additional condition of dividend previous day (seems to mess up table).</span>
                <span class="n">ignore</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span> <span class="ow">and</span> <span class="n">fetch_end</span> <span class="o">-</span> <span class="n">fetch_start</span> <span class="o">==</span> <span class="n">td_1d</span><span class="p">:</span>
                    <span class="n">ignore</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">intraday</span> <span class="ow">and</span> <span class="n">fetch_start</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">==</span> <span class="n">dtnow</span><span class="o">.</span><span class="n">date</span><span class="p">():</span>
                    <span class="n">ignore</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Mins1</span> <span class="ow">and</span> <span class="n">fetch_end</span> <span class="o">-</span> <span class="n">fetch_start</span> <span class="o">&lt;=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
                    <span class="n">ignore</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">ignore</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                        <span class="c1"># print(&quot;WARNING: No {}-price data fetched for ticker {} between dates {} -&gt; {}&quot;.format(yfcd.intervalToString[self.interval], self.ticker, rstart, rend))</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: No </span><span class="si">{</span><span class="n">yfcd</span><span class="o">.</span><span class="n">intervalToString</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">]</span><span class="si">}</span><span class="s2">-price data fetched for </span><span class="si">{</span><span class="n">rstart</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">rend</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">h2</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>

            <span class="k">if</span> <span class="n">h2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># raise Exception(&quot;YF returned None for: tkr={}, interval={}, start={}, end={}&quot;.format(self.ticker, self.interval, rstart, rend))</span>
                <span class="c1"># raise Exception(f&quot;yfinance.history() returned None ({self.ticker} {self.istr} {rstart}-&gt;{rend})&quot;)</span>
                <span class="k">raise</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">NoPriceDataInRangeException</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="p">,</span> <span class="n">rstart</span><span class="p">,</span> <span class="n">rend</span><span class="p">)</span>
                <span class="c1"># raise Exception(f&quot;yfinance.history() returned None ({self.ticker} {self.istr} {fetch_start}-&gt;{fetch_end})&quot;)</span>

            <span class="c1"># Ensure h2 is split-adjusted. Sometimes Yahoo returns unadjusted data</span>
            <span class="n">h2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reverseYahooAdjust</span><span class="p">(</span><span class="n">h2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">debug_yfc</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- h2 adjusted:&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">h2</span><span class="p">[[</span><span class="s2">&quot;Close&quot;</span><span class="p">,</span> <span class="s2">&quot;Dividends&quot;</span><span class="p">,</span> <span class="s2">&quot;Volume&quot;</span><span class="p">,</span> <span class="s2">&quot;CSF&quot;</span><span class="p">,</span> <span class="s2">&quot;CDF&quot;</span><span class="p">]])</span>

            <span class="k">if</span> <span class="n">fetch_start</span> <span class="o">!=</span> <span class="n">rstart</span><span class="p">:</span>
                <span class="n">h2</span> <span class="o">=</span> <span class="n">h2</span><span class="p">[</span><span class="n">h2</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">rstart</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">fetch_end</span> <span class="o">!=</span> <span class="n">rend</span><span class="p">:</span>
                <span class="n">h2</span> <span class="o">=</span> <span class="n">h2</span><span class="p">[</span><span class="n">h2</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">rend</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">itd</span><span class="p">]</span>

            <span class="k">if</span> <span class="s2">&quot;Adj Close&quot;</span> <span class="ow">in</span> <span class="n">h2</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Adj Close in h2&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="n">yfcu</span><span class="o">.</span><span class="n">np_isin_optimised</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">h2</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;self.h.shape:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;h2.shape:&quot;</span><span class="p">,</span> <span class="n">h2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="k">raise</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">h2</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">columns</span><span class="p">]])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="n">tz_exchange</span><span class="p">)</span>

            <span class="n">f_dups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">f_dups</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: Adding range </span><span class="si">{</span><span class="n">rstart</span><span class="si">}</span><span class="s2">-&gt;</span><span class="si">{</span><span class="n">rend</span><span class="si">}</span><span class="s2"> has added duplicate timepoints have been duplicated: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">f_dups</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_updatedCachedPrices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

        <span class="n">log_msg</span> <span class="o">=</span> <span class="s2">&quot;_fetchAndAddRanges_sparse() returning&quot;</span>
        <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">():</span>
            <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceExit</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">debug_yfc</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_verifyCachedPrices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span> <span class="n">vol_rtol</span><span class="o">=</span><span class="mf">0.004</span><span class="p">,</span> <span class="n">correct</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">discard_old</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">correct_values</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">correct</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">correct_values</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;correct&#39; must be one of: </span><span class="si">{</span><span class="n">correct_values</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckBool</span><span class="p">(</span><span class="n">discard_old</span><span class="p">,</span> <span class="s2">&quot;discard_old&quot;</span><span class="p">)</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckBool</span><span class="p">(</span><span class="n">quiet</span><span class="p">,</span> <span class="s2">&quot;quiet&quot;</span><span class="p">)</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckBool</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s2">&quot;debug&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">quiet</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceEnter</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PM::_verifyCachedPrices-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="si">}</span><span class="s2">(correct=</span><span class="si">{</span><span class="n">correct</span><span class="si">}</span><span class="s2">, debug=</span><span class="si">{</span><span class="n">debug</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="c1"># New code: hopefully this will correct bad CDF in 1wk etc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_applyNewEvents</span><span class="p">()</span>

        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># working copy for comparison with YF</span>
        <span class="n">h_modified</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">h_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># copy for storing changes</span>
        <span class="c1"># Keep track of problems:</span>
        <span class="n">f_diff_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">False</span><span class="p">),</span> <span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Ignore non-final data because will differ to Yahoo</span>
        <span class="n">h_lastRow</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Apply stock-split adjustment to match YF</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Open&quot;</span><span class="p">,</span> <span class="s2">&quot;Close&quot;</span><span class="p">,</span> <span class="s2">&quot;Low&quot;</span><span class="p">,</span> <span class="s2">&quot;High&quot;</span><span class="p">,</span> <span class="s2">&quot;Dividends&quot;</span><span class="p">]:</span>
            <span class="n">h</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">*</span> <span class="n">h</span><span class="p">[</span><span class="s2">&quot;CSF&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">h</span><span class="p">[</span><span class="s2">&quot;Volume&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;Volume&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">/</span> <span class="n">h</span><span class="p">[</span><span class="s2">&quot;CSF&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>

        <span class="n">td_1d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s2">&quot;1D&quot;</span><span class="p">)</span>
        <span class="n">dt_now</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="n">ZoneInfo</span><span class="p">(</span><span class="s2">&quot;UTC&quot;</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">_aggregate_yfdf_daily</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
            <span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">df2</span><span class="p">[</span><span class="s2">&quot;_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span>
            <span class="n">df2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df2</span><span class="p">[</span><span class="s2">&quot;Stock Splits&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Stock Splits&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="s2">&quot;CDF&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">df2</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;_date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
                    <span class="n">Open</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Open&quot;</span><span class="p">,</span> <span class="s2">&quot;first&quot;</span><span class="p">),</span>
                    <span class="n">Close</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Close&quot;</span><span class="p">,</span> <span class="s2">&quot;last&quot;</span><span class="p">),</span>
                    <span class="n">Low</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Low&quot;</span><span class="p">,</span> <span class="s2">&quot;min&quot;</span><span class="p">),</span>
                    <span class="n">High</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;High&quot;</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">),</span>
                    <span class="n">Volume</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Volume&quot;</span><span class="p">,</span> <span class="s2">&quot;sum&quot;</span><span class="p">),</span>
                    <span class="n">Dividends</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Dividends&quot;</span><span class="p">,</span> <span class="s2">&quot;sum&quot;</span><span class="p">),</span>
                    <span class="n">StockSplits</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Stock Splits&quot;</span><span class="p">,</span> <span class="s2">&quot;prod&quot;</span><span class="p">),</span>
                    <span class="n">CDF</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;CDF&quot;</span><span class="p">,</span> <span class="s2">&quot;prod&quot;</span><span class="p">),</span>
                    <span class="n">CSF</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;CSF&quot;</span><span class="p">,</span> <span class="s2">&quot;prod&quot;</span><span class="p">),</span>
                    <span class="n">FetchDate</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;FetchDate&quot;</span><span class="p">,</span> <span class="s2">&quot;first&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;StockSplits&quot;</span><span class="p">:</span> <span class="s2">&quot;Stock Splits&quot;</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df2</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;_date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
                    <span class="n">Open</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Open&quot;</span><span class="p">,</span> <span class="s2">&quot;first&quot;</span><span class="p">),</span>
                    <span class="n">Close</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Close&quot;</span><span class="p">,</span> <span class="s2">&quot;last&quot;</span><span class="p">),</span>
                    <span class="n">AdjClose</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Adj Close&quot;</span><span class="p">,</span> <span class="s2">&quot;last&quot;</span><span class="p">),</span>
                    <span class="n">Low</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Low&quot;</span><span class="p">,</span> <span class="s2">&quot;min&quot;</span><span class="p">),</span>
                    <span class="n">High</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;High&quot;</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">),</span>
                    <span class="n">Volume</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Volume&quot;</span><span class="p">,</span> <span class="s2">&quot;sum&quot;</span><span class="p">),</span>
                    <span class="n">Dividends</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Dividends&quot;</span><span class="p">,</span> <span class="s2">&quot;sum&quot;</span><span class="p">),</span>
                    <span class="n">StockSplits</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Stock Splits&quot;</span><span class="p">,</span> <span class="s2">&quot;prod&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;StockSplits&quot;</span><span class="p">:</span> <span class="s2">&quot;Stock Splits&quot;</span><span class="p">,</span> <span class="s2">&quot;AdjClose&quot;</span><span class="p">:</span> <span class="s2">&quot;Adj Close&quot;</span><span class="p">})</span>
            <span class="n">df2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df2</span><span class="p">[</span><span class="s2">&quot;Stock Splits&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Stock Splits&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">df2</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span>
            <span class="n">df2</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df2</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df2</span>

        <span class="c1"># For intraday data older than Yahoo limit, compare aggregated against 1d</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">intraday</span><span class="p">:</span>
            <span class="n">dt_now_local</span> <span class="o">=</span> <span class="n">dt_now</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tzName</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Hours1</span><span class="p">:</span>
                <span class="n">max_lookback_days</span> <span class="o">=</span> <span class="mi">365</span><span class="o">*</span><span class="mi">2</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Mins1</span><span class="p">:</span>
                <span class="c1"># max_lookback_days = 7</span>
                <span class="n">max_lookback_days</span> <span class="o">=</span> <span class="mi">30</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">max_lookback_days</span> <span class="o">=</span> <span class="mi">60</span>
            <span class="n">max_lookback</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">max_lookback_days</span><span class="p">)</span>
            <span class="n">max_lookback</span> <span class="o">-=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># allow time for server processing</span>
            <span class="n">fetch_start_min</span> <span class="o">=</span> <span class="n">dt_now_local</span> <span class="o">-</span> <span class="n">max_lookback</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">intraday</span><span class="p">:</span>
                <span class="n">fetch_start_min</span> <span class="o">=</span> <span class="n">fetch_start_min</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="s2">&quot;1D&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">fetch_start_min</span><span class="p">:</span>
                <span class="c1"># h_old = h.loc[:fetch_start_min-timedelta(seconds=1)]</span>
                <span class="c1"># h_old_1d = _aggregate_yfdf_daily(h_old.drop([&quot;Final?&quot;, &quot;C-Check?&quot;, &quot;LastDivAdjustDt&quot;, &quot;LastSplitAdjustDt&quot;], axis=1))</span>

                <span class="c1"># if self.interval == yfcd.Interval.Hours1:</span>
                <span class="c1">#     df_yf = self.dat.history(interval=&quot;1d&quot;, start=h_old.index[0].date(), end=h_old.index[-1].date()+td_1d, auto_adjust=False, repair=&quot;silent&quot;)</span>
                <span class="c1"># else:</span>
                <span class="c1">#     df_yf = self.dat.history(interval=&quot;1h&quot;, start=h_old.index[0].date(), end=h_old.index[-1].date()+td_1d, auto_adjust=False, repair=&quot;silent&quot;)</span>
                <span class="c1">#     df_yf = _aggregate_yfdf_daily(df_yf)</span>

                <span class="c1"># # Aggregated data will almost always differ from actual daily, so only</span>
                <span class="c1"># # look for big errors</span>
                <span class="c1"># f_old_diff = yfcu.VerifyPricesDf(h_old_1d, df_yf, self.interval, rtol=0.2, debug=True)</span>
                <span class="c1"># raise Exception(&quot;- investigate&quot;)</span>
                <span class="c1"># f_old_diff = yfcu.VerifyPricesDf(h_old_1d, df_yf, self.interval, rtol=0.2)</span>
                <span class="c1"># if f_old_diff.any():</span>
                <span class="c1">#     msg = f&quot;Significant differences detected between old {self.istr} data and 1d.&quot;</span>
                <span class="c1">#     print()</span>
                <span class="c1">#     # f_diff_all = f_diff_all | f_old_diff</span>
                <span class="c1">#     bad_dates = f_old_diff.index.date[f_old_diff]</span>
                <span class="c1">#     f_diff_all[np.isin(f_diff_all.index.date, bad_dates)] = True</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">discard_old</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: Some </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="si">}</span><span class="s2"> data is now older than </span><span class="si">{</span><span class="n">max_lookback_days</span><span class="si">}</span><span class="s2"> days&quot;</span> <span class="o">+</span>\
                            <span class="s2">&quot; so cannot compare to Yahoo. Discard old data?&quot;</span>
                    <span class="n">discard_old</span> <span class="o">=</span> <span class="n">click</span><span class="o">.</span><span class="n">confirm</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">discard_old</span><span class="p">:</span>
                    <span class="n">f_discard</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">fetch_start_min</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">f_discard</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Discarding </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">f_discard</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> old rows because can&#39;t verify (fetch_start_min=</span><span class="si">{</span><span class="n">fetch_start_min</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                        <span class="n">f_diff_all</span> <span class="o">=</span> <span class="n">f_diff_all</span> <span class="o">|</span> <span class="n">f_discard</span>
                        <span class="n">f_diff_all</span> <span class="o">=</span> <span class="n">f_diff_all</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;Discard&quot;</span><span class="p">)</span>

                <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">fetch_start_min</span><span class="p">:]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span><span class="p">:</span>
            <span class="c1"># Also verify dividends</span>
            <span class="n">divs_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">GetHistory</span><span class="p">(</span><span class="s2">&quot;Events&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">GetDivs</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">divs_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">divs_df</span> <span class="o">=</span> <span class="n">divs_df</span><span class="p">[(</span><span class="n">divs_df</span><span class="p">[</span><span class="s1">&#39;Dividends&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()]</span>
                <span class="k">if</span> <span class="n">divs_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="n">divs_df</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">h</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="c1"># Fetch YF data</span>
            <span class="n">start_dt</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">last_dt</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">end_dt</span> <span class="o">=</span> <span class="n">last_dt</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">itd</span>
            <span class="n">fetch_start</span> <span class="o">=</span> <span class="n">start_dt</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">itd</span> <span class="o">&gt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">fetch_end</span> <span class="o">=</span> <span class="n">last_dt</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">+</span><span class="n">yfcd</span><span class="o">.</span><span class="n">intervalToTimedelta</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fetch_end</span> <span class="o">=</span> <span class="n">last_dt</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">+</span><span class="n">td_1d</span>
            <span class="c1"># Sometimes Yahoo doesn&#39;t return full trading data for last day if end = day after.</span>
            <span class="c1"># Add some more days to avoid problem.</span>
            <span class="n">fetch_end</span> <span class="o">+=</span> <span class="mi">3</span><span class="o">*</span><span class="n">td_1d</span>
            <span class="n">fetch_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">fetch_end</span><span class="p">,</span> <span class="n">dt_now</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tzName</span><span class="p">)</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">())</span>
            <span class="n">repair</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">intraday</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Mins1</span><span class="p">:</span>
                    <span class="c1"># Fetch in 7-day batches</span>
                    <span class="n">df_yf</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">td_7d</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
                    <span class="n">fetch_end_batch</span> <span class="o">=</span> <span class="n">fetch_end</span>
                    <span class="n">fetch_start_batch</span> <span class="o">=</span> <span class="n">fetch_end</span> <span class="o">-</span> <span class="n">td_7d</span>
                    <span class="k">while</span> <span class="n">fetch_end_batch</span> <span class="o">&gt;</span> <span class="n">fetch_start</span><span class="p">:</span>
                        <span class="n">df_yf_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">interval</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">fetch_start_batch</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">fetch_end_batch</span><span class="p">,</span> <span class="n">auto_adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">repair</span><span class="o">=</span><span class="n">repair</span><span class="p">,</span> <span class="n">keepna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">if</span> <span class="s2">&quot;Repaired?&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_yf_batch</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                            <span class="n">df_yf_batch</span><span class="p">[</span><span class="s2">&quot;Repaired?&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="n">df_yf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">df_yf</span> <span class="o">=</span> <span class="n">df_yf_batch</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">df_yf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_yf</span><span class="p">,</span> <span class="n">df_yf_batch</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="c1">#</span>
                        <span class="n">fetch_end_batch</span> <span class="o">-=</span> <span class="n">td_7d</span>
                        <span class="n">fetch_start_batch</span> <span class="o">-=</span> <span class="n">td_7d</span>
                        <span class="n">fetch_start_batch</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">fetch_start_batch</span><span class="p">,</span> <span class="n">fetch_start</span><span class="p">)</span>
                    <span class="c1">#</span>
                    <span class="n">df_yf</span> <span class="o">=</span> <span class="n">df_yf</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df_yf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">interval</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">fetch_start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">fetch_end</span><span class="p">,</span> <span class="n">auto_adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">repair</span><span class="o">=</span><span class="n">repair</span><span class="p">,</span> <span class="n">keepna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s2">&quot;Repaired?&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_yf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="n">df_yf</span><span class="p">[</span><span class="s2">&quot;Repaired?&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">df_yf</span> <span class="o">=</span> <span class="n">df_yf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">start_dt</span><span class="p">:]</span>
                    <span class="n">df_yf</span> <span class="o">=</span> <span class="n">df_yf</span><span class="p">[</span><span class="n">df_yf</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">end_dt</span><span class="p">]</span>

                <span class="c1"># Yahoo doesn&#39;t div-adjust intraday</span>
                <span class="n">df_yf_1d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">interval</span><span class="o">=</span><span class="s2">&quot;1d&quot;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">df_yf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">(),</span> <span class="n">end</span><span class="o">=</span><span class="n">df_yf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">+</span><span class="n">td_1d</span><span class="p">,</span> <span class="n">auto_adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;Repaired?&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_yf_1d</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">df_yf_1d</span><span class="p">[</span><span class="s2">&quot;Repaired?&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">df_yf</span><span class="p">[</span><span class="s2">&quot;_indexBackup&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_yf</span><span class="o">.</span><span class="n">index</span>
                <span class="n">df_yf</span><span class="p">[</span><span class="s2">&quot;_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_yf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span>
                <span class="n">df_yf_1d</span><span class="p">[</span><span class="s2">&quot;_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_yf_1d</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span>
                <span class="c1">#</span>
                <span class="n">df_yf_1d</span><span class="p">[</span><span class="s2">&quot;Adj&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_yf_1d</span><span class="p">[</span><span class="s2">&quot;Adj Close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">/</span> <span class="n">df_yf_1d</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="n">df_yf</span> <span class="o">=</span> <span class="n">df_yf</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_yf_1d</span><span class="p">[[</span><span class="s2">&quot;Adj&quot;</span><span class="p">,</span> <span class="s2">&quot;_date&quot;</span><span class="p">]],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;_date&quot;</span><span class="p">)</span>
                <span class="n">df_yf</span><span class="p">[</span><span class="s2">&quot;Adj Close&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_yf</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">*</span> <span class="n">df_yf</span><span class="p">[</span><span class="s2">&quot;Adj&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="n">df_yf</span> <span class="o">=</span> <span class="n">df_yf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;Adj&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1">#</span>
                <span class="n">df_yf</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df_yf</span><span class="p">[</span><span class="s2">&quot;_indexBackup&quot;</span><span class="p">]</span>
                <span class="n">df_yf</span> <span class="o">=</span> <span class="n">df_yf</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;_indexBackup&quot;</span><span class="p">,</span> <span class="s2">&quot;_date&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span> <span class="ow">and</span> <span class="n">divs_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">divs_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="c1"># Also use YF data to verify dividends.</span>
                    <span class="n">fetch_start</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">fetch_start</span><span class="p">,</span> <span class="n">divs_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">())</span>
                <span class="n">df_yf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">interval</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">fetch_start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">fetch_end</span><span class="p">,</span> <span class="n">auto_adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">repair</span><span class="o">=</span><span class="n">repair</span><span class="p">,</span> <span class="n">keepna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;Repaired?&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_yf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">df_yf</span><span class="p">[</span><span class="s2">&quot;Repaired?&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">df_yf</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: YF fetch failed for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">fetch_start</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">fetch_end</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># Make special adjustments for dividends / stock splits released TODAY</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">df_yf</span><span class="p">[</span><span class="s2">&quot;Dividends&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> <span class="n">df_yf</span><span class="p">[</span><span class="s2">&quot;Dividends&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">expect_new_div_missing</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">df_yf</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                            <span class="n">expect_new_div_missing</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">elif</span> <span class="n">h_lastRow</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">df_yf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">h_lastRow</span><span class="p">[</span><span class="s2">&quot;Dividends&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                            <span class="n">expect_new_div_missing</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="n">expect_new_div_missing</span><span class="p">:</span>
                            <span class="c1"># YFC won&#39;t have record of this dividend because occurs tonight/tomorrow, so remove it&#39;s adjustment from prices</span>
                            <span class="n">rev_adj</span> <span class="o">=</span> <span class="n">df_yf</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">df_yf</span><span class="p">[</span><span class="s2">&quot;Adj Close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;- removing dividend from df_yf-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">df_yf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> adj=</span><span class="si">{</span><span class="mf">1.0</span><span class="o">/</span><span class="n">rev_adj</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">()</span> <span class="k">else</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: &quot;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>
                            <span class="n">df_yf</span><span class="p">[</span><span class="s2">&quot;Adj Close&quot;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">rev_adj</span>
                            <span class="n">df_yf</span> <span class="o">=</span> <span class="n">df_yf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">df_yf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">df_yf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">h_lastRow</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="n">df_yf</span><span class="p">[</span><span class="s2">&quot;Stock Splits&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">h_lastRow</span><span class="p">[</span><span class="s2">&quot;Stock Splits&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># YFC doesn&#39;t have record of today&#39;s split yet so remove effect</span>
                        <span class="n">rev_adj</span> <span class="o">=</span> <span class="n">df_yf</span><span class="p">[</span><span class="s2">&quot;Stock Splits&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;- removing split from df_yf-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">df_yf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> adj=</span><span class="si">{</span><span class="mf">1.0</span><span class="o">/</span><span class="n">rev_adj</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">()</span> <span class="k">else</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: &quot;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Open&quot;</span><span class="p">,</span> <span class="s2">&quot;High&quot;</span><span class="p">,</span> <span class="s2">&quot;Low&quot;</span><span class="p">,</span> <span class="s2">&quot;Close&quot;</span><span class="p">,</span> <span class="s2">&quot;Adj Close&quot;</span><span class="p">]:</span>
                            <span class="n">df_yf</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*=</span> <span class="n">rev_adj</span>
                        <span class="n">df_yf</span><span class="p">[</span><span class="s2">&quot;Volume&quot;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">rev_adj</span>
                        <span class="n">df_yf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_yf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;Stock Splits&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="k">if</span> <span class="n">df_yf</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">df_yf</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fetching reference yfinance data failed (interval=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="si">}</span><span class="s2">, start_dt=</span><span class="si">{</span><span class="n">start_dt</span><span class="si">}</span><span class="s2">, last_dt=</span><span class="si">{</span><span class="n">last_dt</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Week</span><span class="p">:</span>
                <span class="c1"># Ensure data aligned to Monday:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">df_yf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">while</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">fetch_start</span> <span class="o">-=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                        <span class="n">df_yf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">interval</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">fetch_start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">fetch_end</span><span class="p">,</span> <span class="n">auto_adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">repair</span><span class="o">=</span><span class="n">repair</span><span class="p">)</span>
                        <span class="k">if</span> <span class="s2">&quot;Repaired?&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_yf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                            <span class="n">df_yf</span><span class="p">[</span><span class="s2">&quot;Repaired?&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">df_yf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">df_yf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to get Monday-aligned weekly data from YF&quot;</span><span class="p">)</span>
                    <span class="n">df_yf</span> <span class="o">=</span> <span class="n">df_yf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]:]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span><span class="p">:</span>
                <span class="c1"># Volume not split-adjusted</span>
                <span class="n">ss</span> <span class="o">=</span> <span class="n">df_yf</span><span class="p">[</span><span class="s2">&quot;Stock Splits&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">ss</span><span class="p">[(</span><span class="n">ss</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">|</span> <span class="n">ss</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">ss_rcp</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">ss</span>
                <span class="n">csf</span> <span class="o">=</span> <span class="n">ss_rcp</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
                <span class="n">df_yf</span><span class="p">[</span><span class="s2">&quot;Volume&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_yf</span><span class="p">[</span><span class="s2">&quot;Volume&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">/</span> <span class="n">csf</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">!=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span> <span class="ow">and</span> <span class="n">correct</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">]:</span>
                <span class="c1"># Copy over any missing dividends</span>
                <span class="n">c</span> <span class="o">=</span> <span class="s2">&quot;Dividends&quot;</span>
                <span class="n">h_divs</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">h</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
                <span class="n">yf_divs</span> <span class="o">=</span> <span class="n">df_yf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_yf</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span>
                <span class="n">dts_missing_from_cache</span> <span class="o">=</span> <span class="n">yf_divs</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">~</span><span class="n">yf_divs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">h_divs</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
                <span class="n">dts_missing_from_cache</span> <span class="o">=</span> <span class="p">[</span><span class="n">dt</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">dts_missing_from_cache</span> <span class="k">if</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dts_missing_from_cache</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;CORRECTING: Cache missing these dividends: </span><span class="si">{</span><span class="n">dts_missing_from_cache</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">()</span> <span class="k">else</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: &quot;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">dts_missing_from_cache</span><span class="p">:</span>
                        <span class="c1"># Correct here</span>
                        <span class="n">h</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">yf_divs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span>
                        <span class="n">h_new</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">yf_divs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span>
                        <span class="n">h_modified</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="c1"># Copy over any missing stock splits</span>
                <span class="n">c</span> <span class="o">=</span> <span class="s2">&quot;Stock Splits&quot;</span>
                <span class="n">h_ss</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">h</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
                <span class="n">yf_ss</span> <span class="o">=</span> <span class="n">df_yf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_yf</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span>
                <span class="n">dts_missing_from_cache</span> <span class="o">=</span> <span class="n">yf_ss</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">~</span><span class="n">yf_ss</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">h_ss</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
                <span class="n">dts_missing_from_cache</span> <span class="o">=</span> <span class="p">[</span><span class="n">dt</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">dts_missing_from_cache</span> <span class="k">if</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dts_missing_from_cache</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;CORRECTING: Cache missing these stock splits: </span><span class="si">{</span><span class="n">dts_missing_from_cache</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">()</span> <span class="k">else</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: &quot;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">dts_missing_from_cache</span><span class="p">:</span>
                        <span class="c1"># Correct here</span>
                        <span class="n">h</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">yf_ss</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span>
                        <span class="n">h_new</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">yf_ss</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span>
                        <span class="n">h_modified</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span> <span class="ow">and</span> <span class="n">divs_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">divs_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="c1"># Verify dividends</span>
                <span class="n">yf_divs</span> <span class="o">=</span> <span class="n">df_yf</span><span class="p">[</span><span class="s1">&#39;Dividends&#39;</span><span class="p">][</span><span class="n">df_yf</span><span class="p">[</span><span class="s1">&#39;Dividends&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mf">0.0</span><span class="p">]</span>
                <span class="n">f_orphan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">divs_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">divs_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">div_dt</span> <span class="o">=</span> <span class="n">divs_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">div_dt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">yf_divs</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                        <span class="n">f_orphan</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">f_orphan</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">correct</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">]:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Dropping these orphan dividends: </span><span class="si">{</span><span class="n">divs_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span><span class="p">[</span><span class="n">f_orphan</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">orphan_divs</span> <span class="o">=</span> <span class="n">divs_df</span><span class="p">[</span><span class="n">f_orphan</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">orphan_divs</span><span class="p">[</span><span class="s1">&#39;Dividends&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="n">orphan_divs</span><span class="p">[</span><span class="s1">&#39;Close day before&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
                        <span class="c1"># print(&quot;- divs_df:&quot;) ; print(divs_df[[&#39;Dividends&#39;, &#39;Superseded div&#39;]])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">GetHistory</span><span class="p">(</span><span class="s2">&quot;Events&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">UpdateDividends</span><span class="p">(</span><span class="n">orphan_divs</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                            <span class="n">divs_orphan</span> <span class="o">=</span> <span class="n">divs_df</span><span class="p">[</span><span class="n">f_orphan</span><span class="p">][[</span><span class="s1">&#39;Dividends&#39;</span><span class="p">]]</span>
                            <span class="n">divs_orphan</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">divs_orphan</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;- detected orphan dividends:&#39;</span><span class="p">,</span> <span class="n">divs_orphan</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
                        <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">divs_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">f_orphan</span><span class="p">]:</span>
                            <span class="n">f_diff_all</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">f_diff</span> <span class="o">=</span> <span class="n">yfcu</span><span class="o">.</span><span class="n">VerifyPricesDf</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">df_yf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="n">rtol</span><span class="p">,</span> <span class="n">vol_rtol</span><span class="o">=</span><span class="n">vol_rtol</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="n">quiet</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">f_diff</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">f_diff_all</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="n">f_diff_all</span> <span class="o">=</span> <span class="p">(</span><span class="n">f_diff_all</span> <span class="o">|</span> <span class="n">f_diff</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">f_diff</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">f_diff_all</span> <span class="o">=</span> <span class="n">f_diff_all</span> <span class="o">|</span> <span class="n">f_diff</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">f_diff_all</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">h_modified</span><span class="p">:</span>
                <span class="c1"># yfcm.StoreCacheDatum(self.ticker, self.cache_key, h)</span>
                <span class="n">yfcm</span><span class="o">.</span><span class="n">StoreCacheDatum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">h_new</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getCachedPrices</span><span class="p">()</span>

            <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceExit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PM::_verifyCachedPrices-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="si">}</span><span class="s2">() returning True&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="n">h</span> <span class="o">=</span> <span class="n">h_new</span>
        <span class="k">if</span> <span class="n">correct</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">]:</span>
            <span class="n">drop_dts</span> <span class="o">=</span> <span class="n">f_diff_all</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">f_diff_all</span><span class="p">]</span>
            <span class="n">drop_dts_ages</span> <span class="o">=</span> <span class="n">dt_now</span> <span class="o">-</span> <span class="n">drop_dts</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Week</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">drop_dts_ages</span> <span class="o">&gt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">drop_dts_ages</span> <span class="o">&gt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>  <span class="c1"># allow for weekend</span>
            <span class="n">drop_dts_not_recent</span> <span class="o">=</span> <span class="n">drop_dts</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
            <span class="n">drop_dts_ages</span> <span class="o">=</span> <span class="n">drop_dts_ages</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="si">}</span><span class="s2">-prices problems&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contiguous</span><span class="p">:</span>
                <span class="c1"># Daily must always be contiguous, so drop everything from first diff</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">drop_dts_not_recent</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">drop_dts_not_recent</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;: dropping </span><span class="si">{</span><span class="n">drop_dts_not_recent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;: dropping all rows from </span><span class="si">{</span><span class="n">drop_dts_not_recent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;: dropping all rows from </span><span class="si">{</span><span class="n">drop_dts_not_recent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">()</span> <span class="k">else</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: &quot;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="n">h</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">drop_dts</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">h_modified</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">n_drop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">f_diff_all</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">drop_dts_not_recent</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">drop_dts_not_recent</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;: dropping </span><span class="si">{</span><span class="n">drop_dts_not_recent</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;: dropping </span><span class="si">{</span><span class="n">drop_dts_not_recent</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;: dropping </span><span class="si">{</span><span class="n">n_drop</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> rows&quot;</span>
                    <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">()</span> <span class="k">else</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: &quot;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>
                <span class="n">h2</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">drop_dts</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">h2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">n_drop</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;here&quot;</span><span class="p">)</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">h2</span>
                <span class="n">h_modified</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">h</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">h_modified</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">f_diff_all</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;differences found but not correcting: &quot;</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f_diff_all</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">f_diff_all</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f_diff_all</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">f_diff_all</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">f_diff_all</span><span class="p">)</span><span class="si">}</span><span class="s2"> differences found but not correcting&quot;</span>
                <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">()</span> <span class="k">else</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: &quot;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">correct</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">f_diff_all</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;Div-Adjust&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">!=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span><span class="p">:</span>
            <span class="c1"># All differences caused by bad dividend data.</span>
            <span class="c1"># To fix, need to force a re-fetch of 1d data.</span>
            <span class="n">hist1d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">GetHistory</span><span class="p">(</span><span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span><span class="p">)</span>
            <span class="n">h1d</span> <span class="o">=</span> <span class="n">hist1d</span><span class="o">.</span><span class="n">_getCachedPrices</span><span class="p">()</span>
            <span class="n">end_d</span> <span class="o">=</span> <span class="n">f_diff_all</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
            <span class="c1"># But only if of 1d data fetched at least 24 hours ago, because maybe</span>
            <span class="c1"># we just fixed the 1d data.</span>
            <span class="n">f_fetched_recently</span> <span class="o">=</span> <span class="n">h1d</span><span class="p">[</span><span class="s1">&#39;FetchDate&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">dt_now</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">f_fetched_recently_not</span> <span class="o">=</span> <span class="o">~</span><span class="n">f_fetched_recently</span>
            <span class="k">if</span> <span class="n">f_fetched_recently_not</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">f_fetched_recently_not_last_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">f_fetched_recently_not</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">end_d</span> <span class="o">=</span> <span class="n">h1d</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">f_fetched_recently_not_last_idx</span><span class="p">]</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;hist-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="si">}</span><span class="s2"> is discarding 1d data before </span><span class="si">{</span><span class="n">end_d</span><span class="si">}</span><span class="s2"> to force re-fetch of dividends&quot;</span>
                <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">()</span> <span class="k">else</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: &quot;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>
                <span class="n">h1d</span> <span class="o">=</span> <span class="n">h1d</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">end_d</span><span class="p">):]</span>

            <span class="n">hist1d</span><span class="o">.</span><span class="n">_updatedCachedPrices</span><span class="p">(</span><span class="n">h1d</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">h_modified</span><span class="p">:</span>
            <span class="n">yfcm</span><span class="o">.</span><span class="n">StoreCacheDatum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getCachedPrices</span><span class="p">()</span>

        <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceExit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PM::_verifyCachedPrices-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="si">}</span><span class="s2">() returning False&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_fetchYfHistory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">prepost</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">verify_intervals</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">disable_yfc_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">end</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must provide value for one of: &#39;start&#39;, &#39;end&#39;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckIntervalDt</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span> <span class="s2">&quot;start&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckIntervalDt</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">)</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckBool</span><span class="p">(</span><span class="n">prepost</span><span class="p">,</span> <span class="s2">&quot;prepost&quot;</span><span class="p">)</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckBool</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s2">&quot;debug&quot;</span><span class="p">)</span>

        <span class="n">debug_yfc</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># debug_yfc = True</span>

        <span class="n">log_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;PM::_fetchYfHistory-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2">-&gt;</span><span class="si">{</span><span class="n">end</span><span class="si">}</span><span class="s2">, prepost=</span><span class="si">{</span><span class="n">prepost</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">():</span>
            <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceEnter</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">debug_yfc</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>

        <span class="n">tz_exchange</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tz</span>
        <span class="n">td_1d</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dt_now</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="n">ZoneInfo</span><span class="p">(</span><span class="s2">&quot;UTC&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">intraday</span><span class="p">:</span>
            <span class="n">maxLookback</span> <span class="o">=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">yfMaxFetchLookback</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">]</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">maxLookback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">dt_now</span> <span class="o">-</span> <span class="n">maxLookback</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;=</span> <span class="n">end</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>

        <span class="n">fetch_start</span> <span class="o">=</span> <span class="n">start</span>
        <span class="n">fetch_end</span> <span class="o">=</span> <span class="n">end</span>

        <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># If &#39;fetch_end&#39; in future then cap to exchange midnight</span>
            <span class="n">dtnow_exchange</span> <span class="o">=</span> <span class="n">dt_now</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="n">tz_exchange</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
                <span class="n">end_dt</span> <span class="o">=</span> <span class="n">end</span>
                <span class="c1"># end_d = end.astimezone(tz_exchange).date()</span>
                <span class="n">end_d</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">end_d</span> <span class="o">=</span> <span class="n">end</span>
                <span class="n">end_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">time</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">tz_exchange</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">end_dt</span> <span class="o">&gt;</span> <span class="n">dt_now</span><span class="p">:</span>
                <span class="n">exchange_midnight_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">dtnow_exchange</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">+</span><span class="n">td_1d</span><span class="p">,</span> <span class="n">time</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">tz_exchange</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
                    <span class="n">fetch_end</span> <span class="o">=</span> <span class="n">exchange_midnight_dt</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fetch_end</span> <span class="o">=</span> <span class="n">exchange_midnight_dt</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
                <span class="n">start_dt</span> <span class="o">=</span> <span class="n">start</span>
                <span class="c1"># start_d = start.astimezone(tz_exchange).date()</span>
                <span class="n">start_d</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">start_d</span> <span class="o">=</span> <span class="n">start</span>
                <span class="n">start_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">time</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">tz_exchange</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">fetch_start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">fetch_end</span> <span class="o">&lt;=</span> <span class="n">fetch_start</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">fetch_start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fetch_start</span><span class="p">,</span> <span class="p">(</span><span class="n">datetime</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">)):</span>
                <span class="n">fetch_start_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">fetch_start</span><span class="p">,</span> <span class="n">time</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">tz</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fetch_start_dt</span> <span class="o">=</span> <span class="n">fetch_start</span>
        <span class="k">if</span> <span class="n">fetch_end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fetch_end</span><span class="p">,</span> <span class="p">(</span><span class="n">datetime</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">)):</span>
                <span class="n">fetch_end_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">fetch_end</span><span class="p">,</span> <span class="n">time</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">tz_exchange</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fetch_end_dt</span> <span class="o">=</span> <span class="n">fetch_end</span>

        <span class="k">if</span> <span class="n">fetch_start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Week</span><span class="p">:</span>
                <span class="c1"># Ensure aligned to week start:</span>
                <span class="n">fetch_start</span> <span class="o">-=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">fetch_start</span><span class="o">.</span><span class="n">weekday</span><span class="p">())</span>

        <span class="n">td_1d</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">td_14d</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span><span class="p">:</span>
            <span class="c1"># Add padding days to ensure Yahoo returns correct Volume</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">yfct</span><span class="o">.</span><span class="n">GetExchangeSchedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="n">fetch_start</span> <span class="o">-</span> <span class="n">td_14d</span><span class="p">,</span> <span class="n">fetch_end</span> <span class="o">+</span> <span class="n">td_14d</span><span class="p">)</span>
            <span class="n">fetch_start_pad</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_indexer</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">fetch_start</span><span class="p">)],</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;ffill&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

            <span class="n">first_fetch_failed</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetchYfHistory_dateRange</span><span class="p">(</span><span class="n">fetch_start_pad</span><span class="p">,</span> <span class="n">fetch_end</span><span class="p">,</span> <span class="n">prepost</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">fetch_start</span><span class="p">):]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">NoPriceDataInRangeException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">first_fetch_failed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">ex</span> <span class="o">=</span> <span class="n">e</span>

            <span class="k">if</span> <span class="n">first_fetch_failed</span> <span class="ow">and</span> <span class="n">fetch_end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Try with wider date range, maybe entire range is just before listing date</span>
                <span class="n">second_fetch_failed</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">df_wider</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">listing_date_check_tol</span> <span class="o">=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">listing_date_check_tols</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">]</span>
                <span class="n">fetch_start</span> <span class="o">-=</span> <span class="mi">2</span><span class="o">*</span><span class="n">listing_date_check_tol</span>
                <span class="n">fetch_end</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">listing_date_check_tol</span>
                <span class="k">if</span> <span class="n">debug_yfc</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;- first fetch failed, trying again with wider range: </span><span class="si">{}</span><span class="s2"> -&gt; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fetch_start</span><span class="p">,</span> <span class="n">fetch_end</span><span class="p">)</span>
                    <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">()</span> <span class="k">else</span> <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">df_wider</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetchYfHistory_dateRange</span><span class="p">(</span><span class="n">fetch_start</span><span class="p">,</span> <span class="n">fetch_end</span><span class="p">,</span> <span class="n">prepost</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">debug_yfc</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;- second fetch returned:&quot;</span>
                        <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">()</span> <span class="k">else</span> <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">df_wider</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;Data doesn&#39;t exist for startDate&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                        <span class="n">second_fetch_failed</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="s2">&quot;No data found for this date range&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                        <span class="n">second_fetch_failed</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">e</span>

                <span class="k">if</span> <span class="n">df_wider</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">debug_yfc</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- detected listing date =&quot;</span><span class="p">,</span> <span class="n">df_wider</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">())</span>
                    <span class="n">yfcm</span><span class="o">.</span><span class="n">StoreCacheDatum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;listing_date&quot;</span><span class="p">,</span> <span class="n">df_wider</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">())</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df_wider</span>
                    <span class="k">if</span> <span class="n">fetch_start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">fetch_start_dt</span><span class="p">:]</span>
                    <span class="k">if</span> <span class="n">fetch_end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="n">fetch_end_dt</span><span class="o">-</span><span class="n">timedelta</span><span class="p">(</span><span class="n">milliseconds</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>

            <span class="k">if</span> <span class="n">first_fetch_failed</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">second_fetch_failed</span><span class="p">:</span>
                    <span class="c1"># Hopefully code never comes here</span>
                    <span class="k">raise</span> <span class="n">ex</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Requested date range was just before stock listing date,</span>
                    <span class="c1"># but wider range crosses over so can continue</span>
                    <span class="k">pass</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span><span class="p">:</span>
            <span class="c1"># Add padding days to ensure Yahoo returns correct Volume</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">yfct</span><span class="o">.</span><span class="n">GetExchangeSchedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="n">fetch_start</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">itd</span><span class="p">,</span> <span class="n">fetch_end</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">itd</span><span class="p">)</span>
            <span class="n">fetch_start_pad</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_indexer</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">fetch_start</span><span class="p">)],</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;ffill&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
            <span class="n">fetch_end_pad</span>   <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_indexer</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">fetch_end</span><span class="p">)],</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;bfill&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetchYfHistory_dateRange</span><span class="p">(</span><span class="n">fetch_start_pad</span><span class="p">,</span> <span class="n">fetch_end_pad</span><span class="p">,</span> <span class="n">prepost</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">fetch_start</span><span class="p">)</span> <span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">fetch_end</span><span class="o">-</span><span class="n">td_1d</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Intraday</span>
            <span class="n">fetch_ranges</span> <span class="o">=</span> <span class="p">[(</span><span class="n">fetch_start</span><span class="p">,</span> <span class="n">fetch_end</span><span class="p">)]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">intraday</span><span class="p">:</span>
                <span class="c1"># Add padding days to ensure Yahoo returns correct Volume</span>
                <span class="n">maxRange</span> <span class="o">=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">yfMaxFetchRange</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">maxRange</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">yfct</span><span class="o">.</span><span class="n">GetExchangeSchedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="n">start_dt</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">-</span> <span class="n">td_14d</span><span class="p">,</span> <span class="n">end_dt</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">+</span> <span class="n">td_14d</span><span class="p">)</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_indexer</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">start_dt</span><span class="o">.</span><span class="n">date</span><span class="p">())],</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;ffill&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">s</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_indexer</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">end_dt</span><span class="o">.</span><span class="n">date</span><span class="p">())],</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;bfill&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">lag</span> <span class="o">=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">exchangeToYfLag</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">start_dt</span> <span class="o">&gt;</span> <span class="n">s</span><span class="p">[</span><span class="s2">&quot;close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">lag</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">end_dt</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">[</span><span class="s2">&quot;open&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">lag</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="c1"># fetch_ranges = yfcu.ChunkDatesIntoYfFetches(start_d, end_d, s, maxRange.days, overlapDays=2)</span>
                    <span class="n">fetch_ranges</span> <span class="o">=</span> <span class="n">yfcu</span><span class="o">.</span><span class="n">ChunkDatesIntoYfFetches</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">maxRange</span><span class="o">.</span><span class="n">days</span><span class="p">,</span> <span class="n">overlapDays</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">debug_yfc</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- fetch_ranges:&quot;</span><span class="p">)</span>
                        <span class="n">pprint</span><span class="p">(</span><span class="n">fetch_ranges</span><span class="p">)</span>
                    <span class="c1"># Don&#39;t need to fetch all of padding days, just the end/start of session</span>
                    <span class="c1"># fetch_ranges[0][0] = s[&quot;close&quot;].iloc[0] - timedelta(hours=2)</span>
                    <span class="c1"># fetch_ranges[-1][1] = s[&quot;open&quot;].iloc[-1] + timedelta(hours=2)</span>
                    <span class="c1"># fetch_ranges[0][&quot;fetch start&quot;] = s[&quot;close&quot;].iloc[0] - timedelta(hours=2)</span>
                    <span class="c1"># Update: need start further back for low-volume tickers</span>
                    <span class="n">fetch_ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;fetch start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s2">&quot;open&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">fetch_ranges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;fetch end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s2">&quot;open&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">maxLookback</span> <span class="o">=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">yfMaxFetchLookback</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">]</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">maxLookback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">maxLookback_dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt_now</span> <span class="o">-</span> <span class="n">maxLookback</span><span class="p">)</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="n">tz_exchange</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fetch_ranges</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">fetch_ranges</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;fetch start&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">maxLookback_dt</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">debug_yfc</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- capping start to maxLookback_dt&quot;</span><span class="p">)</span>
                                <span class="c1"># fetch_ranges[i][&quot;fetch start&quot;] = maxLookback_dt</span>
                                <span class="n">fetch_ranges</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;fetch start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxLookback_dt</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">)</span>
                                <span class="n">fetch_ranges</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;core start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fetch_ranges</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;fetch start&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">td_1d</span>
                                <span class="k">if</span> <span class="n">fetch_ranges</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;fetch start&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">fetch_ranges</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;fetch end&quot;</span><span class="p">]:</span>
                                    <span class="k">del</span> <span class="n">fetch_ranges</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="n">df</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">fetch_ranges</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">debug_yfc</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- fetching:&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="n">fetch_start</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;fetch start&quot;</span><span class="p">]</span>
                <span class="n">fetch_end</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;fetch end&quot;</span><span class="p">]</span>
                <span class="n">dfr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetchYfHistory_dateRange</span><span class="p">(</span><span class="n">fetch_start</span><span class="p">,</span> <span class="n">fetch_end</span><span class="p">,</span> <span class="n">prepost</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
                <span class="c1"># Discard padding days:</span>
                <span class="n">dfr</span> <span class="o">=</span> <span class="n">dfr</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;core start&quot;</span><span class="p">]:</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;core end&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">milliseconds</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
                <span class="k">if</span> <span class="n">debug_yfc</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- dfr after discarding padding days:&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">dfr</span><span class="p">[[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Open&quot;</span><span class="p">,</span> <span class="s2">&quot;Low&quot;</span><span class="p">,</span> <span class="s2">&quot;High&quot;</span><span class="p">,</span> <span class="s2">&quot;Close&quot;</span><span class="p">,</span> <span class="s2">&quot;Dividends&quot;</span><span class="p">,</span> <span class="s2">&quot;Volume&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">dfr</span><span class="o">.</span><span class="n">columns</span><span class="p">]])</span>
                <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">dfr</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">dfr</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]])</span>
                <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;df contains duplicated dates&quot;</span><span class="p">)</span>

        <span class="n">fetch_dt_utc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="n">ZoneInfo</span><span class="p">(</span><span class="s2">&quot;UTC&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz</span><span class="p">,</span> <span class="n">ZoneInfo</span><span class="p">)):</span>
            <span class="c1"># Convert to ZoneInfo</span>
            <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="n">tz_exchange</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">debug_yfc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;- YF returned None&quot;</span>
                <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">()</span> <span class="k">else</span> <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># pass</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;- YF returned table:&quot;</span>
                <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">()</span> <span class="k">else</span> <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Open&quot;</span><span class="p">,</span> <span class="s2">&quot;Low&quot;</span><span class="p">,</span> <span class="s2">&quot;High&quot;</span><span class="p">,</span> <span class="s2">&quot;Close&quot;</span><span class="p">,</span> <span class="s2">&quot;Dividends&quot;</span><span class="p">,</span> <span class="s2">&quot;Volume&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]])</span>

        <span class="c1"># Detect listing day</span>
        <span class="n">listing_day</span> <span class="o">=</span> <span class="n">yfcm</span><span class="o">.</span><span class="n">ReadCacheDatum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;listing_date&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">listing_day</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span><span class="p">:</span>
                <span class="n">found_listing_day</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">listing_day</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="n">tol</span> <span class="o">=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">listing_date_check_tols</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">]</span>
                    <span class="n">fetch_start_d</span> <span class="o">=</span> <span class="n">fetch_start</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fetch_start</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)</span> <span class="k">else</span> <span class="n">fetch_start</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">-</span> <span class="n">fetch_start_d</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
                        <span class="c1"># Yahoo returned data starting significantly after requested start date, indicates</span>
                        <span class="c1"># request is before stock listed on exchange</span>
                        <span class="n">found_listing_day</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">debug_yfc</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;- found_listing_day = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">found_listing_day</span><span class="p">)</span>
                        <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">()</span> <span class="k">else</span> <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">found_listing_day</span><span class="p">:</span>
                        <span class="n">listing_day</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">debug_yfc</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;YFC: inferred listing_date = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">listing_day</span><span class="p">)</span>
                            <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">()</span> <span class="k">else</span> <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="n">yfcm</span><span class="o">.</span><span class="n">StoreCacheDatum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;listing_date&quot;</span><span class="p">,</span> <span class="n">listing_day</span><span class="p">)</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">listing_day</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">first_fetch_failed</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">end</span> <span class="o">&lt;=</span> <span class="n">listing_day</span><span class="p">:</span>
                            <span class="c1"># Aha! Requested date range was entirely before listing</span>
                            <span class="k">if</span> <span class="n">debug_yfc</span><span class="p">:</span>
                                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;- requested date range was before listing date&quot;</span>
                                <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">()</span> <span class="k">else</span> <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                            <span class="k">return</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">found_listing_day</span> <span class="ow">and</span> <span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Apply to fetch start</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
                        <span class="n">listing_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">listing_day</span><span class="p">,</span> <span class="n">time</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">tz</span><span class="p">)</span>
                        <span class="n">start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">listing_date</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">listing_day</span><span class="p">)</span>
                        <span class="n">start_d</span> <span class="o">=</span> <span class="n">start</span>

        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">received_interval_starts</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span><span class="p">:</span>
                <span class="n">received_interval_starts</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">received_interval_starts</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">intervals_missing_df</span> <span class="o">=</span> <span class="n">yfct</span><span class="o">.</span><span class="n">IdentifyMissingIntervals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span> <span class="n">received_interval_starts</span><span class="p">,</span> <span class="n">ignore_breaks</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">NoIntervalsInRangeException</span><span class="p">:</span>
            <span class="n">intervals_missing_df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">intervals_missing_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">intervals_missing_df</span><span class="o">.</span><span class="n">empty</span><span class="p">):</span>
            <span class="c1"># First, ignore any missing intervals today</span>
            <span class="c1"># For missing intervals during last 2 weeks, if few in number, then fill with NaNs</span>
            <span class="c1"># For missing intervals older than 2 weeks, fill all with NaNs</span>

            <span class="k">if</span> <span class="n">debug_yfc</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">intervals_missing_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;YF data missing </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> intervals: </span><span class="si">{</span><span class="n">intervals_missing_df</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;YF data missing </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> intervals&quot;</span>
                <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="s1">&#39;- &#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">()</span> <span class="k">else</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;- &#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>

            <span class="n">cutoff_d</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span><span class="p">:</span>
                <span class="n">f_recent</span> <span class="o">=</span> <span class="n">intervals_missing_df</span><span class="p">[</span><span class="s2">&quot;open&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">cutoff_d</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f_recent</span> <span class="o">=</span> <span class="n">intervals_missing_df</span><span class="p">[</span><span class="s2">&quot;open&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;</span> <span class="n">cutoff_d</span>
            <span class="n">intervals_missing_df_recent</span> <span class="o">=</span> <span class="n">intervals_missing_df</span><span class="p">[</span><span class="n">f_recent</span><span class="p">]</span>
            <span class="n">intervals_missing_df_old</span> <span class="o">=</span> <span class="n">intervals_missing_df</span><span class="p">[</span><span class="o">~</span><span class="n">f_recent</span><span class="p">]</span>
            <span class="n">missing_intervals_to_add</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">intervals_missing_df_old</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">missing_intervals_to_add</span> <span class="o">=</span> <span class="n">intervals_missing_df_old</span><span class="p">[</span><span class="s2">&quot;open&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">intervals_missing_df_recent</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="c1"># If very few intervals and not today (so Yahoo should have data),</span>
                <span class="c1"># then assume no trading occurred and insert NaN rows.</span>
                <span class="c1"># Normally Yahoo has already filled with NaNs but sometimes they forget/are late</span>
                <span class="n">nm</span> <span class="o">=</span> <span class="n">intervals_missing_df_recent</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span><span class="p">:</span>
                    <span class="n">threshold</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">itd</span> <span class="o">&lt;=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
                        <span class="n">threshold</span> <span class="o">=</span> <span class="mi">10</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">itd</span> <span class="o">&lt;=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
                        <span class="n">threshold</span> <span class="o">=</span> <span class="mi">3</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">threshold</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="k">if</span> <span class="n">nm</span> <span class="o">&lt;=</span> <span class="n">threshold</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">debug_yfc</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;- found missing intervals, inserting nans:&quot;</span>
                        <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">()</span> <span class="k">else</span> <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">intervals_missing_df_recent</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">missing_intervals_to_add</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">missing_intervals_to_add</span> <span class="o">=</span> <span class="n">intervals_missing_df_recent</span><span class="p">[</span><span class="s2">&quot;open&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">missing_intervals_to_add</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">missing_intervals_to_add</span><span class="p">,</span> <span class="n">intervals_missing_df_recent</span><span class="p">[</span><span class="s2">&quot;open&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">missing_intervals_to_add</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">missing_intervals_to_add</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;insertings NaNs for </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> missing intervals: </span><span class="si">{</span><span class="n">missing_intervals_to_add</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;insertings NaNs for </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> missing intervals&quot;</span>
                <span class="k">if</span> <span class="n">debug_yfc</span><span class="p">:</span>
                    <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="s1">&#39;- &#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">()</span> <span class="k">else</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;- &#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">LogEvent</span><span class="p">(</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="s2">&quot;PriceManager&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

                <span class="n">nm</span> <span class="o">=</span> <span class="n">missing_intervals_to_add</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">df_missing</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span><span class="o">*</span><span class="n">nm</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">yf_data_cols</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">missing_intervals_to_add</span><span class="p">)</span>
                <span class="n">df_missing</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Needs to be int type</span>
                <span class="k">if</span> <span class="s2">&quot;Repaired?&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">df_missing</span><span class="p">[</span><span class="s2">&quot;Repaired?&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">df_missing</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_missing</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span><span class="p">:</span>
                    <span class="n">df_missing</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df_missing</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="n">tz_exchange</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Volume&quot;</span><span class="p">,</span> <span class="s2">&quot;Dividends&quot;</span><span class="p">,</span> <span class="s2">&quot;Stock Splits&quot;</span><span class="p">,</span> <span class="s2">&quot;Capital Gains&quot;</span><span class="p">]:</span>
                    <span class="n">df_missing</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df_missing</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">df_missing</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]])</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="n">tz_exchange</span><span class="p">)</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>

        <span class="c1"># Improve tolerance to calendar missing a recent new holiday:</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">n</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">fetch_dt</span> <span class="o">=</span> <span class="n">fetch_dt_utc</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">ZoneInfo</span><span class="p">(</span><span class="s2">&quot;UTC&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span><span class="p">:</span>
            <span class="c1"># Update: move checking for new dividends to here, before discarding out-of-range data</span>
            <span class="n">df_divs</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Dividends&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">][[</span><span class="s2">&quot;Dividends&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">df_divs</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">df_divs</span><span class="p">[</span><span class="s1">&#39;FetchDate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fetch_dt_utc</span>
                <span class="n">df_divs</span><span class="p">[</span><span class="s1">&#39;Desplitted?&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">debug_yfc</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- df_divs:&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">df_divs</span><span class="p">)</span>
                <span class="n">cached_new_divs</span> <span class="o">=</span> <span class="n">yfcm</span><span class="o">.</span><span class="n">ReadCacheDatum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;new_divs&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cached_new_divs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;Desplitted?&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cached_new_divs</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="n">cached_new_divs</span><span class="p">[</span><span class="s1">&#39;Desplitted?&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">df_divs</span> <span class="o">=</span> <span class="n">df_divs</span><span class="p">[</span><span class="o">~</span><span class="n">df_divs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">cached_new_divs</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">df_divs</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                        <span class="n">divs_pretty</span> <span class="o">=</span> <span class="n">df_divs</span><span class="p">[</span><span class="s1">&#39;Dividends&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">divs_pretty</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">divs_pretty</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">LogEvent</span><span class="p">(</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="s2">&quot;DividendManager&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;detected </span><span class="si">{</span><span class="n">divs_pretty</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> new dividends: </span><span class="si">{</span><span class="n">divs_pretty</span><span class="si">}</span><span class="s2"> (before reversing adjust)&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">yfcm</span><span class="o">.</span><span class="n">ReadCacheMetadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;new_divs&quot;</span><span class="p">,</span> <span class="s2">&quot;locked&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="c1"># locked</span>
                            <span class="k">pass</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">cached_new_divs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">cached_new_divs</span><span class="p">,</span> <span class="n">df_divs</span><span class="p">])</span>
                            <span class="n">yfcm</span><span class="o">.</span><span class="n">StoreCacheDatum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;new_divs&quot;</span><span class="p">,</span> <span class="n">cached_new_divs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">yfcm</span><span class="o">.</span><span class="n">StoreCacheDatum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;new_divs&quot;</span><span class="p">,</span> <span class="n">df_divs</span><span class="p">)</span>

        <span class="c1"># Remove any out-of-range data:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="c1"># NOTE: YF has a bug-fix pending merge: https://github.com/ranaroussi/yfinance/pull/1012</span>
            <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;</span> <span class="n">end_d</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">end_dt</span><span class="p">]</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1">#</span>
            <span class="c1"># And again for pre-start data:</span>
            <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;=</span> <span class="n">start_d</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">start_dt</span><span class="p">]</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Verify that all datetimes match up with actual intervals:</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">NoPriceDataInRangeException</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">time</span> <span class="o">!=</span> <span class="n">time</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">f</span><span class="p">])</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Interday data contains times in index&quot;</span><span class="p">)</span>
                <span class="n">yfIntervalStarts</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">yfIntervalStarts</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">intraday</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="ow">in</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">exchangesWithBreaks</span><span class="p">):</span>
                <span class="c1"># Discard any intervals fully within a break</span>
                <span class="n">f_in_break</span> <span class="o">=</span> <span class="n">yfct</span><span class="o">.</span><span class="n">TimestampInBreak_batch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="n">yfIntervalStarts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">f_in_break</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="c1"># Discard these</span>
                    <span class="k">if</span> <span class="n">debug_yfc</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;- dropping rows in break times&quot;</span>
                        <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">()</span> <span class="k">else</span> <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="n">yfIntervalStarts</span> <span class="o">=</span> <span class="n">yfIntervalStarts</span><span class="p">[</span><span class="o">~</span><span class="n">f_in_break</span><span class="p">]</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">f_in_break</span><span class="p">]</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1">#</span>
            <span class="n">intervals</span> <span class="o">=</span> <span class="n">yfct</span><span class="o">.</span><span class="n">GetTimestampCurrentInterval_batch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="n">yfIntervalStarts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span> <span class="n">discardTimes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interday</span><span class="p">,</span> <span class="n">ignore_breaks</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">f_na</span> <span class="o">=</span> <span class="n">intervals</span><span class="p">[</span><span class="s2">&quot;interval_open&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">verify_intervals</span> <span class="ow">and</span> <span class="n">f_na</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="n">intervals</span><span class="p">[</span><span class="s2">&quot;interval_open&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ts</span><span class="p">)):</span>
                    <span class="n">dups</span> <span class="o">=</span> <span class="n">ts</span><span class="p">[</span><span class="n">ts</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
                    <span class="c1"># Drop rows that map to duplicate intervals if no trading occurred.</span>
                    <span class="n">f_no_trades</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Volume&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Low&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;High&quot;</span><span class="p">])</span> <span class="o">|</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">())</span>
                    <span class="n">drop_dts</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dups</span><span class="p">:</span>
                        <span class="n">dts</span> <span class="o">=</span> <span class="n">intervals</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">intervals</span><span class="p">[</span><span class="s2">&quot;interval_open&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span>
                        <span class="n">dts_is_nan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">f_no_trades</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">dt</span><span class="p">)]</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">dts</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">dts_is_nan</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                            <span class="c1"># Keep first, drop others</span>
                            <span class="n">drop_dts_sub</span> <span class="o">=</span> <span class="n">dts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Keep non-nan, drop nans</span>
                            <span class="n">drop_dts_sub</span> <span class="o">=</span> <span class="n">dts</span><span class="p">[</span><span class="n">dts_is_nan</span><span class="p">]</span>
                        <span class="n">drop_dts</span> <span class="o">=</span> <span class="n">drop_dts_sub</span> <span class="k">if</span> <span class="n">drop_dts</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">drop_dts</span><span class="p">,</span> <span class="n">drop_dts_sub</span><span class="p">)</span>
                    <span class="c1"># print(&quot;dropping:&quot;, drop_dts)</span>
                    <span class="n">yfIntervalStarts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">yfIntervalStarts</span><span class="p">,</span> <span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">drop_dts</span><span class="p">])</span>
                    <span class="n">intervals</span> <span class="o">=</span> <span class="n">intervals</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">drop_dts</span><span class="p">)</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">drop_dts</span><span class="p">)</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">f_na</span> <span class="o">=</span> <span class="n">intervals</span><span class="p">[</span><span class="s2">&quot;interval_open&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span><span class="p">:</span>
                    <span class="c1"># For some exchanges (e.g. JSE) Yahoo returns intraday timestamps right on market close.</span>
                    <span class="c1"># - remove if volume 0</span>
                    <span class="c1"># - else, merge with previous interval</span>
                    <span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="p">;</span> <span class="n">df2</span><span class="p">[</span><span class="s2">&quot;_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span> <span class="p">;</span> <span class="n">df2</span><span class="p">[</span><span class="s2">&quot;_intervalStart&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">index</span>
                    <span class="n">sched</span> <span class="o">=</span> <span class="n">yfct</span><span class="o">.</span><span class="n">GetExchangeSchedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="n">df2</span><span class="p">[</span><span class="s2">&quot;_date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">df2</span><span class="p">[</span><span class="s2">&quot;_date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="n">td_1d</span><span class="p">)</span>
                    <span class="n">rename_cols</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;open&quot;</span><span class="p">:</span> <span class="s2">&quot;market_open&quot;</span><span class="p">,</span> <span class="s2">&quot;close&quot;</span><span class="p">:</span> <span class="s2">&quot;market_close&quot;</span><span class="p">}</span>
                    <span class="n">sched</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">rename_cols</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">rename_cols</span> <span class="k">else</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">sched</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
                    <span class="n">sched_df</span> <span class="o">=</span> <span class="n">sched</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">sched_df</span><span class="p">[</span><span class="s2">&quot;_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sched_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span>
                    <span class="n">df2</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">sched_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;_date&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
                    <span class="n">df2</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
                    <span class="n">f_close</span> <span class="o">=</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s2">&quot;_intervalStart&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">df2</span><span class="p">[</span><span class="s2">&quot;market_close&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                    <span class="n">f_close</span> <span class="o">=</span> <span class="n">f_close</span> <span class="o">&amp;</span> <span class="n">f_na</span>
                    <span class="n">f_vol0</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="s2">&quot;Volume&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
                    <span class="n">f_drop</span> <span class="o">=</span> <span class="n">f_vol0</span> <span class="o">&amp;</span> <span class="n">f_close</span>
                    <span class="k">if</span> <span class="n">f_drop</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">debug_yfc</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;- dropping 0-volume rows starting at market close&quot;</span>
                            <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">()</span> <span class="k">else</span> <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="n">yfIntervalStarts</span> <span class="o">=</span> <span class="n">yfIntervalStarts</span><span class="p">[</span><span class="o">~</span><span class="n">f_drop</span><span class="p">]</span>
                        <span class="n">intervals</span> <span class="o">=</span> <span class="n">intervals</span><span class="p">[</span><span class="o">~</span><span class="n">f_drop</span><span class="p">]</span>
                        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">f_drop</span><span class="p">]</span>
                        <span class="n">df2</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="o">~</span><span class="n">f_drop</span><span class="p">]</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">f_na</span> <span class="o">=</span> <span class="n">intervals</span><span class="p">[</span><span class="s2">&quot;interval_open&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                    <span class="c1">#</span>
                    <span class="n">f_close</span> <span class="o">=</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s2">&quot;_intervalStart&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">df2</span><span class="p">[</span><span class="s2">&quot;market_close&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                    <span class="n">f_close</span> <span class="o">=</span> <span class="n">f_close</span> <span class="o">&amp;</span> <span class="n">f_na</span>
                    <span class="k">if</span> <span class="n">f_close</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="c1"># Must merge with previous interval. Tricky!</span>
                        <span class="n">df3</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="n">f_close</span><span class="p">]</span>
                        <span class="n">df3_index_rev</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">df3</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">df3_index_rev</span><span class="p">:</span>
                            <span class="n">i</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="c1"># Can&#39;t fix</span>
                                <span class="k">continue</span>
                            <span class="n">dt_before</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">dt</span><span class="o">-</span><span class="n">dt_before</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">itd</span><span class="p">:</span>
                                <span class="c1"># Merge</span>
                                <span class="n">df_rows</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt_before</span><span class="p">,</span> <span class="s2">&quot;Low&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_rows</span><span class="p">[</span><span class="s2">&quot;Low&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt_before</span><span class="p">,</span> <span class="s2">&quot;High&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_rows</span><span class="p">[</span><span class="s2">&quot;High&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt_before</span><span class="p">,</span> <span class="s2">&quot;Open&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_rows</span><span class="p">[</span><span class="s2">&quot;Open&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt_before</span><span class="p">,</span> <span class="s2">&quot;Close&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_rows</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt_before</span><span class="p">,</span> <span class="s2">&quot;Adj Close&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_rows</span><span class="p">[</span><span class="s2">&quot;Adj Close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt_before</span><span class="p">,</span> <span class="s2">&quot;Volume&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_rows</span><span class="p">[</span><span class="s2">&quot;Volume&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

                                <span class="n">yfIntervalStarts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">yfIntervalStarts</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                                <span class="n">intervals</span> <span class="o">=</span> <span class="n">intervals</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
                                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
                                <span class="n">n</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">f_na</span> <span class="o">=</span> <span class="n">intervals</span><span class="p">[</span><span class="s2">&quot;interval_open&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># Previous interval too far, must insert a new interval</span>
                                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;this code path not tested, review&quot;</span><span class="p">)</span>
                                <span class="n">dt_correct</span> <span class="o">=</span> <span class="n">dt_before</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">itd</span>
                                <span class="k">if</span> <span class="n">dt_correct</span> <span class="o">&gt;=</span> <span class="n">dt</span><span class="p">:</span>
                                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dt_correct=</span><span class="si">{</span><span class="n">dt_correct</span><span class="si">}</span><span class="s2"> &gt;= dt=</span><span class="si">{</span><span class="n">dt</span><span class="si">}</span><span class="s2"> , expected &lt;&quot;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">dt_correct</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">!=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">():</span>
                                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dt_correct=</span><span class="si">{</span><span class="n">dt_correct</span><span class="si">}</span><span class="s2"> &amp; dt=</span><span class="si">{</span><span class="n">dt</span><span class="si">}</span><span class="s2"> , expected same day&quot;</span><span class="p">)</span>
                                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt_correct</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span> <span class="p">;</span> <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
                                <span class="n">yfIntervalStarts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_correct</span>
                                <span class="n">intervals</span> <span class="o">=</span> <span class="n">intervals</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
                                <span class="n">intervals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt_correct</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;interval_open&quot;</span><span class="p">:</span> <span class="n">dt_correct</span><span class="p">,</span> <span class="s2">&quot;interval_close&quot;</span><span class="p">:</span> <span class="n">df2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="s2">&quot;market_close&quot;</span><span class="p">]}</span>
                                <span class="n">f_na</span> <span class="o">=</span> <span class="n">intervals</span><span class="p">[</span><span class="s2">&quot;interval_open&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">f_na</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="n">f_no_divs_splits</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Dividends&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Stock Splits&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

                    <span class="c1"># For some national holidays when exchange closed, Yahoo fills in row. Clue is 0 volume.</span>
                    <span class="c1"># Solution = drop:</span>
                    <span class="n">f_na_zeroVol</span> <span class="o">=</span> <span class="n">f_na</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Volume&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                    <span class="n">f_na_zeroVol</span> <span class="o">=</span> <span class="n">f_na_zeroVol</span> <span class="o">&amp;</span> <span class="n">f_no_divs_splits</span>
                    <span class="k">if</span> <span class="n">f_na_zeroVol</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">debug_yfc</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;- dropping </span><span class="si">{}</span><span class="s2"> 0-volume rows with no matching interval&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">f_na_zeroVol</span><span class="p">))</span>
                            <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">()</span> <span class="k">else</span> <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="n">f_drop</span> <span class="o">=</span> <span class="n">f_na_zeroVol</span>
                        <span class="n">yfIntervalStarts</span> <span class="o">=</span> <span class="n">yfIntervalStarts</span><span class="p">[</span><span class="o">~</span><span class="n">f_drop</span><span class="p">]</span>
                        <span class="n">intervals</span> <span class="o">=</span> <span class="n">intervals</span><span class="p">[</span><span class="o">~</span><span class="n">f_drop</span><span class="p">]</span>
                        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">f_drop</span><span class="p">]</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">f_na</span> <span class="o">=</span> <span class="n">intervals</span><span class="p">[</span><span class="s2">&quot;interval_open&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                        <span class="n">f_no_divs_splits</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Dividends&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Stock Splits&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

                    <span class="c1"># ... another clue is row is identical to previous trading day</span>
                    <span class="k">if</span> <span class="n">f_na</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="n">f_drop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">False</span><span class="p">]</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">f_na</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">dt</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                                <span class="n">last_dt</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">yf_data_cols</span><span class="p">]</span> <span class="o">==</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">last_dt</span><span class="p">,</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">yf_data_cols</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                                    <span class="n">f_drop</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="n">f_drop</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">debug_yfc</span><span class="p">:</span>
                                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;- dropping rows with no interval that are identical to previous row&quot;</span>
                                <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">()</span> <span class="k">else</span> <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                            <span class="n">yfIntervalStarts</span> <span class="o">=</span> <span class="n">yfIntervalStarts</span><span class="p">[</span><span class="o">~</span><span class="n">f_drop</span><span class="p">]</span>
                            <span class="n">intervals</span> <span class="o">=</span> <span class="n">intervals</span><span class="p">[</span><span class="o">~</span><span class="n">f_drop</span><span class="p">]</span>
                            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">f_drop</span><span class="p">]</span>
                            <span class="n">n</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">f_na</span> <span class="o">=</span> <span class="n">intervals</span><span class="p">[</span><span class="s2">&quot;interval_open&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                        <span class="n">f_no_divs_splits</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Dividends&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Stock Splits&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

                    <span class="c1"># ... and another clue is Open=High=Low=0.0</span>
                    <span class="k">if</span> <span class="n">f_na</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="n">f_zero</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                        <span class="n">f_zero</span> <span class="o">=</span> <span class="n">f_zero</span> <span class="o">&amp;</span> <span class="n">f_no_divs_splits</span>
                        <span class="n">f_na_zero</span> <span class="o">=</span> <span class="n">f_na</span> <span class="o">&amp;</span> <span class="n">f_zero</span>
                        <span class="k">if</span> <span class="n">f_na_zero</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">debug_yfc</span><span class="p">:</span>
                                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;- dropping </span><span class="si">{}</span><span class="s2"> price=0 rows with no matching interval&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">f_na_zero</span><span class="p">))</span>
                                <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">()</span> <span class="k">else</span> <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                            <span class="n">f_drop</span> <span class="o">=</span> <span class="n">f_na_zero</span>
                            <span class="n">yfIntervalStarts</span> <span class="o">=</span> <span class="n">yfIntervalStarts</span><span class="p">[</span><span class="o">~</span><span class="n">f_drop</span><span class="p">]</span>
                            <span class="n">intervals</span> <span class="o">=</span> <span class="n">intervals</span><span class="p">[</span><span class="o">~</span><span class="n">f_drop</span><span class="p">]</span>
                            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">f_drop</span><span class="p">]</span>
                            <span class="n">n</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">f_na</span> <span class="o">=</span> <span class="n">intervals</span><span class="p">[</span><span class="s2">&quot;interval_open&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">f_na</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Mins1</span><span class="p">:</span>
                    <span class="c1"># If 1-minute interval at market close, then merge with previous minute</span>
                    <span class="n">indices</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">f_na</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
                        <span class="n">dt</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                        <span class="n">sched</span> <span class="o">=</span> <span class="n">yfct</span><span class="o">.</span><span class="n">GetExchangeSchedule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(),</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">+</span><span class="n">td_1d</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">dt</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">==</span> <span class="n">sched</span><span class="p">[</span><span class="s2">&quot;close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">time</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="c1"># Discard</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;discarding&quot;</span><span class="p">)</span>
                                <span class="k">pass</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;merging&quot;</span><span class="p">)</span>
                                <span class="c1"># Merge with previous</span>
                                <span class="n">dt1</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt1</span><span class="p">,</span> <span class="s2">&quot;Close&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt1</span><span class="p">,</span> <span class="s2">&quot;High&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;High&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt1</span><span class="p">,</span> <span class="s2">&quot;Low&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Low&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt1</span><span class="p">,</span> <span class="s2">&quot;Volume&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Volume&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
                            <span class="n">intervals</span> <span class="o">=</span> <span class="n">intervals</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
                            <span class="n">yfIntervalStarts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">yfIntervalStarts</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
                    <span class="n">f_na</span> <span class="o">=</span> <span class="n">intervals</span><span class="p">[</span><span class="s2">&quot;interval_open&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">f_na</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="n">df_na</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">f_na</span><span class="p">][[</span><span class="s2">&quot;Close&quot;</span><span class="p">,</span> <span class="s2">&quot;Volume&quot;</span><span class="p">,</span> <span class="s2">&quot;Dividends&quot;</span><span class="p">,</span> <span class="s2">&quot;Stock Splits&quot;</span><span class="p">]]</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="n">df_na</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">warning_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to map these Yahoo intervals to xcal: (tkr=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s2">, exchange=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="si">}</span><span class="s2">, xcal=</span><span class="si">{</span><span class="n">yfcd</span><span class="o">.</span><span class="n">exchangeToXcalExchange</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">]</span><span class="si">}</span><span class="s2">).&quot;</span>
                    <span class="n">warning_msg</span> <span class="o">+=</span> <span class="s2">&quot; Normally happens when &#39;exchange_calendars&#39; is wrong so inform developers.&quot;</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">warning_msg</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">df_na</span><span class="p">)</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Accept into cache anyway?&quot;</span>
                    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">accept</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">accept</span> <span class="o">=</span> <span class="n">click</span><span class="o">.</span><span class="n">confirm</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">accept</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">f_na</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                            <span class="n">dt</span> <span class="o">=</span> <span class="n">intervals</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span><span class="p">:</span>
                                <span class="n">intervals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="s2">&quot;interval_open&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
                                <span class="n">intervals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="s2">&quot;interval_close&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">itd</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">intervals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="s2">&quot;interval_open&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                                <span class="n">intervals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">,</span> <span class="s2">&quot;interval_close&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">itd</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Problem with dates returned by Yahoo, see above&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">disable_yfc_metadata</span><span class="p">:</span>
            <span class="n">lastDataDts</span> <span class="o">=</span> <span class="n">yfct</span><span class="o">.</span><span class="n">CalcIntervalLastDataDt_batch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="n">intervals</span><span class="p">[</span><span class="s2">&quot;interval_open&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">f_na</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="c1"># Hacky solution to handle xcal having incorrect schedule, for valid Yahoo data</span>
                <span class="n">lastDataDts</span><span class="p">[</span><span class="n">f_na</span><span class="p">]</span> <span class="o">=</span> <span class="n">intervals</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">f_na</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">itd</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">intraday</span><span class="p">:</span>
                    <span class="n">lastDataDts</span><span class="p">[</span><span class="n">f_na</span><span class="p">]</span> <span class="o">+=</span> <span class="n">yfct</span><span class="o">.</span><span class="n">GetExchangeDataDelay</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">)</span>
                    <span class="c1"># For some exchanges, Yahoo has trades that occurred soon afer official market close, e.g. Johannesburg:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;JNB&quot;</span><span class="p">]:</span>
                        <span class="n">lastDataDts</span><span class="p">[</span><span class="n">f_na</span><span class="p">]</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Add ~10 hours to ensure hit next market open</span>
                    <span class="n">lastDataDts</span><span class="p">[</span><span class="n">f_na</span><span class="p">]</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">data_final</span> <span class="o">=</span> <span class="n">fetch_dt</span> <span class="o">&gt;=</span> <span class="n">lastDataDts</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Final?&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_final</span>

            <span class="c1"># df[&quot;FetchDate&quot;] = pd.Timestamp(fetch_dt_utc).tz_localize(&quot;UTC&quot;)</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;FetchDate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fetch_dt_utc</span>

            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;C-Check?&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">log_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;PM::_fetchYfHistory() returning DF </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">():</span>
            <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceExit</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">debug_yfc</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">_fetchYfHistory_dateRange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">prepost</span><span class="p">,</span> <span class="n">debug</span><span class="p">):</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckIntervalDt</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span> <span class="s2">&quot;start&quot;</span><span class="p">)</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckIntervalDt</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">)</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckBool</span><span class="p">(</span><span class="n">prepost</span><span class="p">,</span> <span class="s2">&quot;prepost&quot;</span><span class="p">)</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckBool</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s2">&quot;debug&quot;</span><span class="p">)</span>

        <span class="n">debug_yfc</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># debug_yfc = True</span>

        <span class="n">log_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;PM::_fetchYfHistory_dateRange-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="si">}</span><span class="s2">(start=</span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2"> , end=</span><span class="si">{</span><span class="n">end</span><span class="si">}</span><span class="s2"> , prepost=</span><span class="si">{</span><span class="n">prepost</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">():</span>
            <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceEnter</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">debug_yfc</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>

        <span class="n">fetch_start</span> <span class="o">=</span> <span class="n">start</span>
        <span class="n">fetch_end</span> <span class="o">=</span> <span class="n">end</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fetch_start</span><span class="p">,</span> <span class="p">(</span><span class="n">datetime</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">)):</span>
            <span class="n">fetch_start_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">fetch_start</span><span class="p">,</span> <span class="n">time</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">tz</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fetch_start_dt</span> <span class="o">=</span> <span class="n">fetch_start</span>

        <span class="n">history_args</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;period&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s2">&quot;interval&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="p">,</span>
                        <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="n">fetch_start</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="n">fetch_end</span><span class="p">,</span>
                        <span class="s2">&quot;prepost&quot;</span><span class="p">:</span> <span class="n">prepost</span><span class="p">,</span>
                        <span class="s2">&quot;actions&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># Always fetch</span>
                        <span class="s2">&quot;keepna&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="s2">&quot;repair&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="s2">&quot;auto_adjust&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># store raw data, adjust myself</span>
                        <span class="s2">&quot;back_adjust&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># store raw data, adjust myself</span>
                        <span class="s2">&quot;proxy&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy</span><span class="p">,</span>
                        <span class="s2">&quot;rounding&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># store raw data, round myself</span>
                        <span class="s2">&quot;raise_errors&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">yf_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;yfinance&#39;</span><span class="p">)</span>
            <span class="n">yf_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>  <span class="c1"># verbose: print errors &amp; debug info</span>

        <span class="k">if</span> <span class="n">debug_yfc</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fetch_start</span><span class="p">,</span> <span class="n">datetime</span><span class="p">))</span> <span class="ow">or</span> <span class="n">fetch_start</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">==</span> <span class="n">time</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
                <span class="n">start_str</span> <span class="o">=</span> <span class="n">fetch_start</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">start_str</span> <span class="o">=</span> <span class="n">fetch_start</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fetch_end</span><span class="p">,</span> <span class="n">datetime</span><span class="p">))</span> <span class="ow">or</span> <span class="n">fetch_end</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">==</span> <span class="n">time</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
                <span class="n">end_str</span> <span class="o">=</span> <span class="n">fetch_end</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">end_str</span> <span class="o">=</span> <span class="n">fetch_end</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: fetching </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">start_str</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">end_str</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">()</span> <span class="k">else</span> <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">first_fetch_failed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">debug_yfc</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;- fetch_start=</span><span class="si">{</span><span class="n">fetch_start</span><span class="si">}</span><span class="s2"> ; fetch_end=</span><span class="si">{</span><span class="n">fetch_end</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">()</span> <span class="k">else</span> <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="o">**</span><span class="n">history_args</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
            <span class="k">if</span> <span class="s2">&quot;Repaired?&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Repaired?&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">debug_yfc</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;- YF returned None&quot;</span>
                    <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">()</span> <span class="k">else</span> <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;- YF returned table:&quot;</span>
                    <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">()</span> <span class="k">else</span> <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Open&quot;</span><span class="p">,</span> <span class="s2">&quot;Low&quot;</span><span class="p">,</span> <span class="s2">&quot;High&quot;</span><span class="p">,</span> <span class="s2">&quot;Close&quot;</span><span class="p">,</span> <span class="s2">&quot;Dividends&quot;</span><span class="p">,</span> <span class="s2">&quot;Volume&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]])</span>
            <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;No data found for this date range&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">first_fetch_failed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="s2">&quot;Data doesn&#39;t exist for startDate&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">NoPriceDataInRangeException</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;No data found for this date range&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">NoPriceDataInRangeException</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;No price data found, symbol may be delisted&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">NoPriceDataInRangeException</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;df:&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">e</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">first_fetch_failed</span> <span class="ow">and</span> <span class="n">fetch_start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;requested from YF: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">history_args</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">history_args</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span><span class="p">:</span>
                <span class="n">log_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, received: </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, received: </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">LogEvent</span><span class="p">(</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="s2">&quot;PriceManager&quot;</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">)</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">fetch_start_dt</span><span class="p">:]</span>
            <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">first_fetch_failed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">raise</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">NoPriceDataInRangeException</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

        <span class="c1"># Check that weekly aligned to Monday. If not, shift start date back and re-fetch</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Week</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="c1"># Despite fetch_start aligned to Monday, sometimes Yahoo returns weekly</span>
            <span class="c1"># data starting a different day. Shifting back a little fixes</span>
            <span class="n">shift_backs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">shift_backs</span><span class="p">:</span>
                <span class="n">fetch_start2</span> <span class="o">=</span> <span class="n">fetch_start</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>
                <span class="n">history_args</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fetch_start2</span>
                <span class="k">if</span> <span class="n">debug_yfc</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;- weekly data not aligned to Monday, re-fetching from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fetch_start2</span><span class="p">)</span>
                    <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">()</span> <span class="k">else</span> <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="o">**</span><span class="n">history_args</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;Repaired?&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Repaired?&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Week</span> <span class="ow">and</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">log_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;requested from YF: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">history_args</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">history_args</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">log_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, received: </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">LogEvent</span><span class="p">(</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="s2">&quot;PriceManager&quot;</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">)</span>

                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
                        <span class="n">start_dt</span> <span class="o">=</span> <span class="n">start</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">start_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">time</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">tz</span><span class="p">)</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">start_dt</span><span class="p">:]</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Week</span> <span class="ow">and</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                <span class="c1"># print(&quot;Date range requested: {} -&gt; {}&quot;.format(fetch_start, fetch_end))</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Weekly data returned by YF doesn&#39;t begin Monday but </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weekday</span><span class="p">()))</span>

        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log_msg</span> <span class="o">=</span> <span class="s2">&quot;PM::_fetchYfHistory_dateRange() returning None&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;PM::_fetchYfHistory_dateRange() returning DF </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">():</span>
            <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceExit</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">debug_yfc</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>

        <span class="c1"># df = yfcu.CustomNanCheckingDataFrame(df)</span>

        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">_reconstruct_intervals_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">tag</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;&#39;df&#39; must be a Pandas DataFrame not&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Mins1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df</span>

        <span class="c1"># Reconstruct values in df using finer-grained price data. Delimiter marks what to reconstruct</span>

        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># debug = True</span>

        <span class="n">price_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Open&quot;</span><span class="p">,</span> <span class="s2">&quot;High&quot;</span><span class="p">,</span> <span class="s2">&quot;Low&quot;</span><span class="p">,</span> <span class="s2">&quot;Close&quot;</span><span class="p">,</span> <span class="s2">&quot;Adj Close&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="p">]</span>
        <span class="n">data_cols</span> <span class="o">=</span> <span class="n">price_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;Volume&quot;</span><span class="p">]</span>

        <span class="n">log_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;PM::_reconstruct_intervals_batch-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="si">}</span><span class="s2">(dt0=</span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceEnter</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>

        <span class="c1"># If interval is weekly then can construct with daily. But if smaller intervals then</span>
        <span class="c1"># restricted to recent times:</span>
        <span class="n">min_lookback</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># - daily = hourly restricted to last 730 days</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Week</span><span class="p">:</span>
            <span class="c1"># Correct by fetching week of daily data</span>
            <span class="n">sub_interval</span> <span class="o">=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span>
            <span class="n">td_range</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span><span class="p">:</span>
            <span class="c1"># Correct by fetching day of hourly data</span>
            <span class="n">sub_interval</span> <span class="o">=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Hours1</span>
            <span class="n">td_range</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">min_lookback</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">730</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Hours1</span><span class="p">:</span>
            <span class="c1"># Correct by fetching hour of 30m data</span>
            <span class="n">sub_interval</span> <span class="o">=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Mins30</span>
            <span class="n">td_range</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">min_lookback</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Mins30</span><span class="p">:</span>
            <span class="c1"># Correct by fetching hour of 15m data</span>
            <span class="n">sub_interval</span> <span class="o">=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Mins15</span>
            <span class="n">td_range</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
            <span class="n">min_lookback</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Mins15</span><span class="p">:</span>
            <span class="c1"># Correct by fetching hour of 5m data</span>
            <span class="n">sub_interval</span> <span class="o">=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Mins5</span>
            <span class="n">td_range</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
            <span class="n">min_lookback</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Mins5</span><span class="p">:</span>
            <span class="c1"># Correct by fetching hour of 2m data</span>
            <span class="n">sub_interval</span> <span class="o">=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Mins2</span>
            <span class="n">td_range</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">min_lookback</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Mins2</span><span class="p">:</span>
            <span class="c1"># Correct by fetching hour of 1m data</span>
            <span class="n">sub_interval</span> <span class="o">=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Mins1</span>
            <span class="n">td_range</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">min_lookback</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;WARNING: Have not implemented repair for &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="si">}</span><span class="s2">&#39; interval. Contact developers&quot;</span>
            <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">()</span> <span class="k">else</span> <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">log_msg</span> <span class="o">=</span> <span class="s2">&quot;PM::_reconstruct_intervals_batch() returning&quot;</span>
            <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceExit</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span>
        <span class="n">sub_interday</span> <span class="o">=</span> <span class="n">sub_interval</span> <span class="ow">in</span> <span class="p">[</span><span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span><span class="p">,</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Week</span><span class="p">]</span><span class="c1">#, yfcd.Interval.Months1, yfcd.Interval.Months3]</span>
        <span class="n">sub_intraday</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">sub_interday</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>

        <span class="n">f_repair</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">data_cols</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">==</span> <span class="n">tag</span>
        <span class="n">f_repair_rows</span> <span class="o">=</span> <span class="n">f_repair</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Ignore old intervals for which Yahoo won&#39;t return finer data:</span>
        <span class="c1"># if sub_interval == yfcd.Interval.Hours1:</span>
        <span class="c1">#     f_recent = date.today() - df.index.date &lt; timedelta(days=730)</span>
        <span class="c1">#     f_repair_rows = f_repair_rows &amp; f_recent</span>
        <span class="c1"># elif sub_interval in [yfcd.Interval.Mins30, yfcd.Interval.Mins15]:</span>
        <span class="c1">#     f_recent = date.today() - df.index.date &lt; timedelta(days=60)</span>
        <span class="c1">#     f_repair_rows = f_repair_rows &amp; f_recent</span>
        <span class="k">if</span> <span class="n">min_lookback</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">min_dt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">min_dt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="n">ZoneInfo</span><span class="p">(</span><span class="s2">&quot;UTC&quot;</span><span class="p">))</span> <span class="o">-</span> <span class="n">min_lookback</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- min_dt=</span><span class="si">{</span><span class="n">min_dt</span><span class="si">}</span><span class="s2"> interval=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="si">}</span><span class="s2"> sub_interval=</span><span class="si">{</span><span class="n">sub_interval</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">min_dt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f_recent</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">min_dt</span>
            <span class="n">f_repair_rows</span> <span class="o">=</span> <span class="n">f_repair_rows</span> <span class="o">&amp;</span> <span class="n">f_recent</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">f_repair_rows</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- data too old to repair&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">df</span>

        <span class="n">dts_to_repair</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">f_repair_rows</span><span class="p">]</span>
        <span class="c1"># indices_to_repair = np.where(f_repair_rows)[0]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dts_to_repair</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df</span>

        <span class="n">df_v2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">&quot;Repaired?&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_v2</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df_v2</span><span class="p">[</span><span class="s2">&quot;Repaired?&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">df_good</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="n">price_cols</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
        <span class="n">f_tag</span> <span class="o">=</span> <span class="n">df_v2</span><span class="p">[</span><span class="n">price_cols</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">==</span> <span class="n">tag</span>

        <span class="c1"># Group nearby NaN-intervals together to reduce number of Yahoo fetches</span>
        <span class="n">dts_groups</span> <span class="o">=</span> <span class="p">[[</span><span class="n">dts_to_repair</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>
        <span class="c1"># last_dt = dts_to_repair[0]</span>
        <span class="c1"># last_ind = indices_to_repair[0]</span>
        <span class="c1"># td = yfcd.intervalToTimedelta[self.interval]</span>
        <span class="c1"># if self.interval == yfcd.Interval.Months1:</span>
        <span class="c1">#     grp_td_threshold = timedelta(days=28)</span>
        <span class="c1"># elif self.interval == yfcd.Interval.Week:</span>
        <span class="c1">#     grp_td_threshold = timedelta(days=28)</span>
        <span class="c1"># elif self.interval == yfcd.Interval.Days1:</span>
        <span class="c1">#     grp_td_threshold = timedelta(days=14)</span>
        <span class="c1"># elif self.interval == yfcd.Interval.Hours1:</span>
        <span class="c1">#     grp_td_threshold = timedelta(days=7)</span>
        <span class="c1"># else:</span>
        <span class="c1">#     grp_td_threshold = timedelta(days=2)</span>
        <span class="c1">#     # grp_td_threshold = timedelta(days=7)</span>
        <span class="c1"># for i in range(1, len(dts_to_repair)):</span>
        <span class="c1">#     ind = indices_to_repair[i]</span>
        <span class="c1">#     dt = dts_to_repair[i]</span>
        <span class="c1">#     if (dt-dts_groups[-1][-1]) &lt; grp_td_threshold:</span>
        <span class="c1">#         dts_groups[-1].append(dt)</span>
        <span class="c1">#     elif ind - last_ind &lt;= 3:</span>
        <span class="c1">#         dts_groups[-1].append(dt)</span>
        <span class="c1">#     else:</span>
        <span class="c1">#         dts_groups.append([dt])</span>
        <span class="c1">#     last_dt = dt</span>
        <span class="c1">#     last_ind = ind</span>
        <span class="c1"># for i in range(1, len(dts_to_repair)):</span>
        <span class="c1">#     ind = indices_to_repair[i]</span>
        <span class="c1">#     dt = dts_to_repair[i]</span>
        <span class="c1">#     if (dt-dts_groups[-1][-1]) &lt; grp_td_threshold:</span>
        <span class="c1">#         dts_groups[-1].append(dt)</span>
        <span class="c1">#     elif ind - last_ind &lt;= 3:</span>
        <span class="c1">#         dts_groups[-1].append(dt)</span>
        <span class="c1">#     else:</span>
        <span class="c1">#         dts_groups.append([dt])</span>
        <span class="c1">#     last_dt = dt</span>
        <span class="c1">#     last_ind = ind</span>
        <span class="c1"># if self.interval == yfcd.Interval.Months1:</span>
        <span class="c1">#     grp_max_size = dateutil.relativedelta.relativedelta(years=2)</span>
        <span class="c1"># elif self.interval == yfcd.Interval.Week:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Week</span><span class="p">:</span>
            <span class="n">grp_max_size</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">relativedelta</span><span class="o">.</span><span class="n">relativedelta</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span><span class="p">:</span>
            <span class="n">grp_max_size</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">relativedelta</span><span class="o">.</span><span class="n">relativedelta</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Hours1</span><span class="p">:</span>
            <span class="n">grp_max_size</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">relativedelta</span><span class="o">.</span><span class="n">relativedelta</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">grp_max_size</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- grp_max_size =&quot;</span><span class="p">,</span> <span class="n">grp_max_size</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dts_to_repair</span><span class="p">)):</span>
            <span class="c1"># ind = indices_to_repair[i]</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">dts_to_repair</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">dts_groups</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">+</span><span class="n">grp_max_size</span><span class="p">:</span>
                <span class="n">dts_groups</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dts_groups</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">dt</span><span class="p">])</span>
            <span class="c1"># last_dt = dt</span>
            <span class="c1"># last_ind = ind</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Repair groups:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">dts_groups</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">g</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Add some good data to each group, so can calibrate later:</span>
        <span class="c1"># for i in range(len(dts_groups)):</span>
        <span class="c1">#     g = dts_groups[i]</span>
        <span class="c1">#     g0 = g[0]</span>
        <span class="c1">#     i0 = df_good.index.get_loc(g0)</span>
        <span class="c1">#     if i0 &gt; 0:</span>
        <span class="c1">#         dts_groups[i].insert(0, df_good.index[i0-1])</span>
        <span class="c1">#     gl = g[-1]</span>
        <span class="c1">#     il = df_good.index.get_loc(gl)</span>
        <span class="c1">#     if il &lt; len(df_good)-1:</span>
        <span class="c1">#         dts_groups[i].append(df_good.index[il+1])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dts_groups</span><span class="p">)):</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">dts_groups</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">g0</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">i0</span> <span class="o">=</span> <span class="n">df_good</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_indexer</span><span class="p">([</span><span class="n">g0</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">i0</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">min_dt</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">df_good</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i0</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_dt</span><span class="p">)</span> \
                    <span class="ow">and</span> <span class="p">((</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">intraday</span><span class="p">)</span> <span class="ow">or</span> <span class="n">df_good</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i0</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">==</span> <span class="n">g0</span><span class="o">.</span><span class="n">date</span><span class="p">()):</span>
                    <span class="n">i0</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">gl</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">il</span> <span class="o">=</span> <span class="n">df_good</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_indexer</span><span class="p">([</span><span class="n">gl</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">il</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_good</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">intraday</span><span class="p">)</span> <span class="ow">or</span> <span class="n">df_good</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">il</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">==</span> <span class="n">gl</span><span class="o">.</span><span class="n">date</span><span class="p">():</span>
                    <span class="n">il</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">good_dts</span> <span class="o">=</span> <span class="n">df_good</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i0</span><span class="p">:</span><span class="n">il</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dts_groups</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">good_dts</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
            <span class="n">dts_groups</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="n">n_fixed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">dts_groups</span><span class="p">:</span>
            <span class="n">df_block</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">g</span><span class="p">)]</span>

            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;df_block:&quot;</span><span class="p">)</span> <span class="p">;</span> <span class="nb">print</span><span class="p">(</span><span class="n">df_block</span><span class="p">)</span>

            <span class="n">start_dt</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">start_d</span> <span class="o">=</span> <span class="n">start_dt</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">sub_interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Hours1</span> <span class="ow">and</span> <span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">-</span><span class="n">start_d</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">729</span><span class="p">):</span>
                <span class="c1"># Don&#39;t bother requesting more price data, Yahoo will reject</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">sub_interval</span> <span class="ow">in</span> <span class="p">[</span><span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Mins30</span><span class="p">,</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Mins15</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">-</span><span class="n">start_d</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">59</span><span class="p">):</span>
                <span class="c1"># Don&#39;t bother requesting more price data, Yahoo will reject</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record_stack_trace</span><span class="p">:</span>
                <span class="c1"># Log function calls to detect and manage infinite recursion</span>
                <span class="n">fn_tuple</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;_reconstruct_intervals_batch()&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;dt0=</span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;interval=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fn_tuple</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stack_trace</span><span class="p">:</span>
                    <span class="c1"># Detected a potential recursion loop</span>
                    <span class="n">reconstruct_detected</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stack_trace</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                        <span class="k">if</span> <span class="s2">&quot;_reconstruct_intervals_batch&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stack_trace</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                            <span class="n">reconstruct_detected</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="n">reconstruct_detected</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_infinite_recursion_detected</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_stack_trace</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn_tuple</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span><span class="p">:</span>
                <span class="n">log_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;repairing </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="si">}</span><span class="s2"> block </span><span class="si">{</span><span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">g</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">+</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;repairing </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="si">}</span><span class="s2"> block </span><span class="si">{</span><span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">g</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">LogEvent</span><span class="p">(</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="s2">&quot;PriceManager&quot;</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">)</span>

            <span class="c1"># Infinite loop potential here via repair:</span>
            <span class="c1"># - request fine-grained data e.g. 1H</span>
            <span class="c1"># - 1H requires accurate dividend data</span>
            <span class="c1"># - triggers fetch of 1D data which must be kept contiguous</span>
            <span class="c1"># - triggers fetch of older 1D data which requires repair using 1H data -&gt; recursion loop</span>
            <span class="c1"># Solution:</span>
            <span class="c1"># 1) add tuple to fn stack buy with YF=True</span>
            <span class="c1"># 2) if that tuple already in stack then raise Exception</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Week</span><span class="p">:</span>
                <span class="n">fetch_start</span> <span class="o">=</span> <span class="n">start_d</span> <span class="o">-</span> <span class="n">td_range</span>  <span class="c1"># need previous week too</span>
                <span class="n">fetch_end</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">+</span> <span class="n">td_range</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span><span class="p">:</span>
                <span class="n">fetch_start</span> <span class="o">=</span> <span class="n">start_d</span>
                <span class="n">fetch_end</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">+</span> <span class="n">td_range</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fetch_start</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">fetch_end</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">td_range</span>
            <span class="c1"># print(f&quot;fetch_start={fetch_start} fetch_end={fetch_end}&quot;)</span>

            <span class="c1"># prepost = self.interval == yfcd.Interval.Days1</span>
            <span class="n">prepost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- fetch_start=</span><span class="si">{</span><span class="n">fetch_start</span><span class="si">}</span><span class="s2">, fetch_end=</span><span class="si">{</span><span class="n">fetch_end</span><span class="si">}</span><span class="s2"> prepost=</span><span class="si">{</span><span class="n">prepost</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infinite_recursion_detected</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stack_trace</span><span class="p">)):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="o">*</span><span class="n">i</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stack_trace</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;WARNING: Infinite recursion detected (see stack trace above). Switch to fetching prices direct from YF&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: Infinite recursion detected (see stack trace above). Switch to fetching prices direct from YF&quot;</span><span class="p">)</span>
                <span class="c1"># df_fine = self.dat.history(start=fetch_start, end=fetch_end, interval=yfcd.intervalToString[sub_interval], auto_adjust=False, prepost=prepost, keepna=True)</span>
            <span class="c1"># elif self.interval in [yfcd.Interval.Days1]:  # or self._infinite_recursion_detected:</span>
            <span class="c1">#     # Assume infinite recursion will happen</span>
            <span class="c1">#     df_fine = self.dat.history(start=fetch_start, end=fetch_end, interval=yfcd.intervalToString[sub_interval], auto_adjust=False, repair=True)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">prepost</span> <span class="ow">and</span> <span class="n">sub_intraday</span><span class="p">:</span>
                    <span class="c1"># YFC cannot handle intraday pre- and post-market, so fetch via yfinance</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                        <span class="c1"># print(&quot;- fetching df_fine direct from YF&quot;)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- - fetch_start=</span><span class="si">{</span><span class="n">fetch_start</span><span class="si">}</span><span class="s2"> fetch_end=</span><span class="si">{</span><span class="n">fetch_end</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">df_fine_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">fetch_start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">fetch_end</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">yfcd</span><span class="o">.</span><span class="n">intervalToString</span><span class="p">[</span><span class="n">sub_interval</span><span class="p">],</span> <span class="n">auto_adjust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prepost</span><span class="o">=</span><span class="n">prepost</span><span class="p">)</span>
                    <span class="n">hist_sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">GetHistory</span><span class="p">(</span><span class="n">sub_interval</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fetch_start</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
                        <span class="n">fetch_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">fetch_start</span><span class="p">,</span> <span class="n">time</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">ZoneInfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tzName</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fetch_end</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
                        <span class="n">fetch_end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">fetch_end</span><span class="p">,</span> <span class="n">time</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">ZoneInfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tzName</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- fetching df_fine via _fetchYfHistory() wrapper&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- - fetch_start=</span><span class="si">{</span><span class="n">fetch_start</span><span class="si">}</span><span class="s2"> fetch_end=</span><span class="si">{</span><span class="n">fetch_end</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">df_fine</span> <span class="o">=</span> <span class="n">hist_sub</span><span class="o">.</span><span class="n">_fetchYfHistory</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">fetch_start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">fetch_end</span><span class="p">,</span> <span class="n">prepost</span><span class="o">=</span><span class="n">prepost</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verify_intervals</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">disable_yfc_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">NoPriceDataInRangeException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- fetch of fine price data failed:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">df_fine</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">adj</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_fine</span><span class="p">[</span><span class="s2">&quot;Adj Close&quot;</span><span class="p">]</span><span class="o">/</span><span class="n">df_fine</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Open&quot;</span><span class="p">,</span> <span class="s2">&quot;Low&quot;</span><span class="p">,</span> <span class="s2">&quot;High&quot;</span><span class="p">,</span> <span class="s2">&quot;Close&quot;</span><span class="p">]:</span>
                            <span class="n">df_fine</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*=</span> <span class="n">adj</span>
                        <span class="n">df_fine</span> <span class="o">=</span> <span class="n">df_fine</span><span class="p">[[</span><span class="s2">&quot;Open&quot;</span><span class="p">,</span> <span class="s2">&quot;Low&quot;</span><span class="p">,</span> <span class="s2">&quot;High&quot;</span><span class="p">,</span> <span class="s2">&quot;Close&quot;</span><span class="p">,</span> <span class="s2">&quot;Volume&quot;</span><span class="p">,</span> <span class="s2">&quot;Dividends&quot;</span><span class="p">,</span> <span class="s2">&quot;Stock Splits&quot;</span><span class="p">]]</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;df_fine_old:&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">df_fine_old</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;df_fine:&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">df_fine</span><span class="p">)</span>
                    <span class="c1"># raise Exception(&quot;here&quot;)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- fetching df_fine via YFC&quot;</span><span class="p">)</span>
                    <span class="n">hist_sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">GetHistory</span><span class="p">(</span><span class="n">sub_interval</span><span class="p">)</span>
                    <span class="n">df_fine</span> <span class="o">=</span> <span class="n">hist_sub</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fetch_start</span><span class="p">,</span> <span class="n">fetch_end</span><span class="p">,</span> <span class="n">adjust_splits</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">adjust_divs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">repair</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">prepost</span><span class="o">=</span><span class="n">prepost</span><span class="p">)</span>
                <span class="c1"># df_fine[&quot;Adj Close&quot;] = df_fine[&quot;Close&quot;] * df_fine[&quot;CDF&quot;]</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- df_fine:&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">df_fine</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">df_fine</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_fine</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;YF: WARNING: Cannot reconstruct because Yahoo not returning data in interval&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record_stack_trace</span><span class="p">:</span>
                    <span class="c1"># Pop stack trace</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stack_trace</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failing to correctly push/pop stack trace (is empty too early)&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stack_trace</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">fn_tuple</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stack_trace</span><span class="p">)):</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="o">*</span><span class="n">i</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stack_trace</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failing to correctly push/pop stack trace (see above)&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_stack_trace</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stack_trace</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">df_fine</span><span class="p">[</span><span class="s2">&quot;ctr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Week</span><span class="p">:</span>
                <span class="c1"># df_fine[&quot;Week Start&quot;] = df_fine.index.tz_localize(None).to_period(&quot;W-SUN&quot;).start_time</span>
                <span class="n">weekdays</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;MON&quot;</span><span class="p">,</span> <span class="s2">&quot;TUE&quot;</span><span class="p">,</span> <span class="s2">&quot;WED&quot;</span><span class="p">,</span> <span class="s2">&quot;THU&quot;</span><span class="p">,</span> <span class="s2">&quot;FRI&quot;</span><span class="p">,</span> <span class="s2">&quot;SAT&quot;</span><span class="p">,</span> <span class="s2">&quot;SUN&quot;</span><span class="p">]</span>
                <span class="n">week_end_day</span> <span class="o">=</span> <span class="n">weekdays</span><span class="p">[(</span><span class="n">df_block</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span> <span class="o">+</span> <span class="mi">7</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span><span class="p">]</span>
                <span class="n">df_fine</span><span class="p">[</span><span class="s2">&quot;Week Start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_fine</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">to_period</span><span class="p">(</span><span class="s2">&quot;W-&quot;</span><span class="o">+</span><span class="n">week_end_day</span><span class="p">)</span><span class="o">.</span><span class="n">start_time</span>
                <span class="n">grp_col</span> <span class="o">=</span> <span class="s2">&quot;Week Start&quot;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span><span class="p">:</span>
                <span class="n">df_fine</span><span class="p">[</span><span class="s2">&quot;Day Start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_fine</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
                <span class="n">grp_col</span> <span class="o">=</span> <span class="s2">&quot;Day Start&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df_fine</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_fine</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">df_block</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="s2">&quot;ctr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">df_fine</span><span class="p">[</span><span class="s2">&quot;intervalID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_fine</span><span class="p">[</span><span class="s2">&quot;ctr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
                <span class="n">df_fine</span> <span class="o">=</span> <span class="n">df_fine</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;ctr&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">grp_col</span> <span class="o">=</span> <span class="s2">&quot;intervalID&quot;</span>
            <span class="c1"># df_fine = df_fine[~df_fine[price_cols].isna().all(axis=1)]</span>

            <span class="n">df_new</span> <span class="o">=</span> <span class="n">df_fine</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">grp_col</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
                <span class="n">Open</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Open&quot;</span><span class="p">,</span> <span class="s2">&quot;first&quot;</span><span class="p">),</span>
                <span class="n">Close</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Close&quot;</span><span class="p">,</span> <span class="s2">&quot;last&quot;</span><span class="p">),</span>
                <span class="c1"># AdjClose=(&quot;Adj Close&quot;, &quot;last&quot;),</span>
                <span class="n">Low</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Low&quot;</span><span class="p">,</span> <span class="s2">&quot;min&quot;</span><span class="p">),</span>
                <span class="n">High</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;High&quot;</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">),</span>
                <span class="n">Volume</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Volume&quot;</span><span class="p">,</span> <span class="s2">&quot;sum&quot;</span><span class="p">))</span>
                <span class="c1"># CSF=(&quot;CSF&quot;, &quot;first&quot;),</span>
                <span class="c1"># CDF=(&quot;CDF&quot;, &quot;first&quot;))#.rename(columns={&quot;AdjClose&quot;: &quot;Adj Close&quot;})</span>
            <span class="k">if</span> <span class="n">grp_col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Week Start&quot;</span><span class="p">,</span> <span class="s2">&quot;Day Start&quot;</span><span class="p">]:</span>
                <span class="n">df_new</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df_new</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="n">df_fine</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df_fine</span><span class="p">[</span><span class="s2">&quot;diff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_fine</span><span class="p">[</span><span class="s2">&quot;intervalID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
                <span class="n">new_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">df_fine</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">df_fine</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">df_fine</span><span class="p">[</span><span class="s2">&quot;intervalID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
                <span class="n">df_new</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">new_index</span>

            <span class="c1"># Calibrate! Check whether &#39;df_fine&#39; has different split-adjustment.</span>
            <span class="c1"># If different, then adjust to match &#39;df&#39;</span>
            <span class="n">df_block_calib</span> <span class="o">=</span> <span class="n">df_block</span><span class="p">[</span><span class="n">price_cols</span><span class="p">]</span>
            <span class="c1"># df_new_calib = df_new[df_new.index.isin(df_block_calib.index)][price_cols]</span>
            <span class="c1"># df_block_calib = df_block_calib[df_block_calib.index.isin(df_new_calib)]</span>
            <span class="n">common_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">df_block_calib</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_new</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">df_new_calib</span> <span class="o">=</span> <span class="n">df_new</span><span class="p">[</span><span class="n">price_cols</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">common_index</span><span class="p">]</span>
            <span class="n">df_block_calib</span> <span class="o">=</span> <span class="n">df_block_calib</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">common_index</span><span class="p">]</span>
            <span class="n">calib_filter</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_block_calib</span> <span class="o">!=</span> <span class="n">tag</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calib_filter</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="c1"># Can&#39;t calibrate so don&#39;t attempt repair</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record_stack_trace</span><span class="p">:</span>
                    <span class="c1"># Pop stack trace</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stack_trace</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failing to correctly push/pop stack trace (is empty too early)&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stack_trace</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">fn_tuple</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stack_trace</span><span class="p">)):</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="o">*</span><span class="n">i</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stack_trace</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failing to correctly push/pop stack trace (see above)&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_stack_trace</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stack_trace</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;calib_filter:&quot;</span><span class="p">)</span> <span class="p">;</span> <span class="nb">print</span><span class="p">(</span><span class="n">calib_filter</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;df_new_calib:&quot;</span><span class="p">)</span> <span class="p">;</span> <span class="nb">print</span><span class="p">(</span><span class="n">df_new_calib</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;df_block_calib:&quot;</span><span class="p">)</span> <span class="p">;</span> <span class="nb">print</span><span class="p">(</span><span class="n">df_block_calib</span><span class="p">)</span>
            <span class="c1"># Avoid divide-by-zero warnings printing:</span>
            <span class="n">df_new_calib</span> <span class="o">=</span> <span class="n">df_new_calib</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">df_block_calib</span> <span class="o">=</span> <span class="n">df_block_calib</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">price_cols</span><span class="p">)):</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">price_cols</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">f</span> <span class="o">=</span> <span class="o">~</span><span class="n">calib_filter</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="n">df_block_calib</span><span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">df_new_calib</span><span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">ratios</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_block_calib</span> <span class="o">/</span> <span class="n">df_new_calib</span><span class="p">)[</span><span class="n">calib_filter</span><span class="p">]</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ratios</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="n">ratio_rcp</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">ratio</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ratio</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">ratio_rcp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Good!</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ratio</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># data has different split-adjustment than fine-grained data</span>
                    <span class="c1"># Adjust fine-grained to match</span>
                    <span class="n">df_new</span><span class="p">[</span><span class="n">price_cols</span><span class="p">]</span> <span class="o">*=</span> <span class="n">ratio</span>
                    <span class="n">df_new</span><span class="p">[</span><span class="s2">&quot;Volume&quot;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">ratio</span>
                    <span class="n">df_new</span><span class="p">[</span><span class="s2">&quot;Volume&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_new</span><span class="p">[</span><span class="s2">&quot;Volume&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">ratio_rcp</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># data has different split-adjustment than fine-grained data</span>
                    <span class="c1"># Adjust fine-grained to match</span>
                    <span class="n">df_new</span><span class="p">[</span><span class="n">price_cols</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">ratio_rcp</span>
                    <span class="n">df_new</span><span class="p">[</span><span class="s2">&quot;Volume&quot;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">ratio_rcp</span>
                    <span class="n">df_new</span><span class="p">[</span><span class="s2">&quot;Volume&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_new</span><span class="p">[</span><span class="s2">&quot;Volume&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>

            <span class="c1"># Repair!</span>
            <span class="n">bad_dts</span> <span class="o">=</span> <span class="n">df_block</span><span class="o">.</span><span class="n">index</span><span class="p">[(</span><span class="n">df_block</span><span class="p">[</span><span class="n">price_cols</span><span class="p">]</span> <span class="o">==</span> <span class="n">tag</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>

            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">bad_dts</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_new</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="c1"># Yahoo didn&#39;t return finer-grain data for this interval,</span>
                    <span class="c1"># so probably no trading happened.</span>
                    <span class="c1"># print(&quot;no fine data&quot;)</span>
                    <span class="k">continue</span>
                <span class="n">df_new_row</span> <span class="o">=</span> <span class="n">df_new</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Week</span><span class="p">:</span>
                    <span class="n">df_last_week</span> <span class="o">=</span> <span class="n">df_new</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">df_new</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">df_fine</span> <span class="o">=</span> <span class="n">df_fine</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">:]</span>

                <span class="n">df_bad_row</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">bad_fields</span> <span class="o">=</span> <span class="n">df_bad_row</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">df_bad_row</span> <span class="o">==</span> <span class="n">tag</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="k">if</span> <span class="s2">&quot;High&quot;</span> <span class="ow">in</span> <span class="n">bad_fields</span><span class="p">:</span>
                    <span class="n">df_v2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;High&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_new_row</span><span class="p">[</span><span class="s2">&quot;High&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s2">&quot;Low&quot;</span> <span class="ow">in</span> <span class="n">bad_fields</span><span class="p">:</span>
                    <span class="n">df_v2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;Low&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_new_row</span><span class="p">[</span><span class="s2">&quot;Low&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s2">&quot;Open&quot;</span> <span class="ow">in</span> <span class="n">bad_fields</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Week</span> <span class="ow">and</span> <span class="n">idx</span> <span class="o">!=</span> <span class="n">df_fine</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="c1"># Exchange closed Monday. In this case, Yahoo sets Open to last week close</span>
                        <span class="n">df_v2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;Open&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_last_week</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">]</span>
                        <span class="n">df_v2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;Low&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">df_v2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;Open&quot;</span><span class="p">],</span> <span class="n">df_v2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;Low&quot;</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">df_v2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;Open&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_new_row</span><span class="p">[</span><span class="s2">&quot;Open&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s2">&quot;Close&quot;</span> <span class="ow">in</span> <span class="n">bad_fields</span><span class="p">:</span>
                    <span class="n">df_v2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;Close&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_new_row</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">]</span>
                    <span class="c1"># Should not need to copy over CDF &amp; CSF, because</span>
                    <span class="c1"># correct values are already merged in from daily</span>
                    <span class="c1"># df_v2.loc[idx, &quot;CDF&quot;] = df_new_row[&quot;CDF&quot;]</span>
                    <span class="c1"># df_v2.loc[idx, &quot;CSF&quot;] = df_new_row[&quot;CSF&quot;]</span>
                <span class="k">if</span> <span class="s2">&quot;Volume&quot;</span> <span class="ow">in</span> <span class="n">bad_fields</span><span class="p">:</span>
                    <span class="n">df_v2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;Volume&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_new_row</span><span class="p">[</span><span class="s2">&quot;Volume&quot;</span><span class="p">]</span>
                <span class="n">df_v2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;Repaired?&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">n_fixed</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Restore un-repaired bad values</span>
            <span class="n">f_nan</span> <span class="o">=</span> <span class="n">df_v2</span><span class="p">[</span><span class="n">price_cols</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">f_failed</span> <span class="o">=</span> <span class="n">f_tag</span> <span class="o">&amp;</span> <span class="n">f_nan</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">price_cols</span><span class="p">)):</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">f_failed</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">price_cols</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">df_v2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record_stack_trace</span><span class="p">:</span>
                <span class="c1"># Pop stack trace</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stack_trace</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failing to correctly push/pop stack trace (is empty too early)&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stack_trace</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">fn_tuple</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stack_trace</span><span class="p">)):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="o">*</span><span class="n">i</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stack_trace</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failing to correctly push/pop stack trace (see above)&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_stack_trace</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stack_trace</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">log_msg</span> <span class="o">=</span> <span class="s2">&quot;PM::_reconstruct_intervals_batch() returning&quot;</span>
        <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceExit</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df_v2</span>

    <span class="k">def</span> <span class="nf">_repairUnitMixups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixUnitSwitch</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">df3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repairSporadicUnitMixups</span><span class="p">(</span><span class="n">df2</span><span class="p">,</span> <span class="n">silent</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df3</span>

    <span class="k">def</span> <span class="nf">_repairSporadicUnitMixups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckDataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;df&quot;</span><span class="p">)</span>

        <span class="c1"># Sometimes Yahoo returns few prices in cents/pence instead of $/</span>
        <span class="c1"># I.e. 100x bigger</span>
        <span class="c1"># Easy to detect and fix, just look for outliers = ~100x local median</span>

        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Need multiple rows to confidently identify outliers</span>
            <span class="k">return</span> <span class="n">df</span>

        <span class="n">log_msg_enter</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;PM::_repairSporadicUnitMixups-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="si">}</span><span class="s2">()&quot;</span>
        <span class="n">log_msg_exit</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;PM::_repairSporadicUnitMixups-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="si">}</span><span class="s2">() returning&quot;</span>
        <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceEnter</span><span class="p">(</span><span class="n">log_msg_enter</span><span class="p">)</span>

        <span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">data_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;High&quot;</span><span class="p">,</span> <span class="s2">&quot;Open&quot;</span><span class="p">,</span> <span class="s2">&quot;Low&quot;</span><span class="p">,</span> <span class="s2">&quot;Close&quot;</span><span class="p">]</span>  <span class="c1"># Order important, separate High from Low</span>
        <span class="n">data_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">data_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df2</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">f_zeroes</span> <span class="o">=</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="n">data_cols</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f_zeroes</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">df2_zeroes</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="n">f_zeroes</span><span class="p">]</span>
            <span class="n">df2</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="o">~</span><span class="n">f_zeroes</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df2_zeroes</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">df2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceExit</span><span class="p">(</span><span class="n">log_msg_exit</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span>
        <span class="n">df2_data</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="n">data_cols</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">median</span> <span class="o">=</span> <span class="n">_ndimage</span><span class="o">.</span><span class="n">median_filter</span><span class="p">(</span><span class="n">df2_data</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;wrap&quot;</span><span class="p">)</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="n">df2_data</span> <span class="o">/</span> <span class="n">median</span>
        <span class="n">ratio_rounded</span> <span class="o">=</span> <span class="p">(</span><span class="n">ratio</span> <span class="o">/</span> <span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">()</span> <span class="o">*</span> <span class="mi">20</span>  <span class="c1"># round ratio to nearest 20</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">ratio_rounded</span> <span class="o">==</span> <span class="mi">100</span>
        <span class="n">ratio_rcp</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">ratio</span>
        <span class="n">ratio_rcp_rounded</span> <span class="o">=</span> <span class="p">(</span><span class="n">ratio_rcp</span> <span class="o">/</span> <span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">()</span> <span class="o">*</span> <span class="mi">20</span>  <span class="c1"># round ratio to nearest 20</span>
        <span class="n">f_rcp</span> <span class="o">=</span> <span class="p">(</span><span class="n">ratio_rounded</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ratio_rcp_rounded</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">f_either</span> <span class="o">=</span> <span class="n">f</span> <span class="o">|</span> <span class="n">f_rcp</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">f_either</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceExit</span><span class="p">(</span><span class="n">log_msg_exit</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span>

        <span class="c1"># Mark values to send for repair</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_cols</span><span class="p">)):</span>
            <span class="n">fi</span> <span class="o">=</span> <span class="n">f_either</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">data_cols</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">df2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">fi</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">tag</span>

        <span class="n">n_before</span> <span class="o">=</span> <span class="p">(</span><span class="n">df2_data</span> <span class="o">==</span> <span class="n">tag</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">df2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reconstruct_intervals_batch</span><span class="p">(</span><span class="n">df2</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stack_trace</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_stack_trace</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stack_trace</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="n">n_after</span> <span class="o">=</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="n">data_cols</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">==</span> <span class="n">tag</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">n_after</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># This second pass will *crudely* &quot;fix&quot; any remaining errors in High/Low</span>
            <span class="c1"># simply by ensuring they don&#39;t contradict e.g. Low = 100x High.</span>
            <span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="n">data_cols</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">==</span> <span class="n">tag</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">f</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">fi</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">fi</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="k">continue</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">,</span> <span class="s1">&#39;Close&#39;</span><span class="p">]:</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">data_cols</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">fi</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                        <span class="n">df2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.01</span>

                <span class="n">c</span> <span class="o">=</span> <span class="s2">&quot;High&quot;</span> <span class="p">;</span> <span class="n">j</span> <span class="o">=</span> <span class="n">data_cols</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fi</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                    <span class="n">df2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;Open&quot;</span><span class="p">,</span> <span class="s2">&quot;Close&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

                <span class="n">c</span> <span class="o">=</span> <span class="s2">&quot;Low&quot;</span> <span class="p">;</span> <span class="n">j</span> <span class="o">=</span> <span class="n">data_cols</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fi</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                    <span class="n">df2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;Open&quot;</span><span class="p">,</span> <span class="s2">&quot;Close&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

            <span class="n">f_rcp</span> <span class="o">=</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="n">data_cols</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">==</span> <span class="n">tag</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">f_rcp</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">f_rcp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">fi</span> <span class="o">=</span> <span class="n">f_rcp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">fi</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="k">continue</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">,</span> <span class="s1">&#39;Close&#39;</span><span class="p">]:</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">data_cols</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">fi</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                        <span class="n">df2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="mf">100.0</span>

                <span class="n">c</span> <span class="o">=</span> <span class="s2">&quot;High&quot;</span> <span class="p">;</span> <span class="n">j</span> <span class="o">=</span> <span class="n">data_cols</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fi</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                    <span class="n">df2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;Open&quot;</span><span class="p">,</span> <span class="s2">&quot;Close&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

                <span class="n">c</span> <span class="o">=</span> <span class="s2">&quot;Low&quot;</span> <span class="p">;</span> <span class="n">j</span> <span class="o">=</span> <span class="n">data_cols</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fi</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                    <span class="n">df2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;Open&quot;</span><span class="p">,</span> <span class="s2">&quot;Close&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

        <span class="n">n_after_crude</span> <span class="o">=</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="n">data_cols</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">==</span> <span class="n">tag</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="n">n_fixed</span> <span class="o">=</span> <span class="n">n_before</span> <span class="o">-</span> <span class="n">n_after_crude</span>
        <span class="n">n_fixed_crudely</span> <span class="o">=</span> <span class="n">n_after</span> <span class="o">-</span> <span class="n">n_after_crude</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span> <span class="ow">and</span> <span class="n">n_fixed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">report_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: fixed </span><span class="si">{</span><span class="n">n_fixed</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">n_before</span><span class="si">}</span><span class="s2"> currency unit mixups &quot;</span>
            <span class="k">if</span> <span class="n">n_fixed_crudely</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">report_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">n_fixed_crudely</span><span class="si">}</span><span class="s2"> crudely) &quot;</span>
            <span class="n">report_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="si">}</span><span class="s2"> price data&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">report_msg</span><span class="p">)</span>

        <span class="c1"># Restore original values where repair failed</span>
        <span class="n">f_either</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="n">data_cols</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">==</span> <span class="n">tag</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_cols</span><span class="p">)):</span>
            <span class="n">fj</span> <span class="o">=</span> <span class="n">f_either</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">fj</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">data_cols</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">df2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">fj</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">fj</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">df2_zeroes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df2</span><span class="p">,</span> <span class="n">df2_zeroes</span><span class="p">])</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
            <span class="n">df2</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">()</span>

        <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceExit</span><span class="p">(</span><span class="n">log_msg_exit</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df2</span>

    <span class="k">def</span> <span class="nf">_fixUnitSwitch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="c1"># Sometimes Yahoo returns few prices in cents/pence instead of $/</span>
        <span class="c1"># I.e. 100x bigger</span>
        <span class="c1"># 2 ways this manifests:</span>
        <span class="c1"># - random 100x errors spread throughout table</span>
        <span class="c1"># - a sudden switch between $&lt;-&gt;cents at some date</span>
        <span class="c1"># This function fixes the second.</span>
        <span class="c1"># Eventually Yahoo fixes but could take them 2 weeks.</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">==</span> <span class="s1">&#39;KUW&#39;</span><span class="p">:</span>
            <span class="c1"># Kuwaiti Dinar divided into 1000 not 100</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mf">1000.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mf">100.0</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixPricesSuddenChange</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_fixBadStockSplits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="c1"># Original logic only considered latest split adjustment could be missing, but </span>
        <span class="c1"># actually **any** split adjustment can be missing. So check all splits in df.</span>
        <span class="c1">#</span>
        <span class="c1"># Improved logic looks for BIG daily price changes that closely match the</span>
        <span class="c1"># **nearest future** stock split ratio. This indicates Yahoo failed to apply a new</span>
        <span class="c1"># stock split to old price data.</span>
        <span class="c1">#</span>
        <span class="c1"># There is a slight complication, because Yahoo does another stupid thing.</span>
        <span class="c1"># Sometimes the old data is adjusted twice. So cannot simply assume</span>
        <span class="c1"># which direction to reverse adjustment - have to analyse prices and detect.</span>
        <span class="c1"># Not difficult.</span>

        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>   <span class="c1"># scan splits oldest -&gt; newest</span>
        <span class="n">split_f</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Stock Splits&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">split_f</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">df</span>

        <span class="k">for</span> <span class="n">split_idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">split_f</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">split_dt</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">split_idx</span><span class="p">]</span>
            <span class="n">split</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">split_dt</span><span class="p">,</span> <span class="s1">&#39;Stock Splits&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">split_dt</span> <span class="o">==</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">continue</span>

            <span class="c1"># logger.debug(f&#39;price-repair-split: Checking split {split:.4f} @ {split_dt.date()} for possible repair&#39;)</span>

            <span class="n">cutoff_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">split_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># add one row after to detect big change</span>
            <span class="n">df_pre_split</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">cutoff_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">df_pre_split_repaired</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixPricesSuddenChange</span><span class="p">(</span><span class="n">df_pre_split</span><span class="p">,</span> <span class="n">split</span><span class="p">,</span> <span class="n">correct_volume</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># Merge back in:</span>
            <span class="k">if</span> <span class="n">cutoff_idx</span> <span class="o">==</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df_pre_split_repaired</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_pre_split_repaired</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(),</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">cutoff_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">:]])</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">_fixPricesSuddenChange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">change</span><span class="p">,</span> <span class="n">correct_volume</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">log_func</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;PM::_fixPricesSuddenChange-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="si">}</span><span class="s2">(change=</span><span class="si">{</span><span class="n">change</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceEnter</span><span class="p">(</span><span class="n">log_func</span><span class="p">)</span>

        <span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">split</span> <span class="o">=</span> <span class="n">change</span>
        <span class="n">split_rcp</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">split</span>

        <span class="k">if</span> <span class="n">change</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">100.0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">]:</span>
            <span class="n">fix_type</span> <span class="o">=</span> <span class="s1">&#39;100x error&#39;</span>
            <span class="n">start_min</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fix_type</span> <span class="o">=</span> <span class="s1">&#39;bad split&#39;</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;Stock Splits&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">!=</span> <span class="mf">0.0</span>
            <span class="n">start_min</span> <span class="o">=</span> <span class="p">(</span><span class="n">df2</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">relativedelta</span><span class="o">.</span><span class="n">relativedelta</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

        <span class="n">OHLC</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">,</span> <span class="s1">&#39;High&#39;</span><span class="p">,</span> <span class="s1">&#39;Low&#39;</span><span class="p">,</span> <span class="s1">&#39;Close&#39;</span><span class="p">]</span>

        <span class="c1"># Do not attempt repair of the split is small, </span>
        <span class="c1"># could be mistaken for normal price variance</span>
        <span class="k">if</span> <span class="mf">0.8</span> <span class="o">&lt;</span> <span class="n">split</span> <span class="o">&lt;</span> <span class="mf">1.25</span><span class="p">:</span>
            <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceExit</span><span class="p">(</span><span class="n">log_func</span> <span class="o">+</span> <span class="s2">&quot;: aborting, split too near 1.0&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span>

        <span class="n">n</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">df_debug</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df_debug</span> <span class="o">=</span> <span class="n">df_debug</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;Volume&#39;</span><span class="p">,</span> <span class="s1">&#39;Dividends&#39;</span><span class="p">,</span> <span class="s1">&#39;Repaired?&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="n">df_debug</span> <span class="o">=</span> <span class="n">df_debug</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;CDF&#39;</span><span class="p">,</span> <span class="s1">&#39;CSF&#39;</span><span class="p">,</span> <span class="s1">&#39;C-Check?&#39;</span><span class="p">,</span> <span class="s1">&#39;LastDivAdjustDt&#39;</span><span class="p">,</span> <span class="s1">&#39;LastSplitAdjustDt&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="n">debug_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">,</span> <span class="s1">&#39;Close&#39;</span><span class="p">]</span>
        <span class="n">df_debug</span> <span class="o">=</span> <span class="n">df_debug</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">OHLC</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">debug_cols</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

        <span class="c1"># Calculate daily price % change. To reduce effect of price volatility, </span>
        <span class="c1"># calculate change for each OHLC column.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">!=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span> <span class="ow">and</span> <span class="n">split</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">100.0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">]:</span>
            <span class="c1"># Avoid using &#39;Low&#39; and &#39;High&#39;. For multiday intervals, these can be </span>
            <span class="c1"># very volatile so reduce ability to detect genuine stock split errors</span>
            <span class="n">_1d_change_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">price_data</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[[</span><span class="s1">&#39;Open&#39;</span><span class="p">,</span><span class="s1">&#39;Close&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">f_zero</span> <span class="o">=</span> <span class="n">price_data</span> <span class="o">==</span> <span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_1d_change_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">price_data</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="n">OHLC</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">f_zero</span> <span class="o">=</span> <span class="n">price_data</span> <span class="o">==</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">f_zero</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">price_data</span><span class="p">[</span><span class="n">f_zero</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="c1"># Update: if a VERY large dividend is paid out, then can be mistaken for a 1:2 stock split.</span>
        <span class="c1"># Fix = use adjusted prices</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">price_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">price_data</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span> <span class="o">*=</span> <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;CDF&#39;</span><span class="p">]</span>

        <span class="n">_1d_change_x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">price_data</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">]</span> <span class="o">/</span> <span class="n">price_data</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">]</span>
        <span class="n">f_zero_num_denom</span> <span class="o">=</span> <span class="n">f_zero</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">f_zero</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f_zero_num_denom</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">_1d_change_x</span><span class="p">[</span><span class="n">f_zero_num_denom</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">!=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span><span class="p">:</span>
            <span class="c1"># average change</span>
            <span class="n">_1d_change_minx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">_1d_change_x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># # change nearest to 1.0</span>
            <span class="c1"># diff = np.abs(_1d_change_x - 1.0)</span>
            <span class="c1"># j_indices = np.argmin(diff, axis=1)</span>
            <span class="c1"># _1d_change_minx = _1d_change_x[np.arange(n), j_indices]</span>
            <span class="c1"># Still distorted by extreme-low high/low. So try median:</span>
            <span class="n">_1d_change_minx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">_1d_change_x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">f_na</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">_1d_change_minx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f_na</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="c1"># Possible if data was too old for reconstruction.</span>
            <span class="n">_1d_change_minx</span><span class="p">[</span><span class="n">f_na</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">df_debug</span><span class="p">[</span><span class="s1">&#39;1D change X&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_1d_change_minx</span>
        <span class="n">df_debug</span><span class="p">[</span><span class="s1">&#39;1D change X&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_debug</span><span class="p">[</span><span class="s1">&#39;1D change X&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>

        <span class="c1"># If all 1D changes are closer to 1.0 than split, exit</span>
        <span class="n">split_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">split</span><span class="p">,</span> <span class="n">split_rcp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">_1d_change_minx</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">split_max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">_1d_change_minx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">((</span><span class="n">split_max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s2">&quot;changes too near 1.0&quot;</span>
            <span class="n">reason</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; (_1d_change_minx = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">_1d_change_minx</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">_1d_change_minx</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="n">yfcl</span><span class="o">.</span><span class="n">TracePrint</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>
            <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceExit</span><span class="p">(</span><span class="n">log_func</span> <span class="o">+</span> <span class="s2">&quot; aborting&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span>

        <span class="c1"># Calculate the true price variance, i.e. remove effect of bad split-adjustments.</span>
        <span class="c1"># Key = ignore 1D changes outside of interquartile range</span>
        <span class="n">q1</span><span class="p">,</span> <span class="n">q3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">_1d_change_minx</span><span class="p">,</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">75</span><span class="p">])</span>
        <span class="n">iqr</span> <span class="o">=</span> <span class="n">q3</span> <span class="o">-</span> <span class="n">q1</span>
        <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">q1</span> <span class="o">-</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">iqr</span>
        <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">q3</span> <span class="o">+</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">iqr</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">_1d_change_minx</span> <span class="o">&gt;=</span> <span class="n">lower_bound</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">_1d_change_minx</span> <span class="o">&lt;=</span> <span class="n">upper_bound</span><span class="p">)</span>
        <span class="n">avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">_1d_change_minx</span><span class="p">[</span><span class="n">f</span><span class="p">])</span>
        <span class="n">sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">_1d_change_minx</span><span class="p">[</span><span class="n">f</span><span class="p">])</span>
        <span class="c1"># Now can calculate SD as % of mean</span>
        <span class="n">sd_pct</span> <span class="o">=</span> <span class="n">sd</span> <span class="o">/</span> <span class="n">avg</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Estimation of true 1D change stats: mean = </span><span class="si">{</span><span class="n">avg</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, StdDev = </span><span class="si">{</span><span class="n">sd</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">sd_pct</span><span class="o">*</span><span class="mf">100.0</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% of mean)&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">LogEvent</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span> <span class="s1">&#39;price-repair-split-&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Only proceed if split adjustment far exceeds normal 1D changes</span>
        <span class="n">largest_change_pct</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">sd_pct</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">!=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span><span class="p">:</span>
            <span class="n">largest_change_pct</span> <span class="o">*=</span> <span class="mi">3</span>
            <span class="c1"># if self.interval in [yfcd.Interval.Months1, yfcd.Interval.Months3]:</span>
            <span class="c1">#     largest_change_pct *= 2</span>
        <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">split</span><span class="p">,</span> <span class="n">split_rcp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">largest_change_pct</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Split ratio too close to normal price volatility. Won&#39;t repair&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">LogEvent</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span> <span class="s1">&#39;price-repair-split-&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
            <span class="c1"># msg = f&quot;price-repair-split: my workings:&quot; + &#39;\n&#39; + str(df_debug)</span>
            <span class="c1"># self.manager.LogEvent(&#39;debug&#39;, &#39;price-repair-split-&#39;+self.istr, msg)</span>
            <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceExit</span><span class="p">(</span><span class="n">log_func</span> <span class="o">+</span> <span class="s2">&quot;: aborting, changes to near normal price volatility&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span>

        <span class="c1"># Now can detect bad split adjustments</span>
        <span class="c1"># Set threshold to halfway between split ratio and largest expected normal price change</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">_1d_change_minx</span> <span class="o">/</span> <span class="n">split_rcp</span>
        <span class="n">split_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">split</span><span class="p">,</span> <span class="n">split_rcp</span><span class="p">)</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="p">(</span><span class="n">split_max</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">largest_change_pct</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;split_max=</span><span class="si">{</span><span class="n">split_max</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> largest_change_pct=</span><span class="si">{</span><span class="n">largest_change_pct</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> threshold=</span><span class="si">{</span><span class="n">threshold</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">LogEvent</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span> <span class="s1">&#39;price-repair-split-&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;Repaired?&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df2</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;Repaired?&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">!=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span><span class="p">:</span>
            <span class="c1"># Yahoo creates multi-day intervals using potentiall corrupt data, e.g.</span>
            <span class="c1"># the Close could be 100x Open. This means have to correct each OHLC column</span>
            <span class="c1"># individually</span>
            <span class="n">correct_columns_individually</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">correct_columns_individually</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">correct_columns_individually</span><span class="p">:</span>
            <span class="n">_1d_change_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">price_data</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="n">OHLC</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">_1d_change_x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">price_data</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">]</span> <span class="o">/</span> <span class="n">price_data</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_1d_change_x</span> <span class="o">=</span> <span class="n">_1d_change_minx</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">_1d_change_x</span> <span class="o">/</span> <span class="n">split_rcp</span>
        <span class="n">f_down</span> <span class="o">=</span> <span class="n">_1d_change_x</span> <span class="o">&lt;</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">threshold</span>
        <span class="n">f_up</span> <span class="o">=</span> <span class="n">_1d_change_x</span> <span class="o">&gt;</span> <span class="n">threshold</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">f_down</span> <span class="o">|</span> <span class="n">f_up</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">correct_columns_individually</span><span class="p">:</span>
            <span class="n">df_debug</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
            <span class="n">df_debug</span><span class="p">[</span><span class="s1">&#39;f_down&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f_down</span>
            <span class="n">df_debug</span><span class="p">[</span><span class="s1">&#39;f_up&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f_up</span>
            <span class="n">df_debug</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_debug</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">OHLC</span><span class="p">)):</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">OHLC</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">debug_cols</span><span class="p">:</span>
                    <span class="n">df_debug</span><span class="p">[</span><span class="n">c</span> <span class="o">+</span> <span class="s1">&#39;_r&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span>
                    <span class="n">df_debug</span><span class="p">[</span><span class="n">c</span> <span class="o">+</span> <span class="s1">&#39;_f_down&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f_down</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span>
                    <span class="n">df_debug</span><span class="p">[</span><span class="n">c</span> <span class="o">+</span> <span class="s1">&#39;_f_up&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f_up</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span>
                    <span class="n">df_debug</span><span class="p">[</span><span class="n">c</span> <span class="o">+</span> <span class="s1">&#39;_r&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_debug</span><span class="p">[</span><span class="n">c</span> <span class="o">+</span> <span class="s1">&#39;_r&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceExit</span><span class="p">(</span><span class="n">log_func</span> <span class="o">+</span> <span class="s2">&quot;: aborting, did not detect split errors&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span>

        <span class="c1"># If stock is currently suspended and not in USA, then usually Yahoo introduces</span>
        <span class="c1"># 100x errors into suspended intervals. Clue is no price change and 0 volume.</span>
        <span class="c1"># Better to use last active trading interval as baseline.</span>
        <span class="n">f_no_activity</span> <span class="o">=</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">f_no_activity</span> <span class="o">=</span> <span class="n">f_no_activity</span> <span class="o">|</span> <span class="n">df2</span><span class="p">[</span><span class="n">OHLC</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">appears_suspended</span> <span class="o">=</span> <span class="n">f_no_activity</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">f_no_activity</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span>
        <span class="n">f_active</span> <span class="o">=</span> <span class="o">~</span><span class="n">f_no_activity</span>
        <span class="c1"># First, ideally, look for 2 consecutive intervals of activity that are not</span>
        <span class="c1"># affected by change errors</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">f_active</span> <span class="o">=</span> <span class="n">f_active</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">f</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f_active</span> <span class="o">=</span> <span class="n">f_active</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">f</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">f_active</span> <span class="o">=</span> <span class="n">f_active</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">f_active</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">f_active</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="c1"># First plan failed, will have to settle for most recent active interval</span>
            <span class="n">f_active</span> <span class="o">=</span> <span class="o">~</span><span class="n">f_no_activity</span>
            <span class="n">f_active</span> <span class="o">=</span> <span class="n">f_active</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">f_active</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">idx_latest_active</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">f_active</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx_latest_active</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">idx_latest_active</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idx_latest_active</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">idx_latest_active</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;appears_suspended=</span><span class="si">{</span><span class="n">appears_suspended</span><span class="si">}</span><span class="s1"> idx_latest_active=</span><span class="si">{</span><span class="n">idx_latest_active</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">idx_latest_active</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; (</span><span class="si">{</span><span class="n">df2</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">idx_latest_active</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s1">)&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">LogEvent</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span> <span class="s1">&#39;price-repair-split-&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Update: if any 100x changes are soon after a stock split, so could be confused with split error, then abort</span>
        <span class="n">threshold_days</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">f_splits</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;Stock Splits&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">!=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">change</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">100.0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">]</span> <span class="ow">and</span> <span class="n">f_splits</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">indices_A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">f_splits</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">indices_B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices_A</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices_B</span><span class="p">):</span>
                <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceExit</span><span class="p">(</span><span class="n">log_func</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">gaps</span> <span class="o">=</span> <span class="n">indices_B</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="n">indices_A</span>
            <span class="c1"># Because data is sorted in DEscending order, need to flip gaps</span>
            <span class="n">gaps</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">f_pos</span> <span class="o">=</span> <span class="n">gaps</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">f_pos</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">gap_min</span> <span class="o">=</span> <span class="n">gaps</span><span class="p">[</span><span class="n">f_pos</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="n">gap_td</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">itd</span> <span class="o">*</span> <span class="n">gap_min</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gap_td</span><span class="p">,</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">relativedelta</span><span class="o">.</span><span class="n">relativedelta</span><span class="p">):</span>
                    <span class="n">threshold</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">relativedelta</span><span class="o">.</span><span class="n">relativedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">threshold_days</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">threshold</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">threshold_days</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">gap_td</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;price-repair-split: 100x changes are too soon after stock split events, aborting&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">LogEvent</span><span class="p">(</span><span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="s1">&#39;price-repair-split-&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                    <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceExit</span><span class="p">(</span><span class="n">log_func</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">df</span>

        <span class="c1"># if self.interday:</span>
        <span class="c1">#     df_debug.index = df_debug.index.date</span>
        <span class="c1"># for c in [&#39;FetchDate&#39;]:</span>
        <span class="c1">#     df_debug[c] = df_debug[c].dt.strftime(&#39;%Y-%m-%d %H:%M:%S%z&#39;)</span>
        <span class="c1"># # f_change_happened = df_debug[&#39;f_down&#39;] | df_debug[&#39;f_up&#39;]</span>
        <span class="c1"># f_change_happened = df_debug[&#39;High_f_down&#39;] | df_debug[&#39;High_f_up&#39;] | df_debug[&#39;Low_f_down&#39;] | df_debug[&#39;Low_f_up&#39;]</span>
        <span class="c1"># f_change_happened = f_change_happened | np.roll(f_change_happened, 1) | np.roll(f_change_happened, -1) | np.roll(f_change_happened, 2) | np.roll(f_change_happened, -2)</span>
        <span class="c1"># f_change_happened[0] = True ; f_change_happened[-1] = True</span>
        <span class="c1"># df_debug = df_debug[f_change_happened]</span>
        <span class="c1"># # # df_debug = df_debug.loc[df.index.date &lt;= date(2023, 2, 13)][&#39;Close&#39;].to_numpy()</span>
        <span class="c1"># # # df_debug = df_debug.iloc[42*5 : 46*5]</span>
        <span class="c1"># # # df_debug = df.sort_index().loc[&#39;2023-06-29&#39;:&#39;2023-07-04&#39;][OHLC].sort_index(ascending=False)</span>
        <span class="c1"># msg = f&quot;price-repair-split: my workings:&quot; + &#39;\n&#39; + str(df_debug)</span>
        <span class="c1"># self.manager.LogEvent(&#39;debug&#39;, &#39;price-repair-split-&#39;+self.istr, msg)</span>
        <span class="c1"># quit()</span>

        <span class="k">def</span> <span class="nf">map_signals_to_ranges</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">f_up</span><span class="p">,</span> <span class="n">f_down</span><span class="p">):</span>
            <span class="c1"># Ensure 0th element is False, because True is nonsense</span>
            <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="p">;</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">f_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">f_up</span><span class="p">)</span> <span class="p">;</span> <span class="n">f_up</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">f_down</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">f_down</span><span class="p">)</span> <span class="p">;</span> <span class="n">f_down</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="k">return</span> <span class="p">[]</span>

            <span class="n">true_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ranges</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">true_indices</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">split</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
                        <span class="n">adj</span> <span class="o">=</span> <span class="s1">&#39;split&#39;</span> <span class="k">if</span> <span class="n">f_down</span><span class="p">[</span><span class="n">true_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">else</span> <span class="s1">&#39;1.0/split&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">adj</span> <span class="o">=</span> <span class="s1">&#39;1.0/split&#39;</span> <span class="k">if</span> <span class="n">f_down</span><span class="p">[</span><span class="n">true_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">else</span> <span class="s1">&#39;split&#39;</span>
                    <span class="n">ranges</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">true_indices</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">true_indices</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">adj</span><span class="p">))</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">true_indices</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">split</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
                    <span class="n">adj</span> <span class="o">=</span> <span class="s1">&#39;split&#39;</span> <span class="k">if</span> <span class="n">f_down</span><span class="p">[</span><span class="n">true_indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="k">else</span> <span class="s1">&#39;1.0/split&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">adj</span> <span class="o">=</span> <span class="s1">&#39;1.0/split&#39;</span> <span class="k">if</span> <span class="n">f_down</span><span class="p">[</span><span class="n">true_indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="k">else</span> <span class="s1">&#39;split&#39;</span>
                <span class="n">ranges</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">true_indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">adj</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">ranges</span>

        <span class="k">if</span> <span class="n">idx_latest_active</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">idx_rev_latest_active</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">idx_latest_active</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;idx_latest_active=</span><span class="si">{</span><span class="n">idx_latest_active</span><span class="si">}</span><span class="s1">, idx_rev_latest_active=</span><span class="si">{</span><span class="n">idx_rev_latest_active</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">LogEvent</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span> <span class="s1">&#39;price-repair-split-&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">correct_columns_individually</span><span class="p">:</span>
            <span class="n">f_corrected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">correct_volume</span><span class="p">:</span>
                <span class="c1"># If Open or Close is repaired but not both, </span>
                <span class="c1"># then this means the interval has a mix of correct</span>
                <span class="c1"># and errors. A problem for correcting Volume, </span>
                <span class="c1"># so use a heuristic:</span>
                <span class="c1"># - if both Open &amp; Close were Nx bad =&gt; Volume is Nx bad</span>
                <span class="c1"># - if only one of Open &amp; Close are Nx bad =&gt; Volume is 0.5*Nx bad</span>
                <span class="n">f_open_fixed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">f_close_fixed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

            <span class="n">OHLC_correct_ranges</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">OHLC</span><span class="p">)):</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">OHLC</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">idx_first_f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">appears_suspended</span> <span class="ow">and</span> <span class="p">(</span><span class="n">idx_latest_active</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">idx_latest_active</span> <span class="o">&gt;=</span> <span class="n">idx_first_f</span><span class="p">):</span>
                    <span class="c1"># Suspended midway during data date range.</span>
                    <span class="c1"># 1: process data before suspension in index-ascending (date-descending) order.</span>
                    <span class="c1"># 2: process data after suspension in index-descending order. Requires signals to be reversed, </span>
                    <span class="c1">#    then returned ranges to also be reversed, because this logic was originally written for</span>
                    <span class="c1">#    index-ascending (date-descending) order.</span>
                    <span class="n">fj</span> <span class="o">=</span> <span class="n">f</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span>
                    <span class="n">f_upj</span> <span class="o">=</span> <span class="n">f_up</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span>
                    <span class="n">f_downj</span> <span class="o">=</span> <span class="n">f_down</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span>
                    <span class="n">ranges_before</span> <span class="o">=</span> <span class="n">map_signals_to_ranges</span><span class="p">(</span><span class="n">fj</span><span class="p">[</span><span class="n">idx_latest_active</span><span class="p">:],</span> <span class="n">f_upj</span><span class="p">[</span><span class="n">idx_latest_active</span><span class="p">:],</span> <span class="n">f_downj</span><span class="p">[</span><span class="n">idx_latest_active</span><span class="p">:])</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ranges_before</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># Shift each range back to global indexing</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ranges_before</span><span class="p">)):</span>
                            <span class="n">r</span> <span class="o">=</span> <span class="n">ranges_before</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                            <span class="n">ranges_before</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">idx_latest_active</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">idx_latest_active</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">f_rev_downj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">f_upj</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>  <span class="c1"># correct</span>
                    <span class="n">f_rev_upj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">f_downj</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>  <span class="c1"># correct</span>
                    <span class="n">f_revj</span> <span class="o">=</span> <span class="n">f_rev_upj</span> <span class="o">|</span> <span class="n">f_rev_downj</span>
                    <span class="n">ranges_after</span> <span class="o">=</span> <span class="n">map_signals_to_ranges</span><span class="p">(</span><span class="n">f_revj</span><span class="p">[</span><span class="n">idx_rev_latest_active</span><span class="p">:],</span> <span class="n">f_rev_upj</span><span class="p">[</span><span class="n">idx_rev_latest_active</span><span class="p">:],</span> <span class="n">f_rev_downj</span><span class="p">[</span><span class="n">idx_rev_latest_active</span><span class="p">:])</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ranges_after</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># Shift each range back to global indexing:</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ranges_after</span><span class="p">)):</span>
                            <span class="n">r</span> <span class="o">=</span> <span class="n">ranges_after</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                            <span class="n">ranges_after</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">idx_rev_latest_active</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">idx_rev_latest_active</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                        <span class="c1"># Flip range to normal ordering</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ranges_after</span><span class="p">)):</span>
                            <span class="n">r</span> <span class="o">=</span> <span class="n">ranges_after</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                            <span class="n">ranges_after</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">n</span><span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">ranges</span> <span class="o">=</span> <span class="n">ranges_before</span> <span class="p">;</span> <span class="n">ranges</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ranges_after</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ranges</span> <span class="o">=</span> <span class="n">map_signals_to_ranges</span><span class="p">(</span><span class="n">f</span><span class="p">[:,</span> <span class="n">j</span><span class="p">],</span> <span class="n">f_up</span><span class="p">[:,</span> <span class="n">j</span><span class="p">],</span> <span class="n">f_down</span><span class="p">[:,</span> <span class="n">j</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">start_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Prune ranges that are older than start_min</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ranges</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="n">ranges</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">df2</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">start_min</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;price-repair-split: Pruning </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1"> range </span><span class="si">{</span><span class="n">df2</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="si">}</span><span class="s1">-&gt;</span><span class="si">{</span><span class="n">df2</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1"> because too old.&#39;</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">LogEvent</span><span class="p">(</span><span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="s1">&#39;price-repair-split-&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                            <span class="k">del</span> <span class="n">ranges</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ranges</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">OHLC_correct_ranges</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ranges</span>

            <span class="n">count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="mi">1</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">OHLC_correct_ranges</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># If only 1 column then assume false positive</span>
                <span class="n">idxs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">if</span> <span class="n">OHLC_correct_ranges</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">OHLC</span><span class="p">))]</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">OHLC</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;price-repair-split: Potential </span><span class="si">{</span><span class="n">fix_type</span><span class="si">}</span><span class="s1"> detected only in column </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">, so treating as false positive (ignore)&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">LogEvent</span><span class="p">(</span><span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="s1">&#39;price-repair-split-&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Only correct if at least 2 columns require correction.</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">OHLC</span><span class="p">)):</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">OHLC</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">ranges</span> <span class="o">=</span> <span class="n">OHLC_correct_ranges</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">ranges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">ranges</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ranges</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;split&#39;</span><span class="p">:</span>
                            <span class="n">m</span> <span class="o">=</span> <span class="n">split</span> <span class="p">;</span> <span class="n">m_rcp</span> <span class="o">=</span> <span class="n">split_rcp</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">m</span> <span class="o">=</span> <span class="n">split_rcp</span> <span class="p">;</span> <span class="n">m_rcp</span> <span class="o">=</span> <span class="n">split</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Corrected bad split adjustment on col=</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2"> range=[</span><span class="si">{</span><span class="n">df2</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">df2</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2">] m=</span><span class="si">{</span><span class="n">m</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Corrected bad split adjustment on col=</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2"> range=[</span><span class="si">{</span><span class="n">df2</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">df2</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">] m=</span><span class="si">{</span><span class="n">m</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">LogEvent</span><span class="p">(</span><span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="s1">&#39;price-repair-split-&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                        <span class="n">df2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">df2</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">*=</span> <span class="n">m</span>
                        <span class="k">if</span> <span class="n">correct_volume</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;Open&#39;</span><span class="p">:</span>
                                <span class="n">f_open_fixed</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;Close&#39;</span><span class="p">:</span>
                                <span class="n">f_close_fixed</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">f_corrected</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">correct_volume</span><span class="p">:</span>
                <span class="n">f_open_and_closed_fixed</span> <span class="o">=</span> <span class="n">f_open_fixed</span> <span class="o">&amp;</span> <span class="n">f_close_fixed</span>
                <span class="n">f_open_xor_closed_fixed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_xor</span><span class="p">(</span><span class="n">f_open_fixed</span><span class="p">,</span> <span class="n">f_close_fixed</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">f_open_and_closed_fixed</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="n">df2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f_open_and_closed_fixed</span><span class="p">,</span> <span class="s2">&quot;Volume&quot;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">m_rcp</span>
                <span class="k">if</span> <span class="n">f_open_xor_closed_fixed</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="n">df2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f_open_xor_closed_fixed</span><span class="p">,</span> <span class="s2">&quot;Volume&quot;</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">m_rcp</span>

            <span class="n">df2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f_corrected</span><span class="p">,</span> <span class="s1">&#39;Repaired?&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">idx_first_f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">appears_suspended</span> <span class="ow">and</span> <span class="p">(</span><span class="n">idx_latest_active</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">idx_latest_active</span> <span class="o">&gt;=</span> <span class="n">idx_first_f</span><span class="p">):</span>
                <span class="c1"># Suspended midway during data date range.</span>
                <span class="c1"># 1: process data before suspension in index-ascending (date-descending) order.</span>
                <span class="c1"># 2: process data after suspension in index-descending order. Requires signals to be reversed, </span>
                <span class="c1">#    then returned ranges to also be reversed, because this logic was originally written for</span>
                <span class="c1">#    index-ascending (date-descending) order.</span>
                <span class="n">ranges_before</span> <span class="o">=</span> <span class="n">map_signals_to_ranges</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">idx_latest_active</span><span class="p">:],</span> <span class="n">f_up</span><span class="p">[</span><span class="n">idx_latest_active</span><span class="p">:],</span> <span class="n">f_down</span><span class="p">[</span><span class="n">idx_latest_active</span><span class="p">:])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ranges_before</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Shift each range back to global indexing</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ranges_before</span><span class="p">)):</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="n">ranges_before</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">ranges_before</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">idx_latest_active</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">idx_latest_active</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">f_rev_down</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">f_up</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">f_rev_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">f_down</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">f_rev</span> <span class="o">=</span> <span class="n">f_rev_up</span> <span class="o">|</span> <span class="n">f_rev_down</span>
                <span class="n">ranges_after</span> <span class="o">=</span> <span class="n">map_signals_to_ranges</span><span class="p">(</span><span class="n">f_rev</span><span class="p">[</span><span class="n">idx_rev_latest_active</span><span class="p">:],</span> <span class="n">f_rev_up</span><span class="p">[</span><span class="n">idx_rev_latest_active</span><span class="p">:],</span> <span class="n">f_rev_down</span><span class="p">[</span><span class="n">idx_rev_latest_active</span><span class="p">:])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ranges_after</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Shift each range back to global indexing:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ranges_after</span><span class="p">)):</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="n">ranges_after</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">ranges_after</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">idx_rev_latest_active</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">idx_rev_latest_active</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="c1"># Flip range to normal ordering</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ranges_after</span><span class="p">)):</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="n">ranges_after</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">ranges_after</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">n</span><span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">ranges</span> <span class="o">=</span> <span class="n">ranges_before</span> <span class="p">;</span> <span class="n">ranges</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ranges_after</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ranges</span> <span class="o">=</span> <span class="n">map_signals_to_ranges</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">f_up</span><span class="p">,</span> <span class="n">f_down</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">start_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Prune ranges that are older than start_min</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ranges</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">ranges</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">df2</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">start_min</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;price-repair-split: Pruning range </span><span class="si">{</span><span class="n">df2</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="si">}</span><span class="s1">-&gt;</span><span class="si">{</span><span class="n">df2</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1"> because too old.&#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">LogEvent</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span> <span class="s1">&#39;price-repair-split-&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                        <span class="k">del</span> <span class="n">ranges</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ranges</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;split&#39;</span><span class="p">:</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">split</span> <span class="p">;</span> <span class="n">m_rcp</span> <span class="o">=</span> <span class="n">split_rcp</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">split_rcp</span> <span class="p">;</span> <span class="n">m_rcp</span> <span class="o">=</span> <span class="n">split</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;price-repair-split: range=</span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2"> m=</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">LogEvent</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span> <span class="s1">&#39;price-repair-split-&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">,</span> <span class="s1">&#39;High&#39;</span><span class="p">,</span> <span class="s1">&#39;Low&#39;</span><span class="p">,</span> <span class="s1">&#39;Close&#39;</span><span class="p">]:</span>
                    <span class="n">df2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">df2</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">*=</span> <span class="n">m</span>
                <span class="k">if</span> <span class="n">correct_volume</span><span class="p">:</span>
                    <span class="n">df2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">df2</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s2">&quot;Volume&quot;</span><span class="p">)]</span> <span class="o">*=</span> <span class="n">m_rcp</span>
                <span class="n">df2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">df2</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;Repaired?&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Corrected bad split adjustment on interval </span><span class="si">{</span><span class="n">df2</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2"> m=</span><span class="si">{</span><span class="n">m</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Corrected bad split adjustment on interval </span><span class="si">{</span><span class="n">df2</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="si">}</span><span class="s2"> m=</span><span class="si">{</span><span class="n">m</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Note: df2 sorted with index descending</span>
                    <span class="n">start</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="n">end</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Corrected bad split adjustment across intervals </span><span class="si">{</span><span class="n">start</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">end</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2"> (inclusive) m=</span><span class="si">{</span><span class="n">m</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Corrected bad split adjustment across intervals </span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">end</span><span class="si">}</span><span class="s2"> (inclusive) m=</span><span class="si">{</span><span class="n">m</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">LogEvent</span><span class="p">(</span><span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="s1">&#39;price-repair-split-&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">correct_volume</span><span class="p">:</span>
            <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>

        <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceExit</span><span class="p">(</span><span class="n">log_func</span> <span class="o">+</span> <span class="s2">&quot; returning&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df2</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_repairZeroPrices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckDataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;df&quot;</span><span class="p">)</span>

        <span class="c1"># Sometimes Yahoo returns prices=0 when obviously wrong e.g. Volume &gt; 0 and Close &gt; 0.</span>
        <span class="c1"># Easy to detect and fix</span>

        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Need multiple rows to confidently identify outliers</span>
            <span class="k">return</span> <span class="n">df</span>

        <span class="n">log_msg_enter</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;PM::_repairZeroPrices-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="si">}</span><span class="s2">(date_range=</span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">-&gt;</span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">itd</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="n">log_msg_exit</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;PM::_repairZeroPrices-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="si">}</span><span class="s2">() returning&quot;</span>
        <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceEnter</span><span class="p">(</span><span class="n">log_msg_enter</span><span class="p">)</span>

        <span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">price_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Open&quot;</span><span class="p">,</span> <span class="s2">&quot;High&quot;</span><span class="p">,</span> <span class="s2">&quot;Low&quot;</span><span class="p">,</span> <span class="s2">&quot;Close&quot;</span><span class="p">,</span> <span class="s2">&quot;Adj Close&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df2</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">f_zero_or_nan</span> <span class="o">=</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="n">price_cols</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">|</span> <span class="n">df2</span><span class="p">[</span><span class="n">price_cols</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="c1"># Check whether worth attempting repair</span>
        <span class="k">if</span> <span class="n">f_zero_or_nan</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceExit</span><span class="p">(</span><span class="n">log_msg_exit</span> <span class="o">+</span> <span class="s2">&quot; (no bad data)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span>
        <span class="k">if</span> <span class="n">f_zero_or_nan</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">price_cols</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">df2</span><span class="p">):</span>
            <span class="c1"># Need some good data to calibrate</span>
            <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceExit</span><span class="p">(</span><span class="n">log_msg_exit</span> <span class="o">+</span> <span class="s2">&quot; (insufficient calibration data)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span>
        <span class="c1"># - avoid repair if many zeroes/NaNs</span>
        <span class="n">pct_zero_or_nan</span> <span class="o">=</span> <span class="n">f_zero_or_nan</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">price_cols</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">df2</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">f_zero_or_nan</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">pct_zero_or_nan</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">:</span>
            <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceExit</span><span class="p">(</span><span class="n">log_msg_exit</span> <span class="o">+</span> <span class="s2">&quot; (too much bad data)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span>

        <span class="n">data_cols</span> <span class="o">=</span> <span class="n">price_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;Volume&quot;</span><span class="p">]</span>

        <span class="c1"># Mark values to send for repair</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">price_cols</span><span class="p">)):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">price_cols</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">df2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f_zero_or_nan</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">tag</span>
        <span class="c1"># If volume=0 or NaN for bad prices, then tag volume for repair</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;=X&quot;</span><span class="p">):</span>
            <span class="c1"># FX, volume always 0</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f_zero_or_nan</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s2">&quot;Volume&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;Volume&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tag</span>
            <span class="n">df2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f_zero_or_nan</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="s2">&quot;Volume&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()),</span> <span class="s2">&quot;Volume&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tag</span>

        <span class="c1"># print(df2[f_zero_or_nan.any(axis=1)])</span>
        <span class="n">n_before</span> <span class="o">=</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="n">data_cols</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">==</span> <span class="n">tag</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="c1"># print(&quot;n_before =&quot;, n_before)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">df2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reconstruct_intervals_batch</span><span class="p">(</span><span class="n">df2</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stack_trace</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_stack_trace</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stack_trace</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="n">n_after</span> <span class="o">=</span> <span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="n">data_cols</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">==</span> <span class="n">tag</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">n_fixed</span> <span class="o">=</span> <span class="n">n_before</span> <span class="o">-</span> <span class="n">n_after</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Fixed </span><span class="si">{</span><span class="n">n_fixed</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">n_before</span><span class="si">}</span><span class="s2"> price=0.0 errors in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="si">}</span><span class="s2"> price data&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span> <span class="ow">and</span> <span class="n">n_fixed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="si">}</span><span class="s2">: &quot;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">LogEvent</span><span class="p">(</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="s2">&quot;PriceManager&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Restore original values where repair failed (i.e. remove tag values)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="n">data_cols</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">==</span> <span class="n">tag</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_cols</span><span class="p">)):</span>
            <span class="n">fj</span> <span class="o">=</span> <span class="n">f</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">fj</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">data_cols</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">df2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">fj</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">fj</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span>

        <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceExit</span><span class="p">(</span><span class="n">log_msg_exit</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df2</span>

    <span class="k">def</span> <span class="nf">_reverseYahooAdjust</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="n">yfcu</span><span class="o">.</span><span class="n">TypeCheckDataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;df&quot;</span><span class="p">)</span>

        <span class="c1"># Yahoo returns data split-adjusted so reverse that.</span>
        <span class="c1">#</span>
        <span class="c1"># Except for hourly/minute data, Yahoo isn&#39;t consistent with adjustment:</span>
        <span class="c1"># - prices only split-adjusted if date range contains a split</span>
        <span class="c1"># - dividend appears split-adjusted</span>
        <span class="c1"># Easy to fix using daily data:</span>
        <span class="c1"># - divide prices by daily to determine if split-adjusted</span>
        <span class="c1"># - copy dividends from daily</span>

        <span class="c1"># Finally, add &#39;CSF&#39; &amp; &#39;CDF&#39; columns to allow cheap on-demand adjustment</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;&#39;df&#39; must be pd.DataFrame not </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">df</span><span class="p">)))</span>

        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># debug = True</span>

        <span class="n">log_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;PM::_reverseYahooAdjust-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">-&gt;</span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">():</span>
            <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceEnter</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s2">&quot;Open&quot;</span><span class="p">,</span> <span class="s2">&quot;Low&quot;</span><span class="p">,</span> <span class="s2">&quot;High&quot;</span><span class="p">,</span> <span class="s2">&quot;Close&quot;</span><span class="p">,</span> <span class="s2">&quot;Volume&quot;</span><span class="p">]])</span>

        <span class="n">cdf</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">csf</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">!=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span><span class="p">:</span>
            <span class="c1"># Trigger update of daily price data, to get all events</span>
            <span class="n">histDaily</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">GetHistory</span><span class="p">(</span><span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span><span class="p">)</span>
            <span class="n">df_daily_raw</span> <span class="o">=</span> <span class="n">histDaily</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">(),</span> <span class="n">repair</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Step 1: ensure intraday price data is always split-adjusted</span>
        <span class="n">td_7d</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span><span class="p">:</span>
            <span class="c1"># Get daily price data during and after &#39;df&#39;</span>

            <span class="n">df_daily</span> <span class="o">=</span> <span class="n">df_daily_raw</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Open&quot;</span><span class="p">,</span> <span class="s2">&quot;Close&quot;</span><span class="p">,</span> <span class="s2">&quot;Low&quot;</span><span class="p">,</span> <span class="s2">&quot;High&quot;</span><span class="p">]:</span>
                <span class="n">df_daily</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*=</span> <span class="n">df_daily</span><span class="p">[</span><span class="s2">&quot;CSF&quot;</span><span class="p">]</span>
            <span class="n">df_daily</span><span class="p">[</span><span class="s2">&quot;Volume&quot;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">df_daily</span><span class="p">[</span><span class="s2">&quot;CSF&quot;</span><span class="p">]</span>
            <span class="n">df_daily</span> <span class="o">=</span> <span class="n">df_daily</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;CSF&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">df_daily</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">df_daily</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="c1"># df = df.drop(&quot;Adj Close&quot;, axis=1)</span>
                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;CSF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;CDF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="k">return</span> <span class="n">df</span>

            <span class="n">f_post</span> <span class="o">=</span> <span class="n">df_daily</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
            <span class="n">df_daily_during</span> <span class="o">=</span> <span class="n">df_daily</span><span class="p">[</span><span class="o">~</span><span class="n">f_post</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">df_daily_post</span> <span class="o">=</span> <span class="n">df_daily</span><span class="p">[</span><span class="n">f_post</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">df_daily_during</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df_daily_during</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span> <span class="p">;</span> <span class="n">df_daily_during</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;_date&quot;</span>

            <span class="c1"># Also get raw daily data from cache</span>
            <span class="n">df_daily_raw</span> <span class="o">=</span> <span class="n">df_daily_raw</span><span class="p">[</span><span class="n">df_daily_raw</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()]</span>
            <span class="c1">#</span>
            <span class="n">f_post</span> <span class="o">=</span> <span class="n">df_daily_raw</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
            <span class="n">df_daily_raw_during</span> <span class="o">=</span> <span class="n">df_daily_raw</span><span class="p">[</span><span class="o">~</span><span class="n">f_post</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">df_daily_raw_during_d</span> <span class="o">=</span> <span class="n">df_daily_raw_during</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">df_daily_raw_during_d</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df_daily_raw_during_d</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span> <span class="p">;</span> <span class="n">df_daily_raw_during_d</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;_date&quot;</span>

            <span class="k">if</span> <span class="n">df_daily_post</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">csf_post</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">csf_post</span> <span class="o">=</span> <span class="n">yfcu</span><span class="o">.</span><span class="n">GetCSF0</span><span class="p">(</span><span class="n">df_daily_post</span><span class="p">)</span>
            <span class="n">expectedRatio</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">csf_post</span>

            <span class="n">ss_ratio</span> <span class="o">=</span> <span class="n">expectedRatio</span>
            <span class="n">ss_ratioRcp</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">ss_ratio</span>
            <span class="c1">#</span>
            <span class="n">price_data_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Open&quot;</span><span class="p">,</span> <span class="s2">&quot;Close&quot;</span><span class="p">,</span> <span class="s2">&quot;Adj Close&quot;</span><span class="p">,</span> <span class="s2">&quot;Low&quot;</span><span class="p">,</span> <span class="s2">&quot;High&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ss_ratio</span> <span class="o">&gt;</span> <span class="mf">1.01</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">price_data_cols</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*=</span> <span class="n">ss_ratioRcp</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Applying 1:</span><span class="si">{}</span><span class="s2"> stock-split&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">ss_ratio</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
            <span class="k">elif</span> <span class="n">ss_ratioRcp</span> <span class="o">&gt;</span> <span class="mf">1.01</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">price_data_cols</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*=</span> <span class="n">ss_ratio</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Applying {.2f}:1 reverse-split-split&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ss_ratioRcp</span><span class="p">))</span>
            <span class="c1"># Note: volume always returned unadjusted</span>

            <span class="c1"># Yahoo messes up dividend adjustment too so copy correct dividend from daily,</span>
            <span class="c1"># but only to first time periods of each day:</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;_indexBackup&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
            <span class="c1"># Copy over CSF and CDF too from daily</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">df_daily_raw_during_d</span><span class="p">[[</span><span class="s2">&quot;CDF&quot;</span><span class="p">,</span> <span class="s2">&quot;CSF&quot;</span><span class="p">]],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;_date&quot;</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;many_to_one&quot;</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;_indexBackup&quot;</span><span class="p">]</span> <span class="p">;</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span> <span class="p">;</span> <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;_indexBackup&quot;</span><span class="p">,</span> <span class="s2">&quot;_date&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">cdf</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;CDF&quot;</span><span class="p">]</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Adj Close&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">cdf</span>
            <span class="n">csf</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;CSF&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">df_daily_post</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">post_csf</span> <span class="o">=</span> <span class="n">yfcu</span><span class="o">.</span><span class="n">GetCSF0</span><span class="p">(</span><span class="n">df_daily_post</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">==</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Week</span><span class="p">:</span>
            <span class="n">df_daily</span> <span class="o">=</span> <span class="n">histDaily</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">+</span><span class="n">td_7d</span><span class="p">,</span> <span class="n">repair</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">df_daily</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">df_daily</span><span class="o">.</span><span class="n">empty</span><span class="p">):</span>
                <span class="n">post_csf</span> <span class="o">=</span> <span class="n">yfcu</span><span class="o">.</span><span class="n">GetCSF0</span><span class="p">(</span><span class="n">df_daily</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- post_csf of daily date range </span><span class="si">{}</span><span class="s2">-&gt;</span><span class="si">{}</span><span class="s2"> = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df_daily</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">df_daily</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">post_csf</span><span class="p">))</span>

        <span class="c1"># elif self.interval in [yfcd.Interval.Months1, yfcd.Interval.Months3]:</span>
        <span class="c1">#     raise Exception(&quot;not implemented&quot;)</span>

        <span class="c1"># If &#39;df&#39; does not contain all stock splits until present, then</span>
        <span class="c1"># set &#39;post_csf&#39; to cumulative stock split factor just after last &#39;df&#39; date</span>
        <span class="n">splits_post</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">GetHistory</span><span class="p">(</span><span class="s2">&quot;Events&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">GetSplits</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">+</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">splits_post</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">post_csf</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">splits_post</span><span class="p">[</span><span class="s2">&quot;Stock Splits&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">post_csf</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Cumulative dividend factor</span>
        <span class="k">if</span> <span class="n">cdf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f_nna</span> <span class="o">=</span> <span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">f_nna</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">cdf</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="n">cdf</span><span class="p">[</span><span class="n">f_nna</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f_nna</span><span class="p">,</span> <span class="s2">&quot;Adj Close&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f_nna</span><span class="p">,</span> <span class="s2">&quot;Close&quot;</span><span class="p">]</span>
                <span class="n">cdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">cdf</span><span class="p">)</span><span class="o">.</span><span class="n">bfill</span><span class="p">()</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="c1"># In rare cases, Yahoo is not calculating &#39;Adj Close&#39; correctly</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span><span class="p">:</span>
            <span class="n">divs_since</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">GetHistory</span><span class="p">(</span><span class="s2">&quot;Events&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">GetDivs</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">itd</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">divs_since</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">divs_since</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="c1"># Check that &#39;Adj Close&#39; reflects all future dividends</span>
                <span class="n">expected_adj</span> <span class="o">=</span> <span class="n">divs_since</span><span class="p">[</span><span class="s1">&#39;Back Adj.&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">!=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Dividends&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="n">dt</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="c1"># Note: df hasn&#39;t been de-splitted yet</span>
                        <span class="n">hist_before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">GetHistory</span><span class="p">(</span><span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">-</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">(),</span> <span class="n">adjust_splits</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">adjust_divs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">close</span> <span class="o">=</span> <span class="n">hist_before</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">adj_adj</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Dividends&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">close</span>
                        <span class="k">if</span> <span class="n">adj_adj</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Adjusting expected_adj=</span><span class="si">{</span><span class="n">expected_adj</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> by last-row div=</span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Dividends&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> adj=</span><span class="si">{</span><span class="n">adj_adj</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> @ </span><span class="si">{</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">LogEvent</span><span class="p">(</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="s1">&#39;_reverseYahooAdjust&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                            <span class="n">expected_adj</span> <span class="o">*=</span> <span class="n">adj_adj</span>
                <span class="n">actual_adj</span> <span class="o">=</span> <span class="n">cdf</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">actual_adj</span><span class="p">):</span>
                    <span class="n">diff_pct</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">actual_adj</span> <span class="o">/</span> <span class="n">expected_adj</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">diff_pct</span> <span class="o">&gt;</span> <span class="mf">0.005</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;expected_adj=</span><span class="si">{</span><span class="n">expected_adj</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1"> != actual_adj=</span><span class="si">{</span><span class="n">actual_adj</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">, correcting (last dt = </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s1">)&#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">LogEvent</span><span class="p">(</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="s1">&#39;_reverseYahooAdjust&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                        <span class="n">divs_since</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">divs_since</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">date</span>
                        <span class="c1"># Bad. Dividends have occurred after this price data, but &#39;Adj Close&#39; is missing adjustment(s).</span>
                        <span class="c1"># Fix</span>
                        <span class="n">cdf</span> <span class="o">*=</span> <span class="n">expected_adj</span> <span class="o">/</span> <span class="n">actual_adj</span>

        <span class="c1"># Cumulative stock-split factor</span>
        <span class="k">if</span> <span class="n">csf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ss</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Stock Splits&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">ss</span><span class="p">[(</span><span class="n">ss</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">|</span> <span class="n">ss</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">ss_rcp</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">ss</span>
            <span class="n">csf</span> <span class="o">=</span> <span class="n">ss_rcp</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">post_csf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">csf</span> <span class="o">*=</span> <span class="n">post_csf</span>
        <span class="n">csf_rcp</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">csf</span>

        <span class="c1"># Reverse Yahoo&#39;s split adjustment:</span>
        <span class="n">data_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Open&quot;</span><span class="p">,</span> <span class="s2">&quot;High&quot;</span><span class="p">,</span> <span class="s2">&quot;Low&quot;</span><span class="p">,</span> <span class="s2">&quot;Close&quot;</span><span class="p">,</span> <span class="s2">&quot;Dividends&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">dc</span> <span class="ow">in</span> <span class="n">data_cols</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">dc</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">dc</span><span class="p">]</span> <span class="o">*</span> <span class="n">csf_rcp</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span><span class="p">:</span>
            <span class="c1"># Don&#39;t need to de-split volume data because Yahoo always returns interday volume unadjusted</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Volume&quot;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">csf</span>

        <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Volume&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="s1">&#39;int64&#39;</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Volume&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Volume&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>

        <span class="c1"># Drop &#39;Adj Close&#39;, replace with scaling factors:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;Adj Close&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;CSF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">csf</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;CDF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cdf</span>

        <span class="n">h_lastDivAdjustDt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="n">ZoneInfo</span><span class="p">(</span><span class="s2">&quot;UTC&quot;</span><span class="p">))</span>
        <span class="n">h_lastSplitAdjustDt</span> <span class="o">=</span> <span class="n">h_lastDivAdjustDt</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;LastDivAdjustDt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_lastDivAdjustDt</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;LastSplitAdjustDt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_lastSplitAdjustDt</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- unadjusted:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s2">&quot;Close&quot;</span><span class="p">,</span> <span class="s2">&quot;Dividends&quot;</span><span class="p">,</span> <span class="s2">&quot;Volume&quot;</span><span class="p">,</span> <span class="s2">&quot;CSF&quot;</span><span class="p">,</span> <span class="s2">&quot;CDF&quot;</span><span class="p">]])</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Dividends&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- dividends:&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;Open&quot;</span><span class="p">,</span> <span class="s2">&quot;Low&quot;</span><span class="p">,</span> <span class="s2">&quot;High&quot;</span><span class="p">,</span> <span class="s2">&quot;Close&quot;</span><span class="p">,</span> <span class="s2">&quot;Dividends&quot;</span><span class="p">,</span> <span class="s2">&quot;Volume&quot;</span><span class="p">,</span> <span class="s2">&quot;CSF&quot;</span><span class="p">,</span> <span class="s2">&quot;CDF&quot;</span><span class="p">]])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">log_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;PM::_reverseYahooAdjust-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="si">}</span><span class="s2">() returning&quot;</span>
        <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">():</span>
            <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceExit</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s2">&quot;Open&quot;</span><span class="p">,</span> <span class="s2">&quot;Low&quot;</span><span class="p">,</span> <span class="s2">&quot;High&quot;</span><span class="p">,</span> <span class="s2">&quot;Close&quot;</span><span class="p">,</span> <span class="s2">&quot;Dividends&quot;</span><span class="p">,</span> <span class="s2">&quot;Volume&quot;</span><span class="p">,</span> <span class="s2">&quot;CSF&quot;</span><span class="p">]])</span>

        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">_applyNewEvents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># debug = False</span>
        <span class="c1"># debug = True</span>

        <span class="n">h_modified</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">log_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;PM::_applyNewEvents()-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">():</span>
            <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceEnter</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span>

        <span class="c1"># Backport new splits across entire h table</span>
        <span class="n">lastSplitAdjustDt_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;LastSplitAdjustDt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">splits_since</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">GetHistory</span><span class="p">(</span><span class="s2">&quot;Events&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">GetSplitsFetchedSince</span><span class="p">(</span><span class="n">lastSplitAdjustDt_min</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">splits_since</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">splits_since</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">LastSplitAdjustDt_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;LastSplitAdjustDt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="n">f_sup</span> <span class="o">=</span> <span class="n">splits_since</span><span class="p">[</span><span class="s2">&quot;Superseded split&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span>
            <span class="k">if</span> <span class="n">f_sup</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">splits_since</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">f_sup</span><span class="p">]:</span>
                    <span class="n">split</span> <span class="o">=</span> <span class="n">splits_since</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span>
                    <span class="n">f1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">dt</span>
                    <span class="n">diff1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;LastSplitAdjustDt&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">split</span><span class="p">[</span><span class="s2">&quot;Superseded split FetchDate&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
                    <span class="n">f2</span> <span class="o">=</span> <span class="p">(</span><span class="n">diff1</span> <span class="o">&lt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s2">&quot;15s&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                    <span class="n">diff2</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;FetchDate&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">split</span><span class="p">[</span><span class="s2">&quot;Superseded split FetchDate&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
                    <span class="n">f3</span> <span class="o">=</span> <span class="p">(</span><span class="n">diff2</span> <span class="o">&lt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s2">&quot;15s&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">f1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">f2</span> <span class="o">|</span> <span class="n">f3</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">!=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span><span class="p">:</span>
                            <span class="c1"># Probably ok, assuming superseded split was never applied to this price data</span>
                            <span class="k">continue</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">split</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;For superseded split above, failed to identify rows to undo. Problem?&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Next check: expect cached CSF != 1.0</span>

                        <span class="n">log_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="si">}</span><span class="s2">: Reversing split [dt=</span><span class="si">{</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">split</span><span class="p">[</span><span class="s1">&#39;Superseded split&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> fetch=</span><span class="si">{</span><span class="n">split</span><span class="p">[</span><span class="s1">&#39;Superseded split FetchDate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S%z&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">]&quot;</span>
                        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">log_msg</span> <span class="o">+=</span> <span class="s2">&quot; from intervals &quot;</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span><span class="p">:</span>
                            <span class="n">log_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2"> (inc)&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">log_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">h_lastRow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]]</span>
                        <span class="n">log_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;. Last CSF = </span><span class="si">{</span><span class="n">h_lastRow</span><span class="p">[</span><span class="s1">&#39;CSF&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> @ </span><span class="si">{</span><span class="n">h_lastRow</span><span class="p">[</span><span class="s1">&#39;LastSplitAdjustDt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S%z&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">LogEvent</span><span class="p">(</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="s2">&quot;PriceManager&quot;</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">)</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;CSF&quot;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">split</span><span class="p">[</span><span class="s2">&quot;Stock Splits&quot;</span><span class="p">]</span>
                        <span class="n">LastSplitAdjustDt_new</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="s1">&#39;FetchDate&#39;</span><span class="p">],</span> <span class="n">LastSplitAdjustDt_new</span><span class="p">[</span><span class="n">f</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">splits_since</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="n">split</span> <span class="o">=</span> <span class="n">splits_since</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span>
                <span class="n">f1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">dt</span>
                <span class="n">f2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;LastSplitAdjustDt&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">split</span><span class="p">[</span><span class="s2">&quot;FetchDate&quot;</span><span class="p">]</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">f1</span> <span class="o">&amp;</span> <span class="n">f2</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="n">log_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="si">}</span><span class="s2">: Applying split [dt=</span><span class="si">{</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">split</span><span class="p">[</span><span class="s1">&#39;Stock Splits&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> fetch=</span><span class="si">{</span><span class="n">split</span><span class="p">[</span><span class="s1">&#39;FetchDate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S%z&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">]&quot;</span>
                    <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">log_msg</span> <span class="o">+=</span> <span class="s2">&quot; across intervals &quot;</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span><span class="p">:</span>
                        <span class="n">log_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2"> (inc)&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">log_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">h_lastRow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]]</span>
                    <span class="n">log_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;. Last CSF = </span><span class="si">{</span><span class="n">h_lastRow</span><span class="p">[</span><span class="s1">&#39;CSF&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> @ </span><span class="si">{</span><span class="n">h_lastRow</span><span class="p">[</span><span class="s1">&#39;LastSplitAdjustDt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S%z&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">LogEvent</span><span class="p">(</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="s2">&quot;PriceManager&quot;</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">)</span>

                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;CSF&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;CSF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;CSF&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;CSF&quot;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">split</span><span class="p">[</span><span class="s2">&quot;Stock Splits&quot;</span><span class="p">]</span>
                    <span class="n">LastSplitAdjustDt_new</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">LastSplitAdjustDt_new</span><span class="p">[</span><span class="n">f</span><span class="p">],</span> <span class="n">split</span><span class="p">[</span><span class="s2">&quot;FetchDate&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;LastSplitAdjustDt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LastSplitAdjustDt_new</span>

            <span class="n">h_modified</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Backport new divs across entire h table</span>
        <span class="n">lastDivAdjustDt_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;LastDivAdjustDt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lastDivAdjustDt_min</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">,</span> <span class="n">pytz</span><span class="o">.</span><span class="n">BaseTzInfo</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;LastDivAdjustDt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;LastDivAdjustDt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tz</span><span class="p">)</span>
            <span class="n">h_modified</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">lastDivAdjustDt_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;LastDivAdjustDt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">divs_since</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">GetHistory</span><span class="p">(</span><span class="s2">&quot;Events&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">GetDivsFetchedSince</span><span class="p">(</span><span class="n">lastDivAdjustDt_min</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">divs_since</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">divs_since</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">LastDivAdjustDt_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;LastDivAdjustDt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="n">f_sup</span> <span class="o">=</span> <span class="n">divs_since</span><span class="p">[</span><span class="s2">&quot;Superseded back adj.&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span>
            <span class="k">if</span> <span class="n">f_sup</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">divs_since</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">f_sup</span><span class="p">]:</span>
                    <span class="n">div</span> <span class="o">=</span> <span class="n">divs_since</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span>
                    <span class="n">f1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">dt</span>
                    <span class="c1"># Update: new strategy</span>
                    <span class="c1"># Instead of last adjust being the superseded dividend,</span>
                    <span class="c1"># set condition as last adjust being before this new dividend</span>
                    <span class="n">f2</span> <span class="o">=</span> <span class="p">((</span><span class="n">div</span><span class="p">[</span><span class="s2">&quot;FetchDate&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;LastDivAdjustDt&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s1">&#39;1m&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                    <span class="n">f3</span> <span class="o">=</span> <span class="p">((</span><span class="n">div</span><span class="p">[</span><span class="s2">&quot;FetchDate&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;FetchDate&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s1">&#39;1m&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">f1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">f2</span> <span class="o">&amp;</span> <span class="n">f3</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">!=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span><span class="p">:</span>
                            <span class="c1"># Probably ok, assuming superseded div was never applied to this price data</span>
                            <span class="k">continue</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;FetchDate&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">div</span><span class="p">[</span><span class="s2">&quot;FetchDate&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
                            <span class="n">f_recent</span> <span class="o">=</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&lt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s2">&quot;15s&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">f_recent</span><span class="p">[</span><span class="n">f1</span><span class="p">]</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                                <span class="c1"># All price data that could be affected by new dividend, was just</span>
                                <span class="c1"># fetched with that dividend. So can safely ignore.</span>
                                <span class="k">continue</span>
                        <span class="c1"># print(div)</span>
                        <span class="c1"># raise Exception(f&quot;{self.ticker}: {self.istr}: For superseded div above, failed to identify rows to undo. Problem?&quot;)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Next check: expect cached CDF &lt; 1.0:</span>
                        <span class="n">f1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;CDF&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">1.0</span>
                        <span class="k">if</span> <span class="n">f1</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                            <span class="c1"># This can happen with recent multiday intervals and that&#39;s ok, and will correct manually.</span>
                            <span class="n">f1_oldest_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">f1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">f1_oldest_dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">f1_oldest_idx</span><span class="p">]</span>
                            <span class="n">is_f1_oldest_dt_recent</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="n">f1_oldest_dt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mf">1.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">itd</span><span class="p">)</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">!=</span> <span class="n">yfcd</span><span class="o">.</span><span class="n">Interval</span><span class="o">.</span><span class="n">Days1</span> <span class="ow">and</span> <span class="n">is_f1_oldest_dt_recent</span><span class="p">:</span>
                                <span class="c1"># Yup, that&#39;s what happened</span>
                                <span class="n">f</span><span class="p">[</span><span class="n">f1_oldest_idx</span><span class="p">:]</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">f1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;CDF&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">1.0</span>
                        <span class="c1"># if f1.any():</span>
                        <span class="c1">#     print(self.h[f1|np.roll(f1,-1)][[&#39;Close&#39;, &#39;CDF&#39;, &#39;CSF&#39;, &#39;FetchDate&#39;]])</span>
                        <span class="c1">#     print(div)</span>
                        <span class="c1">#     raise Exception(f&quot;{self.ticker}: {self.istr}: For superseded div above, attempting to undo div-adjust from rows where CDF=1. Investigate.&quot;)</span>

                        <span class="n">log_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="si">}</span><span class="s2">: Reversing div [dt=</span><span class="si">{</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">div</span><span class="p">[</span><span class="s1">&#39;Superseded div&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> adj=</span><span class="si">{</span><span class="n">div</span><span class="p">[</span><span class="s1">&#39;Superseded back adj.&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> fetch=</span><span class="si">{</span><span class="n">div</span><span class="p">[</span><span class="s1">&#39;Superseded div FetchDate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S%z&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">]&quot;</span>
                        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">log_msg</span> <span class="o">+=</span> <span class="s2">&quot; from intervals &quot;</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span><span class="p">:</span>
                            <span class="n">log_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2"> (inc)&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">log_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">h_lastRow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]]</span>
                        <span class="n">log_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;. Last CDF = </span><span class="si">{</span><span class="n">h_lastRow</span><span class="p">[</span><span class="s1">&#39;CDF&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> @ </span><span class="si">{</span><span class="n">h_lastRow</span><span class="p">[</span><span class="s1">&#39;LastDivAdjustDt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S%z&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">LogEvent</span><span class="p">(</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="s2">&quot;PriceManager&quot;</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">)</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;CDF&quot;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">div</span><span class="p">[</span><span class="s2">&quot;Superseded back adj.&quot;</span><span class="p">]</span>
                        <span class="n">LastDivAdjustDt_new</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">div</span><span class="p">[</span><span class="s1">&#39;FetchDate&#39;</span><span class="p">],</span> <span class="n">LastDivAdjustDt_new</span><span class="p">[</span><span class="n">f</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">divs_since</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="n">div</span> <span class="o">=</span> <span class="n">divs_since</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span>
                <span class="n">f1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">dt</span>
                <span class="n">f2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;LastDivAdjustDt&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">div</span><span class="p">[</span><span class="s2">&quot;FetchDate&quot;</span><span class="p">]</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">f1</span> <span class="o">&amp;</span> <span class="n">f2</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="n">log_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">istr</span><span class="si">}</span><span class="s2">: Applying div [dt=</span><span class="si">{</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">div</span><span class="p">[</span><span class="s1">&#39;Dividends&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> adj=</span><span class="si">{</span><span class="n">div</span><span class="p">[</span><span class="s1">&#39;Back Adj.&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> fetch=</span><span class="si">{</span><span class="n">div</span><span class="p">[</span><span class="s1">&#39;FetchDate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S%z&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">]&quot;</span>
                    <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">log_msg</span> <span class="o">+=</span> <span class="s2">&quot; across intervals &quot;</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interday</span><span class="p">:</span>
                        <span class="n">log_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="si">}</span><span class="s2"> (inc)&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">log_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">h_lastRow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]]</span>
                    <span class="n">log_msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;. Last CDF = </span><span class="si">{</span><span class="n">h_lastRow</span><span class="p">[</span><span class="s1">&#39;CDF&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> @ </span><span class="si">{</span><span class="n">h_lastRow</span><span class="p">[</span><span class="s1">&#39;LastDivAdjustDt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S%z&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">LogEvent</span><span class="p">(</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="s2">&quot;PriceManager&quot;</span><span class="p">,</span> <span class="n">log_msg</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;CDF&quot;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">div</span><span class="p">[</span><span class="s2">&quot;Back Adj.&quot;</span><span class="p">]</span>
                    <span class="n">LastDivAdjustDt_new</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">LastDivAdjustDt_new</span><span class="p">[</span><span class="n">f</span><span class="p">],</span> <span class="n">div</span><span class="p">[</span><span class="s2">&quot;FetchDate&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="s2">&quot;LastDivAdjustDt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LastDivAdjustDt_new</span>

            <span class="n">h_modified</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">h_modified</span><span class="p">:</span>
            <span class="n">f1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;CDF&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span>
            <span class="k">if</span> <span class="n">f1</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">f</span><span class="p">,</span><span class="s1">&#39;CDF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_updatedCachedPrices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

        <span class="n">log_msg</span> <span class="o">=</span> <span class="s2">&quot;PM::_applyNewEvents() returning&quot;</span>
        <span class="k">if</span> <span class="n">yfcl</span><span class="o">.</span><span class="n">IsTracingEnabled</span><span class="p">():</span>
            <span class="n">yfcl</span><span class="o">.</span><span class="n">TraceExit</span><span class="p">(</span><span class="n">log_msg</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, ValueRaider@protonmail.com.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>